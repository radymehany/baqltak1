<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ù‚Ø§Ù„ØªÙƒ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ ÙˆØ§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_Maps_API_KEY&libraries=places,geometry"></script>


    <style>
        body { font-family: 'Cairo', sans-serif; }
        .view { display: none; }
        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        .customer-page { display: none; }
        .customer-page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-primary { font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: all 0.3s; cursor: pointer; }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { background-color: #9ca3af !important; cursor: not-allowed; }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }

        /* --- Light Mode --- */
        body.light-mode { background-color: #f1f5f9; color: #1e293b; }
        .light-mode .sidebar { background-color: #ffffff; }
        .light-mode .nav-link.active, .light-mode .bottom-nav-link.active { background-color: #3b82f6; color: white; }
        .light-mode .modal-content { background-color: #ffffff; }
        .light-mode .btn-primary { background-color: #3b82f6; color: white; }
        .light-mode .order-column, .light-mode .portal-bg { background-color: #f9fafb; }
        .light-mode .order-card { background-color: white; }
        .light-mode .customer-view-bg { background-color: #f7fafc; }
        .light-mode .customer-bottom-nav a { color: #6b7280; }
        .light-mode .customer-bottom-nav a.active { color: #ea580c; }


        /* --- Dark Mode --- */
        body.dark-mode { background-color: #0f172a; color: #e2e8f0; }
        body.dark-mode .sidebar { background-color: #1e293b; }
        body.dark-mode .nav-link.active, body.dark-mode .bottom-nav-link.active { background-color: #3b82f6; color: white; }
        body.dark-mode .modal-content { background-color: #1e293b; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background-color: #334155; border-color: #4b5563; }
        body.dark-mode .bg-white { background-color: #1e293b; }
        body.dark-mode .bg-gray-50, body.dark-mode .bg-gray-100, body.dark-mode .bg-gray-200 { background-color: #1f2937; }
        .dark-mode .text-gray-500 { color: #9ca3af; }
        .dark-mode .text-gray-600 { color: #d1d5db; }
        .dark-mode .border, body.dark-mode .border-b, body.dark-mode .border-t { border-color: #374151; }
        .dark-mode .order-column, body.dark-mode .portal-bg { background-color: #1f2937; }
        .dark-mode .order-card { background-color: #374151; }
        .dark-mode .customer-view-bg { background-color: #1a202c; }
        .dark-mode .customer-bottom-nav { background-color: #1e293b; border-top-color: #374151; }
        .dark-mode .customer-bottom-nav a { color: #9ca3af; }
        .dark-mode .customer-bottom-nav a.active { color: #fb923c; }


        .category-filters-container::-webkit-scrollbar { display: none; }
        .category-filters-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- Tracking Steps CSS (FIX) --- */
        .step-item { display: flex; flex-direction: column; align-items: center; position: relative; color: #9ca3af; transition: all 0.5s ease; }
        .step-icon-wrapper { width: 60px; height: 60px; border-radius: 50%; background-color: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s ease; border: 4px solid #f1f5f9; }
        .step-label { font-weight: 600; margin-top: 0.5rem; font-size: 0.875rem; text-align: center; }
        .step-connector { border-style: dashed; transition: border-color 0.3s ease; border-color: #e5e7eb; }
        .step-item.completed .step-icon-wrapper { background-color: #22c55e !important; color: white !important; }
        .step-item.completed .step-label { color: #1e293b !important; }
        .step-item.active .step-icon-wrapper { background-color: #3b82f6 !important; color: white !important; transform: scale(1.1); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3); }
        .step-item.active .step-label { color: #3b82f6 !important; }
        .step-connector.completed { border-style: solid !important; border-color: #22c55e !important; }
        body.dark-mode .step-item.completed .step-label { color: #e2e8f0 !important; }
        body.dark-mode .step-icon-wrapper { border-color: #0f172a; }

        /* Rating Stars */
        .rating .fa-star { color: #e5e7eb; cursor: pointer; transition: color 0.2s; }
        .rating .fa-star.selected, .rating:hover .fa-star:hover, .rating .fa-star:hover ~ .fa-star { color: #f59e0b !important; }

        .invoice-box { max-width: 800px; margin: auto; padding: 30px; border: 1px solid #eee; box-shadow: 0 0 10px rgba(0, 0, 0, 0.15); font-size: 16px; line-height: 24px; color: #555; background: white; }
        .invoice-box table { width: 100%; line-height: inherit; text-align: right; }
        .invoice-box table td { padding: 5px; vertical-align: top; }
        .invoice-box table tr.heading td { background: #eee; border-bottom: 1px solid #ddd; font-weight: bold; }
        
        @keyframes bell-ring { 0% { transform: rotate(0); } 15% { transform: rotate(15deg); } 30% { transform: rotate(-15deg); } 45% { transform: rotate(10deg); } 60% { transform: rotate(-10deg); } 75% { transform: rotate(5deg); } 85% { transform: rotate(-5deg); } 100% { transform: rotate(0); } }
        .notification-bell.active { animation: bell-ring 0.8s ease-in-out; }

        .map-container { height: 250px; width: 100%; border-radius: 0.5rem; background-color: #e5e7eb; }
        .dashboard-map-container { height: 75vh; width: 100%; border-radius: 0.5rem; background-color: #e5e7eb; }


        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="light-mode">
    <div id="root-container">
        <div id="selection-view" class="view flex flex-col items-center justify-center h-screen p-4">
            <div class="p-8 md:p-12 rounded-lg shadow-2xl text-center w-full max-w-md bg-white">
                <img id="logo-selection" src="" alt="Logo" class="max-w-[180px] h-auto mx-auto mb-6">
                <h1 class="text-3xl font-bold mb-6">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨Ù‚Ø§Ù„ØªÙƒ</h1>
                <div class="space-y-4">
                    <button id="customer-btn" class="w-full btn-primary bg-green-600 hover:bg-green-700 text-lg">ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø¹Ù…ÙŠÙ„)</button>
                    <button id="admin-btn" class="w-full btn-primary text-lg">Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ù…Ø¯ÙŠØ±)</button>
                    <button id="driver-btn" class="w-full btn-primary bg-orange-500 hover:bg-orange-600 text-lg">Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
                </div>
            </div>
        </div>
        
        <div id="password-overlay" class="view fixed inset-0 bg-gray-900 bg-opacity-75 flex-col items-center justify-center z-50 p-4"></div>
        
        <div id="app-container" class="view">
            <div class="relative min-h-screen md:flex">
                <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
                <aside id="sidebar" class="sidebar fixed top-0 right-0 h-full w-64 p-4 shadow-2xl flex flex-col z-30 transform translate-x-full transition-transform duration-300 md:relative md:translate-x-0">
                     <div class="text-center mb-4"><img id="logo-sidebar" src="" alt="Logo" class="max-w-[180px] h-auto mx-auto"></div>
                    <div class="mb-4 text-center">
                         <label for="theme-toggle-admin" class="flex items-center justify-center cursor-pointer">
                            <i class="fa-solid fa-moon text-yellow-400"></i>
                            <div class="relative mx-2"><input type="checkbox" id="theme-toggle-admin" class="sr-only"><div class="block bg-gray-600 w-10 h-6 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div></div>
                            <i class="fa-solid fa-sun text-yellow-400"></i>
                        </label>
                    </div>
                    <nav class="flex-grow">
                        <a href="#dashboard" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-tachometer-alt w-8 text-center"></i>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
                        <a href="#analytics" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-chart-pie w-8 text-center"></i>Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</a>
                        <a href="#finance" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-file-invoice-dollar w-8 text-center"></i>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</a>
                        <a href="#orders" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-receipt w-8 text-center"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
                        <a href="#inventory" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-boxes-stacked w-8 text-center"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a>
                        <a href="#promotions" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-tags w-8 text-center"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</a>
                        <a href="#returns" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-undo w-8 text-center"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</a>
                        <a href="#customers" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-users w-8 text-center"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a>
                        <a href="#drivers" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-motorcycle w-8 text-center"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</a>
                        <a href="#settings" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-cog w-8 text-center"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
                    </nav>
                    <div class="mt-auto"><button id="logout-btn" class="w-full bg-red-500 bg-opacity-20 hover:bg-red-500 hover:text-white font-bold py-2 px-4 rounded-lg"><i class="fa-solid fa-right-from-bracket mr-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></div>
                </aside>
                <main id="admin-main" class="flex-1 p-4 md:p-10 overflow-y-auto pb-20 md:pb-10">
                    <header class="p-4 mb-6 flex justify-between items-center md:hidden no-print bg-white rounded-lg shadow-lg">
                        <h2 id="page-title-mobile" class="text-xl font-bold"></h2>
                        <button id="hamburger-btn" class="text-2xl"><i class="fa-solid fa-bars"></i></button>
                    </header>
                    <header class="hidden md:flex shadow-lg rounded-lg p-4 mb-6 justify-between items-center no-print bg-white">
                        <h2 id="page-title" class="text-2xl md:text-3xl font-bold"></h2>
                        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹, <strong id="current-user-name" class="text-blue-500"></strong></p>
                    </header>
                    <div id="page-dashboard" class="page"></div><div id="page-analytics" class="page"></div><div id="page-finance" class="page"></div><div id="page-orders" class="page"></div><div id="page-inventory" class="page"></div><div id="page-promotions" class="page"></div><div id="page-returns" class="page"></div><div id="page-customers" class="page"></div><div id="page-drivers" class="page"></div><div id="page-settings" class="page"></div>
                </main>
                <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-t-lg flex justify-around p-2 border-t z-10">
                    <a href="#dashboard" class="bottom-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center"><i class="fa-solid fa-tachometer-alt text-xl"></i><span class="text-xs mt-1">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
                    <a href="#orders" class="bottom-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center"><i class="fa-solid fa-receipt text-xl"></i><span class="text-xs mt-1">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></a>
                    <a href="#inventory" class="bottom-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center"><i class="fa-solid fa-boxes-stacked text-xl"></i><span class="text-xs mt-1">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></a>
                    <a href="#drivers" class="bottom-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center"><i class="fa-solid fa-motorcycle text-xl"></i><span class="text-xs mt-1">Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</span></a>
                </nav>
            </div>
        </div>
        
        <div id="customer-view" class="view customer-view-bg min-h-screen pb-24"></div>

        <div id="driver-portal-view" class="view portal-bg min-h-screen"></div>

    </div>
    
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-[101] space-y-2"></div>

    <script type="module">
        const DB_NAME = 'Baqaltak_v56_DATA'; // Incremented version
        const STATUS_EVENT_KEY = 'BAQALTAK_STATUS_EVENT';
        const CHAT_EVENT_KEY = 'BAQALTAK_CHAT_EVENT';
        const NEW_ORDER_EVENT_KEY = 'BAQALTAK_NEW_ORDER_EVENT';
        let db = {};
        const logoUrl = "https://d.top4top.io/p_3489e11m01.png";
        let currentUser = null; // Can be 'admin' or 'driver'
        let cart = {};
        let driverIntervals = {}; // To store simulation intervals for maps
        let driverTimers = {}; // To store rejection timers for drivers
        let mapInstances = {}; // To store initialized map objects

        // ----------------- GEMINI API FUNCTION -----------------
        async function callGemini(prompt, buttonElement) {
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...`;
            }
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected response structure:", result);
                    return "Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¯. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.";
            } finally {
                if (buttonElement) { buttonElement.disabled = false; }
            }
        }

        // ----------------- DATABASE FUNCTIONS -----------------
        function loadDB() {
            const data = localStorage.getItem(DB_NAME);
            const cartData = localStorage.getItem(DB_NAME + '_Cart');
            const defaultDB = {
                products: [
                    // ÙÙˆØ§ÙƒÙ‡
                    { id: 1, name: 'ØªÙØ§Ø­ Ø£Ø­Ù…Ø± (ÙƒÙŠÙ„Ùˆ)', description: 'ØªÙØ§Ø­ Ø£Ø­Ù…Ø± Ø·Ø§Ø²Ø¬ ÙˆÙ…Ù‚Ø±Ù…Ø´.', sku: 'FR001', category: 'ÙÙˆØ§ÙƒÙ‡', price: 0.750, stock: 50, lowStockThreshold: 10, isFeatured: true, iconClass: 'fa-solid fa-apple-whole' },
                    { id: 2, name: 'Ù…ÙˆØ² (ÙƒÙŠÙ„Ùˆ)', description: 'Ù…ÙˆØ² Ø·Ø§Ø²Ø¬ ØºÙ†ÙŠ Ø¨Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ….', sku: 'FR002', category: 'ÙÙˆØ§ÙƒÙ‡', price: 0.600, stock: 80, lowStockThreshold: 15, isFeatured: true, iconClass: 'fa-solid fa-bacon' }, // Note: No perfect banana icon
                    { id: 3, name: 'Ø¨Ø±ØªÙ‚Ø§Ù„ (ÙƒÙŠÙ„Ùˆ)', description: 'Ø¨Ø±ØªÙ‚Ø§Ù„ Ø¹ØµÙŠØ±ÙŠ ØºÙ†ÙŠ Ø¨ÙÙŠØªØ§Ù…ÙŠÙ† Ø³ÙŠ.', sku: 'FR003', category: 'ÙÙˆØ§ÙƒÙ‡', price: 0.500, stock: 60, lowStockThreshold: 10, isFeatured: false, iconClass: 'fa-solid fa-lemon' },
                    // Ø®Ø¶Ø±ÙˆØ§Øª
                    { id: 4, name: 'Ø·Ù…Ø§Ø·Ù… (ÙƒÙŠÙ„Ùˆ)', description: 'Ø·Ù…Ø§Ø·Ù… Ø­Ù…Ø±Ø§Ø¡ Ø·Ø§Ø²Ø¬Ø© Ù„Ù„Ø³Ù„Ø·Ø§Øª ÙˆØ§Ù„Ø·Ø¨Ø®.', sku: 'VE001', category: 'Ø®Ø¶Ø±ÙˆØ§Øª', price: 0.400, stock: 100, lowStockThreshold: 20, isFeatured: true, iconClass: 'fa-solid fa-carrot' },
                    { id: 5, name: 'Ø®ÙŠØ§Ø± (ÙƒÙŠÙ„Ùˆ)', description: 'Ø®ÙŠØ§Ø± Ø·Ø§Ø²Ø¬ ÙˆÙ…Ù‚Ø±Ù…Ø´.', sku: 'VE002', category: 'Ø®Ø¶Ø±ÙˆØ§Øª', price: 0.350, stock: 120, lowStockThreshold: 25, isFeatured: false, iconClass: 'fa-solid fa-seedling' },
                    { id: 6, name: 'Ø¨Ø·Ø§Ø·Ø³ (ÙƒÙŠØ³)', description: 'ÙƒÙŠØ³ Ø¨Ø·Ø§Ø·Ø³ Ù„Ù„Ù‚Ù„ÙŠ Ø£Ùˆ Ø§Ù„Ø·Ø¨Ø®.', sku: 'VE003', category: 'Ø®Ø¶Ø±ÙˆØ§Øª', price: 0.800, stock: 70, lowStockThreshold: 15, isFeatured: false, iconClass: 'fa-solid fa-pepper-hot' },
                ],
                customers: [{id: 1, name: 'Ø®Ø§Ù„Ø¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ', phone: '96567734409', address: 'Ø§Ù„Ù…Ù‡Ø¨ÙˆÙ„Ø© Ù‚Ø·Ø¹Ø© 2', points: 150, notes: 'ÙŠÙØ¶Ù„ Ø§Ù„Ø¯ÙØ¹ ÙƒØ§Ø´', location: { lat: 29.1475, lng: 48.1325 } }], 
                orders: [
                    {id: 1, trackingToken: 'ORDER_1_abcdef', customerId: 1, customerName: "Ø®Ø§Ù„Ø¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ", customerAddress: "Ø§Ù„Ù…Ù‡Ø¨ÙˆÙ„Ø© Ù‚Ø·Ø¹Ø© 2", customerPhone: "96567734409", timestamp: new Date(Date.now() - 2 * 86400000).toISOString(), status: 'delivered', items: [{productId: 1, name: 'ØªÙØ§Ø­ Ø£Ø­Ù…Ø± (ÙƒÙŠÙ„Ùˆ)', quantity: 2, price: 0.750}], total: 2.000, driverId: 1, rating: { driver: 5, comment: 'ØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹' }, paymentMethod: 'cash', location: { lat: 29.1475, lng: 48.1325 } },
                    {id: 2, trackingToken: 'ORDER_2_ghijk', customerId: 1, customerName: "Ø®Ø§Ù„Ø¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ", customerAddress: "Ø§Ù„Ù…Ù‡Ø¨ÙˆÙ„Ø© Ù‚Ø·Ø¹Ø© 2", customerPhone: "96567734409", timestamp: new Date().toISOString(), status: 'out_for_delivery', items: [{productId: 2, name: 'Ù…ÙˆØ² (ÙƒÙŠÙ„Ùˆ)', quantity: 4, price: 0.600}], total: 2.900, driverId: 1, paymentMethod: 'online', location: { lat: 29.1475, lng: 48.1325 } },
                ],
                promotions: [{id: 1, name: 'Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ·Ù†ÙŠ', productIds: [1], discount: 0.1}],
                expenses: [{id: 1, date: new Date().toISOString().slice(0,10), description: 'Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…Ø­Ù„', amount: 250.000, category: 'Ù…ØµØ§Ø±ÙŠÙ Ø«Ø§Ø¨ØªØ©'}],
                users: [{ id: 1, username: 'admin', password: '123', name: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…' }],
                drivers: [{ id: 1, name: 'Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', phone: '96511112222', pin: '1234', location: { lat: 29.3758, lng: 47.9832 } }],
                returns: [],
                chats: {},
                settings: { 
                    storeName: 'Ø¨Ù‚Ø§Ù„ØªÙƒ', 
                    whatsappNumber: '96567734409', 
                    pointsPerKWD: 100, 
                    shippingFee: 0.500,
                    storeLocation: { lat: 29.2834, lng: 48.0826 } // Sample store location in Fahaheel
                },
                counters: { product: 6, customer: 1, order: 2, user: 1, promotion: 1, expense: 1, driver: 1, return: 0 }
            };
            if (data) { try { db = JSON.parse(data); } catch (e) { db = defaultDB; } } else { db = defaultDB; }
            if (!db.drivers) db.drivers = [];
            if (!db.returns) db.returns = [];
            if (!db.chats) db.chats = {};
            if (!db.settings.storeLocation) db.settings.storeLocation = { lat: 29.2834, lng: 48.0826 };
            if (!db.counters.driver) db.counters.driver = (db.drivers.length > 0) ? Math.max(...db.drivers.map(d => d.id)) : 0;
            if (!db.counters.return) db.counters.return = 0;
            if (cartData) { try { cart = JSON.parse(cartData); } catch (e) { cart = {}; } } else { cart = {}; }
        }
        function saveDB() { localStorage.setItem(DB_NAME, JSON.stringify(db)); }
        function saveCart() { localStorage.setItem(DB_NAME + '_Cart', JSON.stringify(cart)); }
        function getDB() { return db; }
        
        // Inventory logic to account for reserved stock in pending orders
        function getReservedStock(productId) {
            return db.orders
                .filter(o => o.status === 'pending' || o.status === 'awaiting_driver_confirmation')
                .flatMap(o => o.items)
                .filter(item => item.productId === productId)
                .reduce((sum, item) => sum + item.quantity, 0);
        }

        function getAvailableStock(productId) {
            const product = db.products.find(p => p.id === productId);
            if (!product) return 0;
            const reserved = getReservedStock(productId);
            return product.stock - reserved;
        }
        
        // ----------------- UTILITY & AUTH FUNCTIONS -----------------
        function login(username, password) { const user = getDB().users.find(u => u.username === username && u.password === password); if (user) { currentUser = { ...user, type: 'admin' }; sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); return true; } return false; }
        function driverLogin(phone, pin) { const driver = getDB().drivers.find(d => d.phone === phone && d.pin === pin); if (driver) { currentUser = { ...driver, type: 'driver' }; sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); return true; } return false; }
        function logout() { Object.values(driverIntervals).forEach(clearInterval); driverIntervals = {}; Object.values(driverTimers).forEach(clearTimeout); driverTimers = {}; currentUser = null; sessionStorage.removeItem('currentUser'); window.location.hash = ''; window.location.reload(); }
        function showToast(message, type = 'success') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `p-4 rounded-lg shadow-lg text-white font-bold ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`; t.textContent = message; c.prepend(t); setTimeout(() => t.remove(), 4000); }
        function openModal(title, content, modalClasses = 'max-w-2xl') { const mC = document.getElementById('modal-container'); mC.innerHTML = `<div class="modal fixed inset-0 bg-black bg-opacity-50" style="display:flex; align-items:center; justify-content:center; z-index: 100;"><div class="modal-content ${modalClasses} w-full m-4 p-6 rounded-lg shadow-xl max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-4 border-b pb-2 no-print"><h2 class="text-2xl font-bold">${title}</h2><button class="close-modal-btn text-3xl">Ã—</button></div><div>${content}</div></div></div>`; mC.querySelector('.close-modal-btn').addEventListener('click', () => mC.innerHTML = ''); }
        function closeModal() { document.getElementById('modal-container').innerHTML = ''; }
        function renderPage(pageId, htmlContent, listeners) { const page = document.getElementById(pageId); if (page) { page.innerHTML = htmlContent; if(listeners) listeners(); } }
        function timeAgo(date) { const seconds = Math.floor((new Date() - new Date(date)) / 1000); let interval = seconds / 31536000; if (interval > 1) return `Ù…Ù†Ø° ${Math.floor(interval)} Ø³Ù†Ø©`; interval = seconds / 2592000; if (interval > 1) return `Ù…Ù†Ø° ${Math.floor(interval)} Ø´Ù‡Ø±`; interval = seconds / 86400; if (interval > 1) return `Ù…Ù†Ø° ${Math.floor(interval)} ÙŠÙˆÙ…`; interval = seconds / 3600; if (interval > 1) return `Ù…Ù†Ø° ${Math.floor(interval)} Ø³Ø§Ø¹Ø©`; interval = seconds / 60; if (interval > 1) return `Ù…Ù†Ø° ${Math.floor(interval)} Ø¯Ù‚ÙŠÙ‚Ø©`; return `Ù…Ù†Ø° ${Math.floor(seconds)} Ø«Ø§Ù†ÙŠØ©`; }
        
        // ----------------- SOUND NOTIFICATION FUNCTIONS -----------------
        function playSound(note, duration) {
            try {
                const synth = new Tone.Synth().toDestination();
                Tone.start();
                synth.triggerAttackRelease(note, duration);
            } catch (e) {
                console.error("Could not play sound:", e);
            }
        }
        const playNewOrderSound = () => playSound("C5", "8n");
        const playStatusUpdateSound = () => playSound("E5", "8n");
        const playDriverNotificationSound = () => playSound("G5", "8n");

        // ----------------- LOGIN / SELECTION VIEWS -----------------
        function renderLoginOverlay(type) {
            const overlay = document.getElementById('password-overlay');
            const title = type === 'admin' ? 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±' : 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚';
            const formId = type === 'admin' ? 'login-form' : 'driver-login-form';
            const userLabel = type === 'admin' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' : 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ';
            const passLabel = type === 'admin' ? 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' : 'Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)';
            const userInputType = type === 'admin' ? 'text' : 'tel';
            const passInputType = 'password';

            overlay.innerHTML = `
                <div class="bg-slate-800 p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
                    <img src="${logoUrl}" alt="Logo" class="max-w-[180px] h-auto mx-auto mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-white">${title}</h2>
                    <form id="${formId}" class="space-y-4">
                        <input type="${userInputType}" name="username" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg text-center text-white" placeholder="${userLabel}" required>
                        <input type="${passInputType}" name="password" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg text-center text-white" placeholder="${passLabel}" required>
                        <p class="password-error text-red-400 text-sm pt-1 hidden">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.</p>
                        <button type="submit" class="w-full btn-primary py-3 mt-4">Ø¯Ø®ÙˆÙ„</button>
                        <button type="button" class="back-to-selection-btn w-full mt-2 text-gray-400 hover:text-white">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                    </form>
                </div>`;
            
            overlay.querySelector('.back-to-selection-btn').addEventListener('click', () => {
                overlay.style.display = 'none';
                document.getElementById('selection-view').style.display = 'flex';
            });

            overlay.querySelector(`#${formId}`).addEventListener('submit', (e) => {
                e.preventDefault();
                const user = e.target.username.value;
                const pass = e.target.password.value;
                let success = false;

                if (type === 'admin') {
                    if (login(user, pass)) {
                        success = true;
                        window.location.hash = '#dashboard';
                    }
                } else if (type === 'driver') {
                    if (driverLogin(user, pass)) {
                        success = true;
                        window.location.hash = `#driver_portal`;
                    }
                }
                
                if (success) {
                    overlay.style.display = 'none';
                    handleHashChange();
                } else {
                    overlay.querySelector('.password-error').classList.remove('hidden');
                }
            });
            overlay.style.display = 'flex';
        }

        // ----------------- CUSTOMER VIEW FUNCTIONS (NEW MOBILE UI) -----------------
        function renderPublicView() {
            window.removeEventListener('storage', globalStorageListener);
            const hash = window.location.hash.substring(1);
            if (hash.startsWith('track=')) {
                renderOrderTrackingPage(hash.substring(6));
            } else {
                renderStoreAppShell();
                handleCustomerNav('home'); 
            }
        }
        
        function globalStorageListener(event) {
            // --- Customer View Listeners ---
            if (currentUser === null) { 
                if (event.key === STATUS_EVENT_KEY) {
                    const currentToken = window.location.hash.substring(1).substring(6);
                    const updateInfo = JSON.parse(event.newValue);
                    if (currentToken === updateInfo.token) {
                        playStatusUpdateSound();
                        showToast('ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ...', 'success');
                        renderOrderTrackingPage(updateInfo.token);
                    }
                } 
                else if (event.key === CHAT_EVENT_KEY) {
                    const chatModal = document.getElementById('chat-modal-content');
                    if (chatModal) {
                        const { orderId, sender } = JSON.parse(event.newValue);
                        if (chatModal.dataset.orderId == orderId && sender !== 'customer') {
                            renderChatMessages(orderId, 'customer');
                        }
                    }
                }
            }

            // --- Admin View Listeners ---
            if (currentUser?.type === 'admin') {
                if (event.key === DB_NAME) {
                    showToast('ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'success');
                    loadDB();
                    
                    const currentHash = window.location.hash.substring(1) || 'dashboard';
                    if (currentHash === 'dashboard') {
                        renderDashboard();
                    } else if (currentHash === 'orders') {
                        displayOrders();
                    } else if (currentHash === 'inventory') {
                        displayInventory();
                    }
                }
                else if (event.key === NEW_ORDER_EVENT_KEY) {
                    playNewOrderSound();
                    showToast('ğŸ‰ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!', 'success');
                }
            }
            
            // --- Driver View Listeners ---
            if (currentUser?.type === 'driver') {
                if (event.key === CHAT_EVENT_KEY) {
                    const chatModal = document.getElementById('chat-modal-content');
                    if (chatModal) {
                        const { orderId, sender } = JSON.parse(event.newValue);
                        if (chatModal.dataset.orderId == orderId && sender !== 'driver') {
                            renderChatMessages(orderId, 'driver');
                        }
                    }
                }
                else if (event.key === DB_NAME) {
                    handleDriverStorageEvent(event);
                }
            }
        }


        function renderStoreAppShell() {
            const customerView = document.getElementById('customer-view');
            customerView.innerHTML = `
                <div id="customer-main-content">
                    <div id="customer-page-home" class="customer-page"></div>
                    <div id="customer-page-categories" class="customer-page"></div>
                    <div id="customer-page-track" class="customer-page"></div>
                </div>

                <button id="cart-fab" class="fixed bottom-20 right-4 bg-orange-500 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-2xl z-40 transition-transform hover:scale-110">
                    <i class="fa-solid fa-shopping-cart"></i>
                    <span id="cart-fab-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white">0</span>
                </button>

                <nav class="customer-bottom-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg flex justify-around p-2 border-t z-50">
                    <a href="#home" class="customer-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center transition-colors">
                        <i class="fa-solid fa-store text-xl"></i><span class="text-xs mt-1">Ø§Ù„Ù…ØªØ¬Ø±</span>
                    </a>
                    <a href="#categories" class="customer-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center transition-colors">
                        <i class="fa-solid fa-grip text-xl"></i><span class="text-xs mt-1">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                    </a>
                    <a href="#track" class="customer-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center transition-colors">
                        <i class="fa-solid fa-truck-fast text-xl"></i><span class="text-xs mt-1">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ</span>
                    </a>
                </nav>
            `;

            document.querySelectorAll('.customer-nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const targetPage = e.currentTarget.hash.substring(1);
                    handleCustomerNav(targetPage);
                });
            });

            document.getElementById('cart-fab').addEventListener('click', renderCheckoutModal);
            updateCartButton();
        }

        function handleCustomerNav(pageName) {
            document.querySelectorAll('.customer-page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.customer-nav-link').forEach(l => l.classList.remove('active'));
            
            const activePage = document.getElementById(`customer-page-${pageName}`);
            const activeLink = document.querySelector(`.customer-nav-link[href="#${pageName}"]`);

            if (activePage) activePage.classList.add('active');
            if (activeLink) activeLink.classList.add('active');

            switch(pageName) {
                case 'home':
                    renderStoreHomePage();
                    break;
                case 'categories':
                    renderCategoriesPage();
                    break;
                case 'track':
                    renderTrackOrderInputPage();
                    break;
            }
        }
        
        function renderStoreHomePage() {
            const container = document.getElementById('customer-page-home');
            const featuredProducts = db.products.filter(p => p.isFeatured && getAvailableStock(p.id) > 0);
            container.innerHTML = `
                 <header class="bg-white sticky top-0 z-30 p-4">
                    <div class="flex items-center justify-between">
                        <img id="logo-public" src="${logoUrl}" alt="Logo" class="h-10">
                        <div class="relative flex-grow mx-4">
                            <input id="public-product-search" class="w-full p-2 pr-10 border rounded-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ù…Ø§ ØªØ±ÙŠØ¯...">
                             <button id="gemini-search-btn" class="absolute inset-y-0 right-0 flex items-center justify-center px-3 text-orange-500 hover:text-orange-600">
                                âœ¨
                            </button>
                        </div>
                    </div>
                </header>
                <main class="p-4">
                    ${featuredProducts.length > 0 ? `<div class="mb-8"><h2 class="text-2xl font-bold mb-4">Ù…Ù†ØªØ¬Ø§Øª Ù…Ù…ÙŠØ²Ø©</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 featured-products-grid">${featuredProducts.map(p => createProductCard(p)).join('')}</div></div><hr class="my-6 border-gray-300">` : ''}
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2><select id="public-product-sort" class="p-2 border rounded-lg bg-white"><option value="default">ÙØ±Ø² Ø­Ø³Ø¨</option><option value="price-asc">Ø§Ù„Ø³Ø¹Ø±: Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰</option><option value="price-desc">Ø§Ù„Ø³Ø¹Ø±: Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ù‚Ù„</option><option value="name-asc">Ø§Ù„Ø§Ø³Ù…: Ø£ - ÙŠ</option></select></div>
                    <div id="public-products-list" class="flex flex-col gap-4"></div>
                </main>
            `;
            document.getElementById('public-product-search').addEventListener('input', () => displayPublicProducts());
            document.getElementById('public-product-sort').addEventListener('change', () => displayPublicProducts());
             document.getElementById('gemini-search-btn').addEventListener('click', handleGeminiSearch);
            container.addEventListener('click', (event) => {
                const button = event.target.closest('.update-cart-btn');
                if (button) {
                    updateCart(Number(button.dataset.id), Number(button.dataset.change));
                }
            });
            displayPublicProducts();
        }

        async function handleGeminiSearch(event) {
            const button = event.currentTarget;
            const searchInput = document.getElementById('public-product-search');
            const query = searchInput.value.trim();

            if (!query) {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹.", "error");
                return;
            }

            const originalButtonContent = button.innerHTML;
            button.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
            button.disabled = true;

            const allProductNames = db.products.map(p => p.name).join(', ');
            const prompt = `User wants to find grocery items based on this query: "${query}". From the following list of available products, which ones are relevant? Available products: [${allProductNames}]. Please return only a comma-separated list of the relevant product names. For example: "ØªÙØ§Ø­ Ø£Ø­Ù…Ø± (ÙƒÙŠÙ„Ùˆ),Ù…ÙˆØ² (ÙƒÙŠÙ„Ùˆ),Ø­Ù„ÙŠØ¨ Ø§Ù„Ù…Ø±Ø§Ø¹ÙŠ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¯Ø³Ù… (1 Ù„ØªØ±)"`;

            try {
                const response = await callGemini(prompt);
                const productNames = response.split(',').map(name => name.trim().toLowerCase());
                displayPublicProducts(null, productNames);
            } catch (error) {
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ.", "error");
                displayPublicProducts(); // Show all products on error
            } finally {
                button.innerHTML = originalButtonContent;
                button.disabled = false;
            }
        }

        function renderCategoriesPage() {
            const container = document.getElementById('customer-page-categories');
            const categories = [...new Set(db.products.map(p => p.category))];
            const categoryIcons = {
                'ÙÙˆØ§ÙƒÙ‡': 'fa-apple-whole', 'Ø®Ø¶Ø±ÙˆØ§Øª': 'fa-carrot', 'Ù…Ø®Ø¨ÙˆØ²Ø§Øª': 'fa-bread-slice', 'Ø£Ù„Ø¨Ø§Ù† ÙˆØ¨ÙŠØ¶': 'fa-egg', 'Ù„Ø­ÙˆÙ… ÙˆØ¯ÙˆØ§Ø¬Ù†': 'fa-drumstick-bite',
                'Ù…Ø´Ø±ÙˆØ¨Ø§Øª': 'fa-bottle-water', 'Ù…Ø¹Ù„Ø¨Ø§Øª': 'fa-jar', 'Ø­Ø¨ÙˆØ¨ ÙˆÙ…Ø¹ÙƒØ±ÙˆÙ†Ø©': 'fa-bowl-rice', 'ÙˆØ¬Ø¨Ø§Øª Ø®ÙÙŠÙØ©': 'fa-cookie', 'Ø­Ù„ÙˆÙŠØ§Øª': 'fa-candy-cane',
                'Ù…Ø¬Ù…Ø¯Ø§Øª': 'fa-ice-cream', 'Ø¨Ù‡Ø§Ø±Ø§Øª ÙˆØªÙˆØ§Ø¨Ù„': 'fa-mortar-pestle', 'Ø²ÙŠÙˆØª ÙˆØµÙ„ØµØ§Øª': 'fa-bottle-droplet', 'Ù…Ù†Ø¸ÙØ§Øª': 'fa-soap', 'Ø¹Ù†Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©': 'fa-tooth',
                'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø£Ø·ÙØ§Ù„': 'fa-baby', 'Ø£Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠØ©': 'fa-box'
            };
            container.innerHTML = `
                 <header class="bg-white sticky top-0 z-30 p-4 shadow-sm">
                     <h1 class="text-2xl font-bold text-center">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h1>
                </header>
                <main class="p-4">
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                        ${categories.map(c => `
                            <a href="#" class="category-grid-item flex flex-col items-center p-4 bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow" data-category="${c}">
                                <i class="fa-solid ${categoryIcons[c] || 'fa-tag'} text-4xl text-orange-500 mb-3"></i>
                                <span class="font-semibold text-center text-sm">${c}</span>
                            </a>
                        `).join('')}
                    </div>
                </main>
            `;

            document.querySelectorAll('.category-grid-item').forEach(item => {
                item.addEventListener('click', e => {
                    e.preventDefault();
                    const category = e.currentTarget.dataset.category;
                    handleCustomerNav('home');
                    // We need a slight delay to ensure the home page is rendered before we filter
                    setTimeout(() => {
                        const searchInput = document.getElementById('public-product-search');
                        if(searchInput) searchInput.value = ''; // Clear previous search
                        displayPublicProducts(category);
                    }, 50);
                });
            });
        }
        
        function renderTrackOrderInputPage() {
            const container = document.getElementById('customer-page-track');
            container.innerHTML = `
                 <header class="bg-white sticky top-0 z-30 p-4 shadow-sm">
                     <h1 class="text-2xl font-bold text-center">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ</h1>
                </header>
                <main class="p-4 pt-10">
                    <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg text-center">
                        <i class="fa-solid fa-magnifying-glass-location text-5xl text-orange-500 mb-4"></i>
                        <h2 class="text-xl font-semibold mb-4">Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ø·Ù„Ø¨Ùƒ</h2>
                        <form id="track-order-form">
                             <input type="text" id="tracking-url-input" class="w-full p-3 border rounded-lg mb-4 text-center" placeholder="https://...#track=ORDER_...">
                             <button type="submit" class="w-full btn-primary bg-orange-500 hover:bg-orange-600">ØªØªØ¨Ø¹</button>
                        </form>
                        <p class="text-xs text-gray-400 mt-4">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙŠØ¬Ø§Ø¯ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„ØªÙŠ ÙˆØµÙ„ØªÙƒ Ø¨Ø¹Ø¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨.</p>
                    </div>
                </main>
            `;
            document.getElementById('track-order-form').addEventListener('submit', e => {
                e.preventDefault();
                const url = document.getElementById('tracking-url-input').value;
                try {
                    const token = new URL(url).hash.substring(1).split('=')[1];
                    if (token) {
                        window.location.hash = `track=${token}`;
                    } else {
                         showToast('Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
                    }
                } catch(err) {
                     showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­', 'error');
                }
            });
        }
        
        function renderCheckoutModal() {
            let subtotal = 0;
            const cartItems = Object.entries(cart).map(([id, qty]) => {
                const p = db.products.find(prod => prod.id == id);
                if (!p) return null;
                const finalPrice = getProductPrice(p);
                subtotal += finalPrice * qty;
                return { product: p, quantity: qty, finalPrice: finalPrice };
            }).filter(Boolean);

            const shippingFee = db.settings.shippingFee || 0;
            const total = subtotal + shippingFee;

            const cartItemsHtml = cartItems.length > 0
                ? cartItems.map(item => `<div class="flex items-center gap-4 py-3"><div class="flex-shrink-0 w-16 h-16 bg-gray-100 rounded-md flex items-center justify-center"><i class="${item.product.iconClass || 'fa-solid fa-box'} text-3xl text-gray-400"></i></div><div class="flex-grow"><p class="text-sm font-semibold">${item.product.name}</p><p class="text-xs text-gray-500">${item.quantity} x ${item.finalPrice.toFixed(3)}</p></div><div class="font-bold text-sm">${(item.finalPrice * item.quantity).toFixed(3)}</div></div>`).join('')
                : `<div class="text-center py-10"><i class="fa-solid fa-cart-arrow-down text-4xl text-gray-300"></i><p class="mt-4 text-gray-500">Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©!</p></div>`;
            
            const geminiButtonHtml = cartItems.length > 0 ? `<button type="button" id="gemini-recipe-btn" class="w-full btn-primary bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 py-2 mt-4 text-md">âœ¨ Ø§Ù‚ØªØ±Ø­ ÙˆØµÙØ© Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª!</button>` : '';
            
            const content = `
                <form id="customer-order-form">
                    <div id="cart-items-container-sidebar" class="max-h-60 overflow-y-auto divide-y">${cartItemsHtml}</div>
                    ${geminiButtonHtml}
                    <div class="border-t pt-4 mt-4 space-y-2">
                            <div class="flex justify-between text-gray-600"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span><span>${subtotal.toFixed(3)} Ø¯.Ùƒ</span></div>
                            <div class="flex justify-between text-gray-600"><span>ÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${shippingFee.toFixed(3)} Ø¯.Ùƒ</span></div>
                            <div class="flex justify-between font-bold text-lg mt-2 border-t pt-2"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span><span>${total.toFixed(3)} Ø¯.Ùƒ</span></div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-4 border-b pb-3">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
                            <input type="text" name="customerName" class="w-full p-3 border rounded-lg mb-3" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
                            <input type="tel" name="customerPhone" class="w-full p-3 border rounded-lg mb-3" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù„Ø§ÙƒØªØ³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·)" required>
                            <input type="text" name="customerAddress" class="w-full p-3 border rounded-lg mb-3" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" required>
                            <button type="button" id="get-location-btn" class="w-full text-center btn-primary bg-gray-600 hover:bg-gray-700 btn-sm mb-2"><i class="fa-solid fa-location-crosshairs mr-2"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                            <p id="location-status" class="text-xs text-center text-gray-500 mb-3">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ù„ØªØ³Ù‡ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙˆØµÙŠÙ„.</p>
                            <input type="hidden" name="customerLat">
                            <input type="hidden" name="customerLng">
                    </div>
                    <div class="mt-6">
                        <h3 class="text-lg font-bold mb-2">Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
                        <div class="p-4 border rounded-lg flex justify-between items-center bg-gray-50">
                            <span class="font-semibold">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø£Ùˆ ÙƒÙŠ Ù†Øª</span>
                            <img src="https://www.knet.com.kw/images/knet_logo.png" alt="KNET" class="h-6">
                        </div>
                    </div>
                    <button type="submit" class="w-full btn-primary bg-orange-500 hover:bg-orange-600 py-3 mt-6 text-lg">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
                </form>`;

            openModal('Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', content, 'max-w-lg');
            document.getElementById('customer-order-form').addEventListener('submit', handlePublicOrderSubmit);
            document.querySelector('input[name="customerPhone"]').addEventListener('blur', autoFillCustomerData);
            document.getElementById('get-location-btn').addEventListener('click', handleGetLocation);
            const recipeBtn = document.getElementById('gemini-recipe-btn');
            if (recipeBtn) {
                recipeBtn.addEventListener('click', handleRecipeSuggestion);
            }
        }

        function handleGetLocation(e) {
            const button = e.target.closest('button');
            const statusEl = document.getElementById('location-status');
            const latInput = document.querySelector('input[name="customerLat"]');
            const lngInput = document.querySelector('input[name="customerLng"]');

            if (!navigator.geolocation) {
                statusEl.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.';
                statusEl.classList.add('text-red-500');
                return;
            }

            button.disabled = true;
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...';
            statusEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ.';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    latInput.value = latitude;
                    lngInput.value = longitude;
                    statusEl.textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!';
                    statusEl.classList.remove('text-red-500');
                    statusEl.classList.add('text-green-600');
                    button.innerHTML = '<i class="fa-solid fa-check mr-2"></i> ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯';
                },
                (error) => {
                    statusEl.textContent = 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                    statusEl.classList.add('text-red-500');
                    button.disabled = false;
                    button.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ';
                    console.error("Geolocation error:", error);
                }
            );
        }

        async function handleRecipeSuggestion(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            const productNames = Object.keys(cart).map(id => db.products.find(p => p.id == id)?.name).filter(Boolean).join(', ');
            
            if (!productNames) {
                showToast("Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©!", 'error');
                return;
            }

            const prompt = `Ø£Ù†Ø§ Ø£ØªØ³ÙˆÙ‚ Ù…Ù† Ø¨Ù‚Ø§Ù„Ø© ÙˆÙ‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø³Ù„ØªÙŠ: ${productNames}. Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙ‘ ÙˆØµÙØ© Ø·Ø¹Ø§Ù… Ø¨Ø³ÙŠØ·Ø© ÙˆØ³Ø±ÙŠØ¹Ø© ÙŠÙ…ÙƒÙ†Ù†ÙŠ ØªØ­Ø¶ÙŠØ±Ù‡Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¹Ø¶ Ø£Ùˆ ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª. Ù‚Ø¯Ù… Ø§Ù„ÙˆØµÙØ© Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø¨ØªÙ†Ø³ÙŠÙ‚ Markdown.`;
            
            const response = await callGemini(prompt, button);
            const formattedHtml = marked.parse(response);

            openModal("âœ¨ Ø§Ù‚ØªØ±Ø§Ø­ ÙˆØµÙØ© Ù„Ùƒ", `<div class="prose max-w-none">${formattedHtml}</div>`);
            button.innerHTML = originalText;
        }

        function autoFillCustomerData(e) {
            const phone = e.target.value;
            const customer = db.customers.find(c => c.phone === phone);
            if(customer && customer.address) {
                const form = e.target.form;
                form.customerName.value = customer.name;
                form.customerAddress.value = customer.address;
                showToast(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ ${customer.name}!`, 'success');
            }
        }
        
        function renderOrderTrackingPage(token) {
            window.addEventListener('storage', globalStorageListener);
            document.getElementById('selection-view').style.display = 'none';
            document.getElementById('driver-portal-view').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
            const customerView = document.getElementById('customer-view');
            customerView.style.display = 'block';

            loadDB();
            const order = db.orders.find(o => o.trackingToken === token);
            
            if (!order) { 
                customerView.innerHTML = `<main class="text-center p-10"><h1 class="text-2xl font-bold">Ø±Ø§Ø¨Ø· ØªØªØ¨Ø¹ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ.</h1><a href="#" id="back-to-store" class="text-blue-500 hover:underline mt-4 block">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a></main>`; 
                document.getElementById('back-to-store').addEventListener('click', (e) => { e.preventDefault(); window.location.hash = ''; renderPublicView(); }); 
                return; 
            }
            
            const driver = order.driverId ? db.drivers.find(d => d.id === order.driverId) : null;
            const ratingUI = order.status === 'delivered' && !order.rating ? `
                <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">ÙƒÙŠÙ ÙƒØ§Ù†Øª ØªØ¬Ø±Ø¨ØªÙƒØŸ</h3>
                    <div class="mb-2">
                        <label class="block text-sm font-medium mb-1">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
                        <div class="rating driver-rating flex flex-row-reverse justify-center text-3xl">
                            ${[5,4,3,2,1].map(s => `<i class="far fa-star" data-value="${s}"></i>`).join('')}
                        </div>
                    </div>
                    <textarea id="rating-comment" class="w-full p-2 border rounded" placeholder="Ø§ØªØ±Ùƒ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
                    <button id="submit-rating-btn" class="btn-primary w-full mt-2">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
                </div>` : (order.rating ? `<div class="mt-4 text-center text-gray-500">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ!</div>` : '');

            const statuses = ['pending', 'in_progress', 'awaiting_driver_confirmation', 'out_for_delivery', 'delivered'];
            const statusTexts = { 
                pending: 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…', 
                in_progress: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²', 
                awaiting_driver_confirmation: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚',
                out_for_delivery: 'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ', 
                delivered: 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„', 
                cancelled: 'Ù…Ù„ØºÙŠ' 
            };
            const statusIcons = { 
                pending: 'fa-receipt', 
                in_progress: 'fa-box-open', 
                awaiting_driver_confirmation: 'fa-motorcycle',
                out_for_delivery: 'fa-truck-fast', 
                delivered: 'fa-house-circle-check', 
                cancelled: 'fa-ban' 
            };
            const currentStatusIndex = statuses.indexOf(order.status);
            
            let stepsHtml = '';
            const customerVisibleStatuses = statuses.filter(s => s !== 'awaiting_driver_confirmation');
            customerVisibleStatuses.forEach((status, i) => {
                const stepOrder = statuses.indexOf(status);
                const isCompleted = stepOrder < currentStatusIndex;
                const isActive = stepOrder === currentStatusIndex || (status === 'out_for_delivery' && order.status === 'awaiting_driver_confirmation');
                stepsHtml += `<div class="step-item flex-1 ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}"><div class="step-icon-wrapper"><i class="fa-solid ${statusIcons[status]}"></i></div><p class="step-label">${statusTexts[status]}</p></div>`;
                if (i < customerVisibleStatuses.length - 1) { stepsHtml += `<div class="flex-auto border-t-2 step-connector ${isCompleted ? 'completed' : ''}"></div>`; }
            });

            let deliveryInfoHtml = '';
            if ((order.status === 'out_for_delivery' || order.status === 'awaiting_driver_confirmation') && driver) {
                deliveryInfoHtml = `
                <div class="mt-4 flex items-center justify-center gap-4 bg-green-50 p-3 rounded-lg">
                    <p class="text-gray-600">Ø§Ù„Ø³Ø§Ø¦Ù‚: <strong class="text-green-800">${driver.name}</strong></p>
                    <button id="open-chat-btn" data-order-id="${order.id}" class="flex items-center gap-2 bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-all"> <i class="fa-solid fa-comments"></i> <span>Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</span> </button>
                </div>`;
            }

            const orderItemsHtml = order.items.map(item => `<div class="flex justify-between items-center py-2 border-b"><span>${item.name} (x${item.quantity})</span><span class="font-semibold">${(item.price * item.quantity).toFixed(3)} Ø¯.Ùƒ</span></div>`).join('');
            
            const mapHtml = (order.status === 'out_for_delivery' && driver && order.location) 
                ? `<div class="mt-8"><h3 class="font-bold text-lg mb-4 text-center">ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3><div id="customer-tracking-map" class="map-container"></div></div>` 
                : '';

            customerView.innerHTML = `
                <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                        <div class="text-center mb-8"><img src="${logoUrl}" class="h-16 mx-auto mb-4" alt="Logo"><h1 class="text-3xl font-bold">Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ</h1><p class="text-gray-500 mt-2">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <span class="font-mono">#${order.id}</span></p></div>
                        <div class="border rounded-lg p-4 mb-8"><h3 class="font-bold text-lg mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>${orderItemsHtml}<div class="flex justify-between items-center pt-2 font-bold text-xl"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span>${order.total.toFixed(3)} Ø¯.Ùƒ</span></div></div>
                        <div class="w-full mb-8"><div class="flex items-center">${stepsHtml}</div></div>
                        ${mapHtml}
                        <div class="text-center mt-8 bg-gray-50 p-6 rounded-lg">
                            <div class="text-7xl text-blue-500" id="status-icon"><i class="fa-solid ${statusIcons[order.status]}"></i></div>
                            <p class="font-bold text-xl mt-4" id="status-text">${statusTexts[order.status]}</p>
                            ${deliveryInfoHtml}
                        </div>
                        ${ratingUI}
                    </div>
                </main>`;
            
            if (order.status === 'out_for_delivery' && driver && order.location) {
                setTimeout(() => initCustomerTrackingMap(order), 100);
            }

            const chatBtn = document.getElementById('open-chat-btn');
            if (chatBtn) {
                chatBtn.addEventListener('click', e => openChatModal(Number(e.currentTarget.dataset.orderId), 'customer'));
            }

            if (order.status === 'delivered' && !order.rating) {
                document.querySelectorAll('.rating .fa-star').forEach(star => {
                    star.addEventListener('mouseover', e => {
                        e.currentTarget.classList.add('selected');
                        let previous = e.currentTarget.previousElementSibling;
                        while(previous) { previous.classList.add('selected'); previous = previous.previousElementSibling; }
                    });
                     star.addEventListener('mouseout', e => { if(!e.currentTarget.parentElement.dataset.rating) document.querySelectorAll('.rating .fa-star').forEach(s => s.classList.remove('selected')); });
                    star.addEventListener('click', e => {
                        const value = e.currentTarget.dataset.value;
                        const ratingContainer = e.currentTarget.parentElement;
                        ratingContainer.dataset.rating = value;
                        document.querySelectorAll('.rating .fa-star').forEach(s => s.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        let previous = e.currentTarget.previousElementSibling;
                        while(previous) { previous.classList.add('selected'); previous = previous.previousElementSibling; }
                    });
                });
                
                document.getElementById('submit-rating-btn').addEventListener('click', () => {
                    const driverRating = Number(document.querySelector('.driver-rating').dataset.rating);
                    if (!driverRating) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø§Ø¦Ù‚', 'error'); return; }
                    
                    order.rating = { driver: driverRating, comment: document.getElementById('rating-comment').value };
                    saveDB();
                    showToast('Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ!');
                    renderOrderTrackingPage(token);
                });
            }
        }
        
        function displayPublicProducts(categoryFilter = null, geminiFilter = null) {
            const productList = document.getElementById('public-products-list'); if(!productList) return;
            const searchTerm = document.getElementById('public-product-search')?.value.toLowerCase() || '';
            const sortOrder = document.getElementById('public-product-sort')?.value || 'default';
            const activeCategory = categoryFilter || 'all';

            let products = getDB().products.filter(p => {
                const name = p.name.toLowerCase();
                const matchesSearch = name.includes(searchTerm);
                const matchesCategory = activeCategory === 'all' || p.category === activeCategory;
                const matchesGemini = !geminiFilter || geminiFilter.includes(name);
                return (matchesSearch || !!geminiFilter) && matchesCategory && matchesGemini && !p.isFeatured && getAvailableStock(p.id) > 0;
            });

            if (sortOrder === 'price-asc') products.sort((a, b) => getProductPrice(a) - getProductPrice(b));
            if (sortOrder === 'price-desc') products.sort((a, b) => getProductPrice(b) - getProductPrice(a));
            if (sortOrder === 'name-asc') products.sort((a, b) => a.name.localeCompare(b.name));
            productList.innerHTML = products.length > 0 ? products.map(p => createProductCard(p)).join('') : `<p class="col-span-full text-center p-8 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ.</p>`;
        }
        
        function getProductPrice(product) { const promo = (db.promotions || []).find(p => (p.productIds || []).includes(product.id)); return promo ? product.price * (1 - promo.discount) : product.price; }

        function createProductCard(product) {
            const finalPrice = getProductPrice(product); const hasPromo = finalPrice < product.price; const quantityInCart = cart[product.id] || 0;
            const availableStock = getAvailableStock(product.id);
            const isOutOfStock = availableStock <= 0;
            let actionButtonHtml = isOutOfStock 
                ? `<div class="text-center text-red-500 font-bold p-2 w-32">Ù†ÙØ¯Øª Ø§Ù„ÙƒÙ…ÙŠØ©</div>` 
                : quantityInCart > 0 
                    ? `<div class="flex items-center justify-center gap-2 bg-gray-200 rounded-full p-1"><button class="update-cart-btn bg-white rounded-full h-8 w-8 font-bold text-lg" data-id="${product.id}" data-change="-1">-</button><span class="font-bold text-lg w-8 text-center">${quantityInCart}</span><button class="update-cart-btn bg-white rounded-full h-8 w-8 font-bold text-lg" data-id="${product.id}" data-change="1">+</button></div>` 
                    : `<button class="update-cart-btn btn-primary btn-sm w-32 bg-orange-500 hover:bg-orange-600" data-id="${product.id}" data-change="1">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>`;

            return `
                <div class="bg-white rounded-lg shadow p-4 flex items-start gap-4 js-product-card" data-product-id="${product.id}">
                    <div class="flex-shrink-0 w-24 h-24 bg-gray-100 rounded-md flex items-center justify-center relative">
                        <i class="${product.iconClass || 'fa-solid fa-box'} text-4xl text-gray-400"></i>
                         ${hasPromo ? `<div class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-bl-lg rounded-tr-md">Ø®ØµÙ…</div>` : ''}
                    </div>
                    <div class="flex-grow">
                        <h3 class="font-bold text-md leading-tight">${product.name}</h3>
                        <p class="text-sm text-gray-500 mt-1">${product.description || ''}</p>
                        <p class="font-semibold mt-2">${hasPromo ? `<del class="text-red-400 text-xs">${product.price.toFixed(3)}</del> ` : ''}${finalPrice.toFixed(3)} Ø¯.Ùƒ</p>
                    </div>
                    <div class="flex-shrink-0 flex flex-col items-center justify-center h-full pt-8">
                        ${actionButtonHtml}
                    </div>
                </div>`;
        }
        
        function updateCartButton() {
            const fabCount = document.getElementById('cart-fab-count');
            if (fabCount) {
                const totalItems = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
                fabCount.textContent = totalItems;
                fabCount.style.display = totalItems > 0 ? 'flex' : 'none';
            }
        }

        function updateCart(productId, change) {
            const product = getDB().products.find(p => p.id == productId); if(!product) return;
            const availableStock = getAvailableStock(product.id);
            let currentQty = cart[productId] || 0; 
            
            if (change > 0 && currentQty + change > availableStock) {
                 showToast(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù‡ÙŠ ${availableStock} ÙÙ‚Ø·.`, 'error');
                 return;
            }

            currentQty += change;
            if (currentQty < 0) currentQty = 0;

            if (currentQty > 0) cart[productId] = currentQty; else delete cart[productId];
            saveCart(); 
            
            updateCartButton();
            
            const card = document.querySelector(`.js-product-card[data-product-id="${productId}"]`); if (!card) return;
            const quantityInCart = cart[productId] || 0;
            const actionArea = card.querySelector('.flex-shrink-0:last-child');
            if (actionArea) {
                const isOutOfStock = availableStock <= quantityInCart;
                let newActionHtml = '';
                if (isOutOfStock && quantityInCart === 0) { newActionHtml = `<div class="text-center text-red-500 font-bold p-2 w-32">Ù†ÙØ¯Øª Ø§Ù„ÙƒÙ…ÙŠØ©</div>`; } 
                else if (quantityInCart > 0) { newActionHtml = `<div class="flex items-center justify-center gap-2 bg-gray-200 rounded-full p-1"><button class="update-cart-btn bg-white rounded-full h-8 w-8 font-bold text-lg" data-id="${product.id}" data-change="-1">-</button><span class="font-bold text-lg w-8 text-center">${quantityInCart}</span><button class="update-cart-btn bg-white rounded-full h-8 w-8 font-bold text-lg" data-id="${product.id}" data-change="1" ${isOutOfStock ? 'disabled' : ''}>+</button></div>`; } 
                else { newActionHtml = `<button class="update-cart-btn btn-primary btn-sm w-32 bg-orange-500 hover:bg-orange-600" data-id="${product.id}" data-change="1">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>`; }
                actionArea.innerHTML = newActionHtml;
            }
        }
        
        function handlePublicOrderSubmit(e) {
            e.preventDefault();
            if (Object.keys(cart).length === 0) { showToast('Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙØ§Ø±ØºØ©!', 'error'); return; }
            
            for (const [productId, quantity] of Object.entries(cart)) {
                if (quantity > getAvailableStock(Number(productId))) {
                    showToast(`Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ù…Ù†ØªØ¬ "${db.products.find(p=>p.id==productId).name}" Ù„Ù… ØªØ¹Ø¯ Ù…ØªØ§Ø­Ø©.`, 'error');
                    renderCheckoutModal();
                    return;
                }
            }

            const form = e.target;
            const customerName = form.customerName.value, address = form.customerAddress.value, phone = form.customerPhone.value;
            const lat = form.customerLat.value;
            const lng = form.customerLng.value;

            if (!lat || !lng) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹.', 'error');
                const statusEl = document.getElementById('location-status');
                if (statusEl) {
                    statusEl.classList.add('text-red-500', 'font-bold');
                    statusEl.textContent = 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨!';
                }
                return;
            }

            db.counters.order++; const orderId = db.counters.order;
            let subtotal = 0;
            const orderItems = Object.entries(cart).map(([productId, quantity]) => {
                const product = db.products.find(p => p.id == productId);
                const finalPrice = getProductPrice(product); 
                subtotal += finalPrice * quantity; 
                return { productId: Number(productId), name: product.name, quantity, price: finalPrice }; 
            });
            const total = subtotal + (db.settings.shippingFee || 0);
            let customer = db.customers.find(c => c.phone === phone); if (!customer) { db.counters.customer++; customer = { id: db.counters.customer, name: customerName, phone, address, points: 0, tags: ['New'] }; db.customers.push(customer); } else { customer.address = address; }
            customer.points = (customer.points || 0) + Math.floor(total * (db.settings.pointsPerKWD || 100));
            const trackingToken = `ORDER_${orderId}_${Math.random().toString(36).substr(2, 6)}`;
            
            const location = { lat: parseFloat(lat), lng: parseFloat(lng) };
            const order = { id: orderId, trackingToken, customerId: customer.id, customerName, customerAddress: address, customerPhone: phone, timestamp: new Date().toISOString(), status: 'pending', items: orderItems, total, driverId: null, rating: null, paymentMethod: 'cash', location: location };
            db.orders.push(order); 
            
            saveDB();
            localStorage.setItem(NEW_ORDER_EVENT_KEY, JSON.stringify({ orderId: order.id, timestamp: Date.now() }));
            
            let message = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${db.settings.storeName}* ğŸ›ï¸\n\n*Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:* ${orderId}\n*Ø§Ù„Ø¹Ù…ÙŠÙ„:* ${customerName}\n*Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${address}\n*Ø§Ù„Ù‡Ø§ØªÙ:* ${phone}\n\n*Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ùƒ:* ${window.location.origin}${window.location.pathname}#track=${trackingToken}\n\n*--- Ø§Ù„Ø·Ù„Ø¨Ø§Øª ---*\n${orderItems.map(i => `- ${i.name} (x${i.quantity})`).join('\n')}\n\n*Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:* ${total.toFixed(3)} Ø¯.Ùƒ`;
            window.open(`https://api.whatsapp.com/send?phone=${db.settings.whatsappNumber}&text=${encodeURIComponent(message)}`, '_blank');
            cart = {}; saveCart(); closeModal();
            window.location.hash = `track=${trackingToken}`;
        }
        
        // ----------------- DRIVER PORTAL FUNCTIONS -----------------
        function renderDriverPortal(driverId) {
            const portalView = document.getElementById('driver-portal-view');
            const driver = db.drivers.find(d => d.id === driverId);
            if (!driver) {
                portalView.innerHTML = `<h1>Driver not found</h1>`;
                return;
            }

            const newAssignedOrders = db.orders.filter(o => o.driverId === driverId && o.status === 'awaiting_driver_confirmation');
            const activeOrders = db.orders.filter(o => o.driverId === driverId && o.status === 'out_for_delivery');
            const today = new Date().toDateString();
            const completedToday = db.orders.filter(o => o.driverId === driverId && o.status === 'delivered' && new Date(o.timestamp).toDateString() === today);
            const cashToCollect = activeOrders.filter(o => o.paymentMethod === 'cash').reduce((sum, o) => sum + o.total, 0);

            const paymentTag = (method) => {
                if (method === 'online') {
                    return `<span class="text-xs font-bold bg-green-100 text-green-800 px-2 py-1 rounded-full"><i class="fa-solid fa-credit-card mr-1"></i>Ù…Ø¯ÙÙˆØ¹</span>`;
                }
                return `<span class="text-xs font-bold bg-orange-100 text-orange-800 px-2 py-1 rounded-full"><i class="fa-solid fa-money-bill mr-1"></i>Ù†Ù‚Ø¯ÙŠ</span>`;
            };

            //--[ ENHANCEMENT ]-- New order card now includes a map and distance
            const newOrdersHtml = newAssignedOrders.length > 0 ? newAssignedOrders.map(o => `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-4 border-4 border-blue-500 animate-pulse">
                    <div class="p-4">
                        <div class="text-center mb-3">
                            <p class="font-bold text-lg text-blue-600">Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!</p>
                            <p class="text-sm">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø±ÙØ¶ Ø®Ù„Ø§Ù„ <span id="timer-${o.id}" class="font-bold">60</span> Ø«Ø§Ù†ÙŠØ©</p>
                        </div>
                        <div id="new-order-map-${o.id}" class="map-container mb-2"></div>
                        <div class="text-center text-sm font-semibold mb-3" id="distance-${o.id}">
                            <i class="fa-solid fa-spinner fa-spin mr-2"></i> Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©...
                        </div>
                        <div class="mt-4 pt-4 border-t flex gap-2">
                             <button class="accept-order-btn flex-1 text-center btn-primary bg-green-500 hover:bg-green-600" data-order-id="${o.id}"><i class="fa-solid fa-check mr-2"></i>Ù‚Ø¨ÙˆÙ„</button>
                             <button class="reject-order-btn flex-1 text-center btn-primary bg-red-500 hover:bg-red-600" data-order-id="${o.id}"><i class="fa-solid fa-times mr-2"></i>Ø±ÙØ¶</button>
                        </div>
                    </div>
                </div>`).join('') : '';


            const activeOrdersHtml = activeOrders.length > 0 ? activeOrders.map(o => `
                <div class="bg-white rounded-xl shadow-md overflow-hidden mb-4">
                     <div id="driver-map-${o.id}" class="map-container"></div>
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500">Ø·Ù„Ø¨ #${o.id}</p>
                                <p class="font-bold text-lg">${o.customerName}</p>
                                <p class="text-sm text-gray-600 flex items-center gap-2 mt-1"><i class="fa-solid fa-location-dot text-gray-400"></i> ${o.customerAddress}</p>
                            </div>
                            <div class="text-left">
                                <p class="font-bold text-xl text-green-600">${o.total.toFixed(3)}</p>
                                ${paymentTag(o.paymentMethod)}
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t flex gap-2">
                             <a href="https://www.google.com/maps/dir/?api=1&origin=${db.settings.storeLocation.lat},${db.settings.storeLocation.lng}&destination=${o.location.lat},${o.location.lng}" target="_blank" class="flex-1 text-center btn-primary bg-blue-500 hover:bg-blue-600 btn-sm"><i class="fa-solid fa-map-location-dot mr-2"></i>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù„Ø§Ø­Ø©</a>
                            <button class="open-chat-btn flex-1 text-center btn-primary bg-sky-500 hover:bg-sky-600 btn-sm" data-order-id="${o.id}"><i class="fa-solid fa-comments mr-2"></i>Ù…Ø­Ø§Ø¯Ø«Ø©</button>
                        </div>
                        <div class="mt-2">
                            <button class="w-full btn-primary bg-green-600 hover:bg-green-700 btn-sm mark-delivered-btn" data-order-id="${o.id}"><i class="fa-solid fa-check-double mr-2"></i>ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„</button>
                        </div>
                    </div>
                </div>`).join('') : (newAssignedOrders.length === 0 ? `<div class="text-center text-gray-500 p-8 bg-white rounded-lg shadow"><i class="fa-solid fa-box-open text-4xl text-gray-300"></i><p class="mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ÙŠÙ†Ø© Ù„Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹.</p></div>` : '');
            
            portalView.innerHTML = `
                <header class="bg-white shadow-md sticky top-0 z-10">
                    <div class="p-4 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <img src="${logoUrl}" alt="Logo" class="h-10">
                            <div>
                                <p class="text-sm text-gray-500">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</p>
                                <h1 class="font-bold text-2xl">${driver.name}</h1>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <i class="fa-solid fa-bell text-2xl text-gray-500 notification-bell"></i>
                                <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden"></span>
                            </div>
                            <button id="driver-logout-btn" class="text-red-500 text-xl"><i class="fa-solid fa-right-from-bracket"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-px bg-gray-200">
                        <div class="bg-white p-3 text-center">
                            <p class="font-bold text-2xl text-green-600">${completedToday.length}</p>
                            <p class="text-sm text-gray-500">Ø·Ù„Ø¨Ø§Øª Ù…Ù†Ø¬Ø²Ø© Ø§Ù„ÙŠÙˆÙ…</p>
                        </div>
                        <div class="bg-white p-3 text-center">
                            <p class="font-bold text-2xl text-orange-600">${cashToCollect.toFixed(3)}</p>
                            <p class="text-sm text-gray-500">Ù…Ø¨Ø§Ù„Øº Ù„Ù„ØªØ­ØµÙŠÙ„</p>
                        </div>
                    </div>
                </header>
                <main class="p-4">
                    ${newOrdersHtml}
                    <h2 class="text-xl font-bold mb-4 mt-4">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (${activeOrders.length})</h2>
                    <div id="driver-orders-list">${activeOrdersHtml}</div>
                </main>`;
            
            setTimeout(() => {
                activeOrders.forEach(o => initDriverOrderMap(o));
                //--[ ENHANCEMENT ]-- Initialize the new confirmation maps
                newAssignedOrders.forEach(o => initDriverConfirmationMap(o));
            }, 100);

            newAssignedOrders.forEach(order => {
                const timerEl = document.getElementById(`timer-${order.id}`);
                let timeLeft = 60;
                
                const intervalId = setInterval(() => {
                    timeLeft--;
                    if (timerEl) timerEl.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(intervalId);
                        handleDriverResponse(order.id, false);
                    }
                }, 1000);

                driverTimers[order.id] = { intervalId };
            });
            document.querySelectorAll('.accept-order-btn').forEach(btn => btn.addEventListener('click', e => handleDriverResponse(Number(e.currentTarget.dataset.orderId), true)));
            document.querySelectorAll('.reject-order-btn').forEach(btn => btn.addEventListener('click', e => handleDriverResponse(Number(e.currentTarget.dataset.orderId), false)));
            
            document.getElementById('driver-logout-btn').addEventListener('click', logout);
            
            document.querySelectorAll('.mark-delivered-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderId = Number(e.currentTarget.dataset.orderId);
                    const order = db.orders.find(o => o.id === orderId);
                    if (order) {
                        if(driverIntervals[orderId]) clearInterval(driverIntervals[orderId]);
                        delete driverIntervals[orderId];
                        order.status = 'delivered';
                        saveDB();
                        localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: order.status, timestamp: Date.now() }));
                        showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ #${orderId}`);
                        renderDriverPortal(driverId);
                    }
                });
            });
            document.querySelectorAll('.open-chat-btn').forEach(btn => {
                btn.addEventListener('click', e => openChatModal(Number(e.currentTarget.dataset.orderId), 'driver'));
            });
        }
        
        function handleDriverResponse(orderId, accepted) {
            const order = db.orders.find(o => o.id === orderId);
            if (!order || order.status !== 'awaiting_driver_confirmation') return;

            if (driverTimers[orderId]) {
                clearInterval(driverTimers[orderId].intervalId);
                delete driverTimers[orderId];
            }

            if (accepted) {
                order.status = 'out_for_delivery';
                showToast(`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ #${orderId}`, 'success');
            } else {
                order.status = 'in_progress';
                order.driverId = null;
                showToast(`ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ #${orderId}`, 'error');
            }
            
            saveDB();
            localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: order.status, timestamp: Date.now() }));
            renderDriverPortal(currentUser.id);
        }


        function handleDriverStorageEvent(event) {
            const oldDbData = JSON.stringify(db);
            loadDB();
            const newDbData = JSON.stringify(db);

            if (oldDbData !== newDbData && currentUser && currentUser.type === 'driver') {
                const oldOrders = JSON.parse(oldDbData).orders.filter(o => o.driverId === currentUser.id && o.status === 'awaiting_driver_confirmation').length;
                const newOrders = db.orders.filter(o => o.driverId === currentUser.id && o.status === 'awaiting_driver_confirmation').length;
                
                if (newOrders > oldOrders) {
                    playDriverNotificationSound();
                    const bell = document.querySelector('.notification-bell');
                    const badge = document.getElementById('notification-badge');
                    if(bell) bell.classList.add('active');
                    if(badge) {
                        badge.textContent = newOrders;
                        badge.classList.remove('hidden');
                    }
                    setTimeout(() => bell?.classList.remove('active'), 800);
                }
                renderDriverPortal(currentUser.id);
            }
        }
        
        // ----------------- CHAT FUNCTIONS -----------------
        function openChatModal(orderId, userType) {
            const order = db.orders.find(o => o.id === orderId);
            const otherPartyName = userType === 'customer' ? (db.drivers.find(d => d.id === order.driverId)?.name || 'Ø§Ù„Ø³Ø§Ø¦Ù‚') : order.customerName;
            const content = `
                <div id="chat-modal-content" data-order-id="${orderId}" class="flex flex-col h-[70vh]">
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-4 bg-gray-100 rounded-t-lg space-y-4"></div>
                    <form id="chat-form" class="p-4 border-t flex gap-2">
                        <input id="chat-input" class="flex-grow p-2 border rounded-full" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off">
                        <button type="submit" class="btn-primary rounded-full !p-3 h-12 w-12 flex items-center justify-center"><i class="fa-solid fa-paper-plane"></i></button>
                    </form>
                </div>`;
            openModal(`Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø®ØµÙˆØµ Ø·Ù„Ø¨ #${orderId}`, content, 'max-w-lg');
            renderChatMessages(orderId, userType);

            document.getElementById('chat-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (text) {
                    handleSendMessage(orderId, userType, text);
                    input.value = '';
                }
            });
        }
        
        function renderChatMessages(orderId, userType) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            loadDB(); 
            const messages = db.chats[orderId] || [];
            messagesContainer.innerHTML = messages.map(msg => {
                const isMine = msg.sender === userType;
                const isAdminMsg = msg.sender === 'admin';
                
                let alignment = 'justify-start';
                if (isMine) alignment = 'justify-end';
                if (isAdminMsg && userType !== 'admin') alignment = 'justify-center'; 

                let bubbleClass = 'bg-gray-200 text-gray-800 rounded-bl-none'; 
                if (isMine) bubbleClass = 'bg-blue-500 text-white rounded-br-none'; 
                if (isAdminMsg) bubbleClass = 'bg-purple-100 text-purple-800 border border-purple-300';
                
                let senderName = '';
                if (isAdminMsg && userType !== 'admin') {
                    senderName = `<p class="font-bold text-xs text-purple-600">Ø§Ù„Ù…Ø¯ÙŠØ±</p>`;
                } else if (!isMine && userType === 'admin') {
                    senderName = `<p class="font-bold text-xs ${msg.sender === 'customer' ? 'text-green-600' : 'text-blue-600'}">${msg.sender === 'customer' ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' : 'Ø§Ù„Ø³Ø§Ø¦Ù‚'}</p>`;
                }


                return `
                    <div class="flex ${alignment}">
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${bubbleClass}">
                            ${senderName}
                            <p>${msg.text}</p>
                            <p class="text-xs opacity-75 mt-1 text-right">${new Date(msg.timestamp).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}</p>
                        </div>
                    </div>`;
            }).join('');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function handleSendMessage(orderId, sender, text) {
            if (!db.chats[orderId]) {
                db.chats[orderId] = [];
            }
            db.chats[orderId].push({ sender, text, timestamp: new Date().toISOString() });
            saveDB();
            localStorage.setItem(CHAT_EVENT_KEY, JSON.stringify({ orderId, sender, timestamp: Date.now() }));
            renderChatMessages(orderId, sender);
        }

        // ----------------- MAP FUNCTIONS -----------------
        
        //--[ ENHANCEMENT ]-- New, heavily modified function for the admin's live map
        function initAdminMap() {
            const mapContainer = document.getElementById('dashboard-map');
            if (!mapContainer || typeof google === 'undefined') return;

            const map = new google.maps.Map(mapContainer, {
                zoom: 11,
                center: db.settings.storeLocation,
                mapId: 'BAQALTAK_ADMIN_LIVE_MAP'
            });

            const statusTexts = { awaiting_driver_confirmation: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯', out_for_delivery: 'ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ù„Ù„ØªÙˆØµÙŠÙ„'};
            const infoWindow = new google.maps.InfoWindow();

            // Store Marker
            new google.maps.Marker({
                position: db.settings.storeLocation,
                map,
                title: db.settings.storeName,
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });

            const activeOrders = db.orders.filter(o => ['awaiting_driver_confirmation', 'out_for_delivery'].includes(o.status) && o.driverId);
            
            activeOrders.forEach(order => {
                const driver = db.drivers.find(d => d.id === order.driverId);
                if (!driver || !driver.location || !order.location) return;

                // Driver Marker
                const driverMarker = new google.maps.Marker({
                    position: driver.location,
                    map,
                    title: `Ø§Ù„Ø³Ø§Ø¦Ù‚: ${driver.name}`,
                    icon: {
                        url: 'http://googleusercontent.com/file_content/0', // Motorcycle icon
                        scaledSize: new google.maps.Size(48, 48)
                    }
                });

                // Customer Marker
                new google.maps.Marker({
                    position: order.location,
                    map,
                    title: `Ø¹Ù…ÙŠÙ„: ${order.customerName}`,
                    icon: {
                        url: 'http://googleusercontent.com/file_content/1', // House icon
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });

                // InfoWindow Content
                const contentString = `
                    <div style="font-family: 'Cairo', sans-serif; text-align: right; padding: 5px;">
                        <p><strong>Ø§Ù„Ø³Ø§Ø¦Ù‚:</strong> ${driver.name}</p>
                        <p><strong>Ø·Ù„Ø¨ Ø±Ù‚Ù…:</strong> #${order.id}</p>
                        <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.customerName}</p>
                        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${statusTexts[order.status]}</p>
                    </div>`;

                driverMarker.addListener('click', () => {
                    infoWindow.setContent(contentString);
                    infoWindow.open(map, driverMarker);
                });

                // Route Line
                const flightPath = new google.maps.Polyline({
                    path: [driver.location, order.location],
                    geodesic: true,
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    icons: [{
                        icon: { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW },
                        offset: '100%',
                        repeat: '100px'
                    }]
                });
                flightPath.setMap(map);
            });
        }

        //--[ ENHANCEMENT ]-- New function for the driver's confirmation map
        function initDriverConfirmationMap(order) {
            const mapContainer = document.getElementById(`new-order-map-${order.id}`);
            const distanceContainer = document.getElementById(`distance-${order.id}`);
            if (!mapContainer || typeof google === 'undefined' || !order.location) return;

            const map = new google.maps.Map(mapContainer, {
                zoom: 12,
                center: order.location,
                mapId: `DRIVER_CONFIRM_MAP_${order.id}`
            });

            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                preserveViewport: true
            });
            directionsRenderer.setMap(map);
            
            const request = {
                origin: db.settings.storeLocation,
                destination: order.location,
                travelMode: 'DRIVING'
            };

            directionsService.route(request, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                    
                    const route = response.routes[0].legs[0];
                    if (distanceContainer && route.distance) {
                        distanceContainer.innerHTML = `<i class="fa-solid fa-route mr-2"></i> Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: <span class="font-bold">${route.distance.text}</span>`;
                    }

                    // Add custom markers
                    new google.maps.Marker({
                        position: db.settings.storeLocation,
                        map,
                        title: `Ø§Ø³ØªÙ„Ø§Ù…: ${db.settings.storeName}`,
                        icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
                    });
                    new google.maps.Marker({
                        position: order.location,
                        map,
                        title: `ØªØ³Ù„ÙŠÙ…: ${order.customerName}`,
                        icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    });
                } else {
                    if (distanceContainer) distanceContainer.textContent = 'ØªØ¹Ø°Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±.';
                    console.warn('Directions request failed due to ' + status);
                }
            });
        }

        function initDriverOrderMap(order) {
            const mapContainer = document.getElementById(`driver-map-${order.id}`);
            const driver = db.drivers.find(d => d.id === order.driverId);
            if (!mapContainer || typeof google === 'undefined' || !driver || !driver.location || !order.location) return;

            const map = new google.maps.Map(mapContainer, {
                zoom: 12,
                center: driver.location,
                mapId: `DRIVER_MAP_${order.id}`
            });

            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({ preserveViewport: true });
            directionsRenderer.setMap(map);

            directionsService.route({
                origin: driver.location,
                destination: order.location,
                travelMode: 'DRIVING'
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                } else {
                    console.warn('Directions request failed due to ' + status);
                }
            });
        }
        
        function initCustomerTrackingMap(order) {
            const mapContainer = document.getElementById('customer-tracking-map');
            const driver = db.drivers.find(d => d.id === order.driverId);
            if (!mapContainer || typeof google === 'undefined' || !driver || !driver.location || !order.location) return;

            if (driverIntervals[order.id]) clearInterval(driverIntervals[order.id]);

            const map = new google.maps.Map(mapContainer, {
                zoom: 12,
                center: order.location,
                mapId: `CUSTOMER_TRACKING_MAP_${order.id}`
            });

            const customerMarker = new google.maps.Marker({
                position: order.location,
                map,
                title: "Ù…ÙˆÙ‚Ø¹Ùƒ",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: "#ea580c",
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: "white",
                },
            });

            const driverMarker = new google.maps.Marker({
                position: driver.location,
                map,
                title: `Ø§Ù„Ø³Ø§Ø¦Ù‚: ${driver.name}`,
                icon: {
                    url: "http://googleusercontent.com/file_content/0", // Motorcycle Icon
                    scaledSize: new google.maps.Size(48, 48),
                }
            });
            
            // NOTE: This is a simulation. In a real app, the driver's location would be updated from the server.
            const startPoint = new google.maps.LatLng(driver.location.lat, driver.location.lng);
            const endPoint = new google.maps.LatLng(order.location.lat, order.location.lng);
            let step = 0;
            const numSteps = 200; 
            const timePerStep = 1000;

            driverIntervals[order.id] = setInterval(() => {
                step++;
                if (step > numSteps) {
                    clearInterval(driverIntervals[order.id]);
                    delete driverIntervals[order.id];
                    return;
                }
                const newPos = google.maps.geometry.spherical.interpolate(startPoint, endPoint, step / numSteps);
                driverMarker.setPosition(newPos);
                driver.location = { lat: newPos.lat(), lng: newPos.lng() };
            }, timePerStep);
        }

        // ----------------- ADMIN FUNCTIONS -----------------
        function handleHashChange() {
            Object.values(driverIntervals).forEach(clearInterval);
            driverIntervals = {};
            Object.values(driverTimers).forEach(t => clearInterval(t.intervalId));
            driverTimers = {};
            mapInstances = {};

            if (!currentUser) { renderPublicView(); return; }
            
            const hash = window.location.hash.substring(1) || (currentUser.type === 'admin' ? 'dashboard' : 'driver_portal');
            
            if (currentUser.type === 'admin') {
                document.getElementById('selection-view').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('driver-portal-view').style.display = 'none';
                document.getElementById('current-user-name').textContent = currentUser.name;

                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-link, .bottom-nav-link').forEach(l => l.classList.remove('active'));
                
                const pageEl = document.getElementById(`page-${hash}`);
                const linkEl = document.querySelector(`.sidebar a[href="#${hash}"]`);
                if (pageEl) pageEl.classList.add('active');
                if (linkEl) { 
                    const title = linkEl.textContent.trim();
                    document.getElementById('page-title').textContent = title;
                    document.getElementById('page-title-mobile').textContent = title;
                    document.querySelectorAll(`a[href="#${hash}"]`).forEach(l => l.classList.add('active'));
                }
                const renderMap = { dashboard: renderDashboard, inventory: renderInventory, promotions: renderPromotions, orders: renderOrders, customers: renderCustomers, finance: renderFinance, analytics: renderAnalytics, settings: renderSettings, drivers: renderDrivers, returns: renderReturns };
                if (renderMap[hash]) renderMap[hash]();

            } else if (currentUser.type === 'driver') {
                document.getElementById('selection-view').style.display = 'none';
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('driver-portal-view').style.display = 'block';
                renderDriverPortal(currentUser.id);
            }
        }
        
        function renderDashboard() {
            const pendingOrders = db.orders.filter(o => o.status === 'pending').sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const inProgressOrders = db.orders.filter(o => o.status === 'in_progress').sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const outForDeliveryOrders = db.orders.filter(o => o.status === 'out_for_delivery' || o.status === 'awaiting_driver_confirmation').sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const lowStockProducts = db.products.filter(p => p.stock > 0 && p.stock <= (p.lowStockThreshold || 5));

            const createOrderCard = (order) => {
                const driver = order.driverId ? db.drivers.find(d => d.id === order.driverId) : null;
                const driverInfo = driver ? `<p class="text-xs text-purple-600 font-bold mt-1">Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚: ${driver.name} ${order.status === 'awaiting_driver_confirmation' ? '(Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯)' : ''}</p>` : '';
                return `<div class="order-card border rounded-lg p-4 shadow-sm mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <div><p class="font-bold text-lg">Ø·Ù„Ø¨ #${order.id}</p><p class="text-sm text-gray-500">${order.customerName}</p></div>
                        <p class="text-xs text-gray-400">${timeAgo(order.timestamp)}</p>
                    </div>
                    <p class="text-sm my-2">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${order.items.length} Ø£ØµÙ†Ø§Ù</p>
                    <p class="font-bold text-lg text-green-600 mb-2">${order.total.toFixed(3)} Ø¯.Ùƒ</p>
                    ${driverInfo}
                    <div class="flex gap-2 mt-4">
                        <button class="view-order-btn text-sm bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg flex-1" data-id="${order.id}">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                        ${order.status === 'pending' ? `<button class="start-processing-btn text-sm bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex-1" data-id="${order.id}">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</button>` : ''}
                        ${order.status === 'in_progress' ? `<button class="assign-driver-btn text-sm bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg flex-1" data-id="${order.id}">ØªØ¹ÙŠÙŠÙ† Ø³Ø§Ø¦Ù‚</button>` : ''}
                    </div>
                </div>`;
            };
            const lowStockHtml = lowStockProducts.length > 0 ? lowStockProducts.map(p => `<div class="flex justify-between items-center p-2 border-b"><span class="font-semibold">${p.name}</span><span class="font-bold text-red-500">${p.stock}</span></div>`).join('') : '<p class="text-center text-gray-400 p-4">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø©.</p>';
                
            const content = `
                <div class="mb-4 border-b">
                    <nav class="flex -mb-px" id="dashboard-tabs">
                        <a href="#orders-view" class="tab-link active-tab whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg">Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
                        <a href="#map-view" class="tab-link whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg">Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­ÙŠØ©</a>
                    </nav>
                </div>
                <div id="dashboard-content">
                    <div id="orders-view" class="tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="order-column border rounded-lg p-4"><h3 class="font-bold text-xl mb-4 flex items-center justify-between">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© <span class="bg-yellow-200 text-yellow-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded-full">${pendingOrders.length}</span></h3><div class="space-y-3 max-h-[60vh] overflow-y-auto">${pendingOrders.map(createOrderCard).join('') || '<p class="text-center text-gray-400 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>'}</div></div>
                            <div class="order-column border rounded-lg p-4"><h3 class="font-bold text-xl mb-4 flex items-center justify-between">Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² <span class="bg-blue-200 text-blue-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded-full">${inProgressOrders.length}</span></h3><div class="space-y-3 max-h-[60vh] overflow-y-auto">${inProgressOrders.map(createOrderCard).join('') || '<p class="text-center text-gray-400 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</p>'}</div></div>
                            <div class="order-column border rounded-lg p-4"><h3 class="font-bold text-xl mb-4 flex items-center justify-between">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„ <span class="bg-purple-200 text-purple-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded-full">${outForDeliveryOrders.length}</span></h3><div class="space-y-3 max-h-[60vh] overflow-y-auto">${outForDeliveryOrders.map(createOrderCard).join('') || '<p class="text-center text-gray-400 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„</p>'}</div></div>
                        </div>
                         <div class="mt-6 order-column border rounded-lg p-4"><h3 class="font-bold text-xl mb-4 flex items-center justify-between"><i class="fa-solid fa-triangle-exclamation text-yellow-500 mr-2"></i>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3><div class="space-y-2 max-h-[60vh] overflow-y-auto">${lowStockHtml}</div></div>
                    </div>
                    <div id="map-view" class="tab-content hidden">
                        <div id="dashboard-map" class="dashboard-map-container rounded-lg shadow-md"></div>
                    </div>
                </div>
                <style>
                    .tab-link { color: #6b7280; border-color: transparent; }
                    .tab-link.active-tab { color: #3b82f6; border-color: #3b82f6; }
                    body.dark-mode .tab-link { color: #9ca3af; }
                    body.dark-mode .tab-link.active-tab { color: #60a5fa; border-color: #60a5fa; }
                </style>
            `;
            renderPage('page-dashboard', content, () => {
                document.querySelectorAll('.view-order-btn').forEach(btn => btn.addEventListener('click', e => handleViewOrder(Number(btn.dataset.id))));
                document.querySelectorAll('.start-processing-btn').forEach(btn => btn.addEventListener('click', e => { 
                    const order = db.orders.find(o => o.id === Number(btn.dataset.id)); 
                    if(order) { 
                        order.items.forEach(item => {
                            const product = db.products.find(p => p.id === item.productId);
                            if (product) {
                                product.stock -= item.quantity;
                            }
                        });
                        order.status = 'in_progress'; 
                        saveDB(); 
                        localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: order.status, timestamp: Date.now() })); 
                        renderDashboard(); 
                    } 
                }));
                document.querySelectorAll('.assign-driver-btn').forEach(btn => btn.addEventListener('click', e => openDeliveryModal(Number(btn.dataset.id))));
                
                document.querySelectorAll('#dashboard-tabs .tab-link').forEach(tab => {
                    tab.addEventListener('click', e => {
                        e.preventDefault();
                        document.querySelectorAll('#dashboard-tabs .tab-link').forEach(t => t.classList.remove('active-tab'));
                        e.target.classList.add('active-tab');

                        document.querySelectorAll('#dashboard-content .tab-content').forEach(c => c.classList.add('hidden'));
                        const targetViewId = e.target.getAttribute('href').substring(1);
                        document.getElementById(targetViewId).classList.remove('hidden');

                        if (targetViewId === 'map-view') {
                            setTimeout(initAdminMap, 50);
                        }
                    });
                });
            });
        }

        function openDeliveryModal(orderId) {
            const order = db.orders.find(o => o.id === orderId);
            const driverOptions = db.drivers.map(d => `<option value="${d.id}" ${order.driverId === d.id ? 'selected' : ''}>${d.name}</option>`).join('');
            const content = `<form id="delivery-form" class="space-y-4"><p>Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³Ø§Ø¦Ù‚ Ù„ØªØ£ÙƒÙŠØ¯Ù‡.</p><label>Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚:</label><select name="driverId" class="p-2 border rounded w-full">${driverOptions}</select><button type="submit" class="btn-primary w-full bg-purple-500">ØªØ£ÙƒÙŠØ¯ ÙˆØªØ¹ÙŠÙŠÙ†</button></form>`;
            openModal('ØªØ¹ÙŠÙŠÙ† Ø³Ø§Ø¦Ù‚ Ù„Ù„ØªÙˆØµÙŠÙ„', content);
            document.getElementById('delivery-form').addEventListener('submit', e => {
                e.preventDefault();
                const driverId = Number(e.target.driverId.value);
                const driver = db.drivers.find(d => d.id === driverId);
                if (!driver) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚', 'error'); return; }
                order.status = 'awaiting_driver_confirmation';
                order.driverId = driverId;
                if (!driver.location) driver.location = db.settings.storeLocation;
                saveDB();
                localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: order.status, timestamp: Date.now() }));
                renderDashboard();
                closeModal();
                showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³Ø§Ø¦Ù‚ Ù„Ù„ØªØ£ÙƒÙŠØ¯.');
            });
        }

        function renderInventory() { const content = `<div class="flex flex-col md:flex-row justify-between items-center mb-6"><h2 class="text-2xl font-bold">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2><button id="add-product-btn" class="btn-primary mt-4 md:mt-0">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button></div><div id="inventory-list" class="bg-white rounded-lg shadow overflow-hidden"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-right">Ø§Ù„Ù…Ù†ØªØ¬</th><th class="p-3 text-center">Ø§Ù„Ø³Ø¹Ø±</th><th class="p-3 text-center">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙØ¹Ù„ÙŠØ©</th><th class="p-3 text-center">Ø§Ù„Ù…Ø­Ø¬ÙˆØ²</th><th class="p-3 text-center">Ø§Ù„Ù…ØªØ§Ø­</th><th class="p-3"></th></tr></thead><tbody class="divide-y"></tbody></table></div>`; renderPage('page-inventory', content, () => { document.getElementById('add-product-btn').addEventListener('click', () => handleAddEditProduct()); displayInventory(); }); }
        function displayInventory() { 
            const list = document.querySelector('#inventory-list tbody'); 
            if(!list) return; 
            list.innerHTML = db.products.map(p => {
                const reserved = getReservedStock(p.id);
                const available = p.stock - reserved;
                return `<tr class="hover:bg-gray-50" data-id="${p.id}"> 
                    <td class="p-3 font-semibold">${p.name}</td> 
                    <td class="p-3 text-center">${p.price.toFixed(3)}</td> 
                    <td class="p-3 text-center font-bold">${p.stock}</td> 
                    <td class="p-3 text-center text-orange-600">${reserved}</td>
                    <td class="p-3 text-center text-green-600 font-bold">${available}</td>
                    <td class="p-3 text-left whitespace-nowrap">
                        <button class="edit-product-btn text-blue-500 hover:text-blue-700" data-id="${p.id}"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button class="delete-product-btn text-red-500 hover:text-red-700 mr-3" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button>
                    </td> 
                </tr>`
            }).join('') || '<tr><td colspan="6" class="text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª.</td></tr>'; 
            document.querySelectorAll('.edit-product-btn').forEach(b => b.addEventListener('click', e => handleAddEditProduct(Number(e.currentTarget.dataset.id)))); 
            document.querySelectorAll('.delete-product-btn').forEach(b => b.addEventListener('click', e => { 
                if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) { 
                    db.products = db.products.filter(p => p.id !== Number(e.currentTarget.dataset.id)); 
                    saveDB(); 
                    displayInventory(); 
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬.'); 
                }
            })); 
        }
        function handleAddEditProduct(id = null) { 
            const isEdit = id !== null; 
            const p = isEdit ? db.products.find(prod => prod.id === id) : {}; 
            const form = `<form id="product-form" class="space-y-4"><div class="relative"><input name="name" value="${p.name||''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required class="p-2 border rounded w-full"><button type="button" id="gemini-desc-btn" class="absolute top-1/2 left-2 -translate-y-1/2 btn-primary btn-sm bg-gradient-to-r from-purple-500 to-pink-500 text-xs">âœ¨ Ø§Ù‚ØªØ±Ø§Ø­ ÙˆØµÙ</button></div><textarea name="description" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬..." class="p-2 border rounded w-full h-24">${p.description||''}</textarea><input name="category" value="${p.category||''}" placeholder="Ø§Ù„Ù‚Ø³Ù…" required class="p-2 border rounded w-full"><div class="grid md:grid-cols-2 gap-4"><input name="price" value="${p.price||''}" placeholder="Ø§Ù„Ø³Ø¹Ø±" type="number" step="0.001" required class="p-2 border rounded w-full"><input name="stock" value="${p.stock||''}" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" type="number" required class="p-2 border rounded w-full"></div><div class="grid md:grid-cols-2 gap-4"><input name="lowStockThreshold" value="${p.lowStockThreshold||'5'}" placeholder="Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†" type="number" required class="p-2 border rounded w-full"><input name="iconClass" value="${p.iconClass||'fa-solid fa-box'}" placeholder="Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø«Ø§Ù„: fa-solid fa-box)" class="p-2 border rounded w-full"></div><label class="flex items-center gap-2"><input type="checkbox" name="isFeatured" ${p.isFeatured ? 'checked' : ''}><span>Ø¹Ø±Ø¶ ÙƒÙ…Ù†ØªØ¬ Ù…Ù…ÙŠØ²ØŸ</span></label><button type="submit" class="btn-primary w-full">${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬'}</button></form>`; 
            openModal(isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯', form); 
            document.getElementById('gemini-desc-btn').addEventListener('click', async (e) => {
                const button = e.target; const originalText = button.innerHTML; const nameInput = document.querySelector('input[name="name"]'); const descTextarea = document.querySelector('textarea[name="description"]'); const productName = nameInput.value;
                if (!productName) { showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹.", "error"); return; }
                const prompt = `Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ ØªØ³ÙˆÙŠÙ‚ÙŠØ§Ù‹ Ù‚ØµÙŠØ±Ø§Ù‹ ÙˆØ¬Ø°Ø§Ø¨Ø§Ù‹ (Ø¬Ù…Ù„ØªÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰) Ù„Ù…Ù†ØªØ¬ Ø¨Ù‚Ø§Ù„Ø© Ø§Ø³Ù…Ù‡ '${productName}'. Ø§Ø¬Ø¹Ù„ Ø§Ù„ÙˆØµÙ Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.`;
                const response = await callGemini(prompt, button); descTextarea.value = response; button.innerHTML = originalText;
            });
            document.getElementById('product-form').addEventListener('submit', e => { e.preventDefault(); const data = new FormData(e.target); const productData = { name: data.get('name'), description: data.get('description'), category: data.get('category'), iconClass: data.get('iconClass'), price: Number(data.get('price')), stock: Number(data.get('stock')), lowStockThreshold: Number(data.get('lowStockThreshold')), isFeatured: data.get('isFeatured') === 'on' }; if (isEdit) { Object.assign(db.products.find(prod => prod.id === id), productData); } else { db.counters.product++; db.products.push({id: db.counters.product, ...productData}); } saveDB(); displayInventory(); closeModal(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­.'); }); 
        }

        function renderPromotions() { const content = `<div class="flex flex-col md:flex-row justify-between items-center mb-6"><h2 class="text-2xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</h2><button id="add-promo-btn" class="btn-primary mt-4 md:mt-0">Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</button></div><div id="promotions-list" class="space-y-4"></div>`; renderPage('page-promotions', content, () => { document.getElementById('add-promo-btn').addEventListener('click', () => handleAddEditPromotion()); displayPromotions(); }); }
        function displayPromotions() { const list = document.getElementById('promotions-list'); list.innerHTML = (db.promotions||[]).map(p => `<div class="bg-white p-4 rounded-lg shadow flex items-center justify-between"><div><h3 class="font-bold">${p.name}</h3><p class="text-sm text-gray-500">Ø®ØµÙ…: ${p.discount*100}% Ø¹Ù„Ù‰ ${p.productIds ? p.productIds.length : 'ÙƒÙ„'} Ù…Ù†ØªØ¬(Ø§Øª)</p></div><div><button class="edit-promo-btn text-blue-500" data-id="${p.id}"><i class="fa-solid fa-pen-to-square"></i></button><button class="delete-promo-btn text-red-500 mr-2" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button></div></div>`).join('') || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>'; document.querySelectorAll('.edit-promo-btn').forEach(b => b.addEventListener('click', e => handleAddEditPromotion(Number(e.currentTarget.dataset.id)))); document.querySelectorAll('.delete-promo-btn').forEach(b => b.addEventListener('click', e => { if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) { db.promotions = db.promotions.filter(p => p.id !== Number(e.currentTarget.dataset.id)); saveDB(); displayPromotions(); showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶.'); }})); }
        function handleAddEditPromotion(id = null) {
            const isEdit = id !== null;
            const p = isEdit ? db.promotions.find(promo => promo.id === id) : { productIds: [] };
            const productOptions = db.products.map(prod => `<option value="${prod.id}" ${p.productIds.includes(prod.id) ? 'selected' : ''}>${prod.name}</option>`).join('');
            const form = `<form id="promo-form" class="space-y-4">
                <input name="name" value="${p.name || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶" required class="p-2 border rounded w-full">
                <input name="discount" value="${p.discount || ''}" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (Ù…Ø«Ø§Ù„: 0.1 Ù„Ø®ØµÙ… 10%)" type="number" step="0.01" required class="p-2 border rounded w-full">
                <label class="block">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¶ (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª)</label>
                <select name="productIds" multiple class="w-full p-2 border rounded h-40">${productOptions}</select>
                <div class="relative">
                    <textarea name="promoMessage" placeholder="Ø±Ø³Ø§Ù„Ø© ØªØ³ÙˆÙŠÙ‚ÙŠØ©..." class="p-2 border rounded w-full h-24">${p.promoMessage || ''}</textarea>
                    <button type="button" id="gemini-promo-btn" class="absolute top-2 left-2 btn-primary btn-sm bg-gradient-to-r from-purple-500 to-pink-500 text-xs">âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø±Ø³Ø§Ù„Ø©</button>
                </div>
                <button type="submit" class="btn-primary w-full">${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø±Ø¶'}</button>
            </form>`;
            openModal(isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶' : 'Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯', form);

            document.getElementById('gemini-promo-btn').addEventListener('click', async (e) => {
                const button = e.target;
                const form = button.closest('form');
                const promoName = form.name.value;
                const discount = form.discount.value;
                const messageTextarea = form.promoMessage;
                if (!promoName || !discount) {
                    showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… Ø£ÙˆÙ„Ø§Ù‹.", "error");
                    return;
                }
                const originalText = button.innerHTML;
                const prompt = `Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ù‚ØµÙŠØ±Ø© ÙˆØ¬Ø°Ø§Ø¨Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¹Ù† Ø¹Ø±Ø¶ Ø§Ø³Ù…Ù‡ "${promoName}" ÙŠØªØ¶Ù…Ù† Ø®ØµÙ… Ø¨Ù†Ø³Ø¨Ø© ${discount * 100}%. Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.`;
                const response = await callGemini(prompt, button);
                messageTextarea.value = response;
                button.innerHTML = originalText;
            });

            document.getElementById('promo-form').addEventListener('submit', e => {
                e.preventDefault();
                const data = new FormData(e.target);
                const selectedProductIds = Array.from(e.target.productIds.selectedOptions).map(opt => Number(opt.value));
                const promoData = {
                    name: data.get('name'),
                    discount: Number(data.get('discount')),
                    productIds: selectedProductIds,
                    promoMessage: data.get('promoMessage')
                };
                if (isEdit) {
                    Object.assign(db.promotions.find(promo => promo.id === id), promoData);
                } else {
                    db.counters.promotion++;
                    if (!db.promotions) db.promotions = [];
                    db.promotions.push({ id: db.counters.promotion, ...promoData });
                }
                saveDB();
                displayPromotions();
                closeModal();
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­.');
            });
        }
        function renderOrders() { const content = `<div class="bg-white p-4 rounded-lg shadow-lg mb-6"><input id="orders-search" type="text" class="p-2 border rounded-lg w-full" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨..."></div><div class="bg-white rounded-xl shadow-lg overflow-x-auto"><table class="min-w-full text-right"><thead class="bg-gray-50"><tr><th class="p-3">#</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="text-left">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="orders-table-body"></tbody></table></div>`; renderPage('page-orders', content, () => { document.getElementById('orders-search').addEventListener('input', displayOrders); displayOrders(); }); }
        function displayOrders() { const body = document.getElementById('orders-table-body'); if (!body) return; const searchTerm = document.getElementById('orders-search').value.toLowerCase(); const orders = getDB().orders.slice().reverse().filter(o => o.customerName.toLowerCase().includes(searchTerm) || o.id.toString().includes(searchTerm)); const statusColors = { pending: 'bg-yellow-100 text-yellow-800', in_progress: 'bg-blue-100 text-blue-800', awaiting_driver_confirmation: 'bg-cyan-100 text-cyan-800', out_for_delivery: 'bg-purple-100 text-purple-800', delivered: 'bg-green-100 text-green-800', cancelled: 'bg-red-100 text-red-800' }; const statusTexts = { pending: 'Ø¬Ø¯ÙŠØ¯', in_progress: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²', awaiting_driver_confirmation: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚', out_for_delivery: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„', delivered: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', cancelled: 'Ù…Ù„ØºÙŠ' }; body.innerHTML = orders.map(order => `<tr class="border-b"> <td class="p-3">${order.id}</td> <td class="p-3">${order.customerName}</td> <td class="p-3 font-mono">${order.total.toFixed(3)}</td> <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColors[order.status] || ''}">${statusTexts[order.status] || order.status}</span></td> <td class="p-3">${new Date(order.timestamp).toLocaleDateString()}</td> <td class="p-3 text-left"><button class="view-order-btn text-blue-500 font-semibold" data-id="${order.id}">Ø¹Ø±Ø¶</button></td> </tr>`).join(''); document.querySelectorAll('.view-order-btn').forEach(btn => btn.addEventListener('click', e => handleViewOrder(Number(e.target.dataset.id)))); }
        function handleViewOrder(orderId) { 
            const order = db.orders.find(o => o.id === orderId); 
            const trackingLink = `${window.location.origin}${window.location.pathname}#track=${order.trackingToken}`; 
            const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0); 
            const shipping = order.total - subtotal; 
            const driverOptions = db.drivers.map(d => `<option value="${d.id}" ${order.driverId === d.id ? 'selected' : ''}>${d.name}</option>`).join(''); 
            
            const chatHistory = (db.chats[orderId] || []).map(msg => {
                 let bubbleClass = 'bg-gray-100';
                 let senderName = msg.sender === 'customer' ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' : (msg.sender === 'driver' ? 'Ø§Ù„Ø³Ø§Ø¦Ù‚' : 'Ø§Ù„Ù…Ø¯ÙŠØ±');
                 if (msg.sender === 'admin') { bubbleClass = 'bg-purple-100' }
                 else if (msg.sender === 'customer') { bubbleClass = 'bg-green-100' }
                 else if (msg.sender === 'driver') { bubbleClass = 'bg-blue-100' }

                 return `<div class="p-2 rounded-lg ${bubbleClass} mb-2">
                    <p class="font-bold text-sm">${senderName}</p>
                    <p>${msg.text}</p>
                    <p class="text-xs text-gray-400 text-left">${timeAgo(msg.timestamp)}</p>
                </div>`
            }).join('');

            const content = `<div class="print-area"><div class="invoice-box"><table cellpadding="0" cellspacing="0"><tr class="top"><td colspan="3"><table><tr><td><img src="${logoUrl}" style="width:100%; max-width:150px;"></td><td style="text-align:left;"><b>ÙØ§ØªÙˆØ±Ø© #${order.id}</b><br><div id="qr-code-container" class="mt-2"></div></td></tr></table></td></tr><tr class="information"><td colspan="3"><table><tr><td><b>${db.settings.storeName}</b></td><td style="text-align:left;"><b>${order.customerName}</b><br>${order.customerPhone}<br>${order.customerAddress}</td></tr></table></td></tr><tr class="heading"><td>Ø§Ù„Ù…Ù†ØªØ¬</td><td style="text-align:center;">Ø§Ù„ÙƒÙ…ÙŠØ©</td><td style="text-align:left;">Ø§Ù„Ø³Ø¹Ø±</td></tr>${order.items.map(item => `<tr class="item"><td>${item.name}</td><td style="text-align:center;">${item.quantity}</td><td style="text-align:left;">${(item.price * item.quantity).toFixed(3)}</td></tr>`).join('')}<tr class="heading"><td colspan="2">Ø§Ù„Ù…Ù„Ø®Øµ</td><td></td></tr><tr><td colspan="2">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</td><td style="text-align:left;">${subtotal.toFixed(3)} Ø¯.Ùƒ</td></tr><tr><td colspan="2">ÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„</td><td style="text-align:left;">${shipping.toFixed(3)} Ø¯.Ùƒ</td></tr><tr class="total"><td></td><td colspan="2" style="text-align:left; font-weight: bold;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${order.total.toFixed(3)} Ø¯.Ùƒ</td></tr></table></div></div><div class="mt-4 no-print flex justify-between items-center bg-gray-100 p-3 rounded-lg"><p class="text-sm">Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹: <a href="${trackingLink}" target="_blank" class="text-blue-500 underline">Ø¹Ø±Ø¶</a></p><button id="copy-tracking-link" class="btn-primary btn-sm">Ù†Ø³Ø®</button></div><div class="mt-4 no-print"><h4 class="font-bold mb-2">ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h4><select id="update-status-select" class="p-2 border rounded">${Object.entries({ pending: 'Ø¬Ø¯ÙŠØ¯', in_progress: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²', awaiting_driver_confirmation: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚', out_for_delivery: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„', delivered: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', cancelled: 'Ù…Ù„ØºÙŠ' }).map(([k,v]) => `<option value="${k}" ${order.status === k ? 'selected' : ''}>${v}</option>`).join('')}</select><button id="save-status-btn" class="btn-primary mr-2 btn-sm">Ø­ÙØ¸</button></div><div class="mt-4 no-print"><label class="font-bold">ØªØ¹ÙŠÙŠÙ† Ø³Ø§Ø¦Ù‚:</label><div class="flex gap-2 mt-2"><select id="assign-driver-select" class="p-2 border rounded flex-1"><option value="">Ø§Ø®ØªØ± Ø³Ø§Ø¦Ù‚...</option>${driverOptions}</select><button id="assign-driver-btn" class="btn-primary btn-sm">ØªØ¹ÙŠÙŠÙ†</button></div></div><div class="mt-4 no-print"><h4 class="font-bold mb-2">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h4><div class="border rounded-lg p-2 h-40 overflow-y-auto bg-gray-50" id="admin-chat-history">${chatHistory || '<p class="text-gray-400 text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„.</p>'}</div><form id="admin-chat-form" class="flex gap-2 mt-2"><input id="admin-chat-input" class="flex-grow p-2 border rounded" placeholder="Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚..."><button type="submit" class="btn-primary btn-sm">Ø¥Ø±Ø³Ø§Ù„</button></form></div><div class="mt-6 flex items-center gap-4 no-print"><button id="print-receipt-btn" class="btn-primary">Ø·Ø¨Ø§Ø¹Ø©</button></div>`; 
            openModal(`ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ #${order.id}`, content, 'max-w-4xl'); 
            new QRCode(document.getElementById("qr-code-container"), { text: trackingLink, width: 80, height: 80 }); 
            document.getElementById('copy-tracking-link').addEventListener('click', () => { navigator.clipboard.writeText(trackingLink); showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!'); }); 
            document.getElementById('print-receipt-btn').addEventListener('click', () => window.print()); 
            
            document.getElementById('admin-chat-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('admin-chat-input');
                const text = input.value.trim();
                if (text) {
                    handleSendMessage(orderId, 'admin', text);
                    handleViewOrder(orderId);
                }
            });

            document.getElementById('save-status-btn').addEventListener('click', () => { 
                const oldStatus = order.status;
                const newStatus = document.getElementById('update-status-select').value; 
                if (oldStatus !== newStatus && newStatus === 'cancelled') {
                    if (oldStatus === 'in_progress' || oldStatus === 'out_for_delivery' || oldStatus === 'awaiting_driver_confirmation') {
                         order.items.forEach(item => {
                            const product = db.products.find(p => p.id === item.productId);
                            if (product) {
                                product.stock += item.quantity;
                            }
                        });
                        showToast('ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.');
                    }
                }
                order.status = newStatus; 
                saveDB(); 
                localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: newStatus, timestamp: Date.now() })); 
                displayOrders(); 
                handleViewOrder(orderId); 
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©'); 
            }); 
            const assignBtn = document.getElementById('assign-driver-btn'); 
            if(assignBtn) assignBtn.addEventListener('click', () => { 
                const driverId = Number(document.getElementById('assign-driver-select').value); 
                if(driverId) { 
                    order.driverId = driverId; 
                    if(order.status === 'in_progress' || order.status === 'pending') {
                        order.status = 'awaiting_driver_confirmation';
                    }
                    saveDB(); 
                    localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: order.status, timestamp: Date.now() })); 
                    displayOrders(); 
                    handleViewOrder(orderId); 
                    showToast('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚'); 
                } else { 
                    showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚', 'error'); 
                } 
            }); 
        }

        function renderCustomers() { const content = `<div class="flex flex-col md:flex-row justify-between items-center mb-6"><h2 class="text-2xl font-bold">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2><div class="mt-4 md:mt-0"><button id="send-bulk-msg-btn" class="btn-primary bg-sky-500 hover:bg-sky-600 mr-2">Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</button><button id="export-customers-btn" class="btn-primary bg-green-600 hover:bg-green-700">ØªØµØ¯ÙŠØ± Excel</button></div></div><div class="mb-4"><input id="customers-search" type="text" class="w-full p-3 border rounded-lg" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù…Ù‡..."></div><div class="bg-white rounded-xl shadow-lg overflow-x-auto"><table class="min-w-full text-right"><thead class="bg-gray-50"><tr><th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="customers-table-body"></tbody></table></div>`; renderPage('page-customers', content, () => { document.getElementById('customers-search').addEventListener('input', displayCustomers); document.getElementById('send-bulk-msg-btn').addEventListener('click', handleBulkMessage); document.getElementById('export-customers-btn').addEventListener('click', exportCustomersToExcel); displayCustomers(); }); }
        function displayCustomers() { const body = document.getElementById('customers-table-body'); if (!body) return; const searchTerm = document.getElementById('customers-search').value.toLowerCase(); const customers = getDB().customers.filter(c => c.name.toLowerCase().includes(searchTerm) || c.phone.includes(searchTerm)); body.innerHTML = customers.map(c => `<tr class="border-b"><td class="p-3">${c.name}</td><td>${c.phone}</td><td>${c.points || 0}</td><td><button class="view-customer-btn text-blue-500" data-id="${c.id}">Ø¹Ø±Ø¶</button></td></tr>`).join(''); document.querySelectorAll('.view-customer-btn').forEach(btn => btn.addEventListener('click', e => handleViewCustomer(Number(e.target.dataset.id)))); }
        function handleViewCustomer(customerId) {
            const customer = db.customers.find(c => c.id === customerId);
            const customerOrders = db.orders.filter(o => o.customerId === customerId).slice().reverse();
            const content = `<div class="space-y-4">
                <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${customer.name}</p>
                <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${customer.phone}</p>
                <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${customer.address}</p>
                <p><strong>Ø§Ù„Ù†Ù‚Ø§Ø·:</strong> ${customer.points || 0}</p>
                <div class="mt-4 pt-4 border-t">
                    <button id="gemini-customer-analysis-btn" class="w-full btn-primary bg-gradient-to-r from-teal-500 to-cyan-500">âœ¨ ØªØ­Ù„ÙŠÙ„ Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                    <div id="customer-analysis-result" class="mt-4 p-4 bg-gray-50 rounded-lg text-sm hidden"></div>
                </div>
                <h4 class="font-bold mt-4 border-t pt-2">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
                <div class="max-h-60 overflow-y-auto">${customerOrders.map(o => `<div class="p-2 border-b">#${o.id} - ${o.total.toFixed(3)} Ø¯.Ùƒ - ${new Date(o.timestamp).toLocaleDateString()}</div>`).join('') || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</p>'}</div>
            </div>`;
            openModal(`ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customer.name}`, content);

            document.getElementById('gemini-customer-analysis-btn').addEventListener('click', async (e) => {
                const button = e.target;
                const resultContainer = document.getElementById('customer-analysis-result');
                const originalText = button.innerHTML;
                
                const orderHistory = customerOrders.map(o => ({
                    date: new Date(o.timestamp).toLocaleDateString(),
                    total: o.total,
                    items: o.items.map(i => `${i.name} (x${i.quantity})`).join(', ')
                }));

                if (orderHistory.length === 0) {
                    showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§Øª Ù„ØªØ­Ù„ÙŠÙ„Ù‡.", "error");
                    return;
                }

                const prompt = `Ø­Ù„Ù„ Ø³Ù„ÙˆÙƒ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù„Ø¹Ù…ÙŠÙ„ "${customer.name}" Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠ: ${JSON.stringify(orderHistory)}. Ù‚Ø¯Ù… Ù…Ù„Ø®ØµØ§Ù‹ Ù…ÙˆØ¬Ø²Ø§Ù‹ Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ø¯ÙŠÙ‡ØŒ ÙˆÙ…Ø¹Ø¯Ù„ Ø¥Ù†ÙØ§Ù‚Ù‡ØŒ Ø«Ù… Ø§Ù‚ØªØ±Ø­ Ø¹Ø±Ø¶Ø§Ù‹ ØªØ±ÙˆÙŠØ¬ÙŠØ§Ù‹ Ù…Ø®ØµØµØ§Ù‹ Ù„Ù‡. Ø§Ø³ØªØ®Ø¯Ù… ØªÙ†Ø³ÙŠÙ‚ Markdown.`;

                resultContainer.innerHTML = `<p class="text-center"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p>`;
                resultContainer.classList.remove('hidden');

                const response = await callGemini(prompt, button);
                resultContainer.innerHTML = marked.parse(response);
                button.innerHTML = originalText;
            });
        }
        function exportCustomersToExcel() { const ws = XLSX.utils.json_to_sheet(db.customers); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Customers"); XLSX.writeFile(wb, "customers_export.xlsx"); }
        function handleBulkMessage() { const customerOptions = db.customers.filter(c => c.phone).map(c => `<option value="${c.id}">${c.name} (${c.phone})</option>`).join(''); const formContent = `<form id="bulk-msg-form" class="space-y-4"><div><label class="block mb-2">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ÙƒÙ„)</label><select name="customerIds" class="w-full p-2 border rounded" multiple>${customerOptions}</select></div><div><label class="block mb-2">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø§Ø³ØªØ®Ø¯Ù… {name} Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„)</label><textarea name="message" class="w-full p-2 border rounded" rows="5" required>Ù…Ø±Ø­Ø¨Ø§Ù‹ {name}ØŒ ...</textarea></div><button type="submit" class="w-full btn-primary">ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</button></form><div id="whatsapp-links-container" class="mt-4 hidden"></div>`; openModal('Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¬Ù…Ø§Ø¹ÙŠØ©', formContent); document.getElementById('bulk-msg-form').addEventListener('submit', e => { e.preventDefault(); const form = e.target; const messageTemplate = form.message.value; const selectedIds = Array.from(form.customerIds.selectedOptions).map(opt => Number(opt.value)); const targetCustomers = selectedIds.length > 0 ? db.customers.filter(c => selectedIds.includes(c.id)) : db.customers.filter(c => c.phone); const linksHtml = targetCustomers.map(c => { const personalizedMsg = encodeURIComponent(messageTemplate.replace(/{name}/g, c.name)); const url = `https://api.whatsapp.com/send?phone=${c.phone}&text=${personalizedMsg}`; return `<a href="${url}" target="_blank" class="block bg-gray-100 p-2 rounded hover:bg-blue-100">${c.name}</a>`; }).join(''); const container = document.getElementById('whatsapp-links-container'); container.innerHTML = `<h4 class="font-bold mb-2">Ø±ÙˆØ§Ø¨Ø· Ø¬Ø§Ù‡Ø²Ø© (${targetCustomers.length})</h4><div class="space-y-2 max-h-60 overflow-y-auto">${linksHtml}</div>`; container.classList.remove('hidden'); }); }
        function renderFinance() { const deliveredOrders = db.orders.filter(o => o.status === 'delivered'); const totalRevenue = deliveredOrders.reduce((sum, o) => sum + o.total, 0); const totalExpenses = (db.expenses || []).reduce((sum, e) => sum + e.amount, 0); const netProfit = totalRevenue - totalExpenses; const content = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="p-5 rounded-lg shadow-lg text-center bg-white"><p class="text-3xl font-bold text-green-500">${totalRevenue.toFixed(3)}</p><p class="mt-2 text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</p></div><div class="p-5 rounded-lg shadow-lg text-center bg-white"><p class="text-3xl font-bold text-red-500">${totalExpenses.toFixed(3)}</p><p class="mt-2 text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p></div><div class="p-5 rounded-lg shadow-lg text-center bg-white"><p class="text-3xl font-bold ${netProfit >= 0 ? 'text-blue-500' : 'text-orange-500'}">${netProfit.toFixed(3)}</p><p class="mt-2 text-gray-600">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-5 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3><button id="add-expense-btn" class="btn-primary btn-sm">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button></div><div class="overflow-x-auto max-h-96"><table class="w-full text-right"><tbody>${(db.expenses || []).length > 0 ? db.expenses.slice().reverse().map(e => `<tr class="border-b"><td class="p-2">${e.date}</td><td class="p-2">${e.description}</td><td class="p-2 font-mono">${e.amount.toFixed(3)}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª.</td></tr>`}</tbody></table></div></div><div class="bg-white p-5 rounded-lg shadow-lg"><h3 class="font-bold text-xl mb-4">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3><div class="overflow-x-auto max-h-96"><table class="w-full text-right"><tbody>${deliveredOrders.length > 0 ? deliveredOrders.slice().reverse().map(o => `<tr class="border-b"><td class="p-2">#${o.id}</td><td class="p-2">${new Date(o.timestamp).toLocaleDateString()}</td><td class="p-2 font-mono">${o.total.toFixed(3)}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª.</td></tr>`}</tbody></table></div></div></div>`; renderPage('page-finance', content, () => { document.getElementById('add-expense-btn').addEventListener('click', handleAddExpense); }); }
        function handleAddExpense() { const today = new Date().toISOString().slice(0, 10); const formContent = `<form id="expense-form" class="space-y-4"><input name="description" class="p-2 border rounded w-full" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ØµØ±ÙˆÙ" required><div class="grid md:grid-cols-2 gap-4"><input name="amount" type="number" step="0.001" class="p-2 border rounded w-full" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" required><input name="date" type="date" class="p-2 border rounded w-full" value="${today}" required></div><button type="submit" class="w-full btn-primary py-2 mt-2">Ø¥Ø¶Ø§ÙØ©</button></form>`; openModal('Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯', formContent); document.getElementById('expense-form').addEventListener('submit', (e) => { e.preventDefault(); const form = e.target; db.counters.expense++; const newExpense = { id: db.counters.expense, description: form.description.value, amount: Number(form.amount.value), date: form.date.value }; if(!db.expenses) db.expenses = []; db.expenses.push(newExpense); saveDB(); renderFinance(); closeModal(); showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ'); }); }
        function renderAnalytics() { const content = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-4 rounded-lg shadow-lg"><h3 class="font-bold text-lg mb-4">Ù…Ø¨ÙŠØ¹Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</h3><canvas id="salesChart"></canvas></div><div class="bg-white p-4 rounded-lg shadow-lg"><h3 class="font-bold text-lg mb-4">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ù‹Ø§</h3><div id="topProductsList"></div></div></div>`; renderPage('page-analytics', content, () => { const salesCtx = document.getElementById('salesChart')?.getContext('2d'); if(salesCtx) { const salesData = { labels: [], datasets: [{ label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¯.Ùƒ)', data: [], backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: '#3b82f6', borderWidth: 1 }] }; for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); salesData.labels.push(d.toLocaleDateString('ar-EG', { weekday: 'short' })); const dailySales = db.orders.filter(o => new Date(o.timestamp).toDateString() === d.toDateString() && o.status === 'delivered').reduce((sum, o) => sum + o.total, 0); salesData.datasets[0].data.push(dailySales); } new Chart(salesCtx, { type: 'bar', data: salesData, options: { scales: { y: { beginAtZero: true } } } }); } const productSales = {}; db.orders.forEach(o => o.items.forEach(i => productSales[i.name] = (productSales[i.name] || 0) + i.quantity)); const topProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]).slice(0,5); document.getElementById('topProductsList').innerHTML = topProducts.map(([name, qty]) => `<div class="flex justify-between items-center p-2 border-b"><span class="font-semibold">${name}</span><span class="font-bold">${qty}</span></div>`).join(''); }); }
        function renderSettings() { const settings = getDB().settings; const content = `<div class="space-y-8 max-w-3xl mx-auto"><div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-bold mb-4 border-b pb-2">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</h3><form id="store-settings-form" class="space-y-4"><label class="block">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label> <input name="storeName" type="text" value="${settings.storeName}" class="w-full p-3 border rounded-lg"><label class="block">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label> <input name="whatsappNumber" type="text" value="${settings.whatsappNumber}" class="w-full p-3 border rounded-lg"><label class="block">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¯.Ùƒ)</label> <input name="shippingFee" type="number" step="0.001" value="${settings.shippingFee}" class="w-full p-3 border rounded-lg"><label class="block">Ø§Ù„Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ Ø¯ÙŠÙ†Ø§Ø±</label> <input name="pointsPerKWD" type="number" value="${settings.pointsPerKWD}" class="w-full p-3 border rounded-lg"><button type="submit" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button></form></div><div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-bold mb-4 border-b pb-2">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3><div class="flex gap-4"><button id="backup-btn" class="flex-1 btn-primary bg-blue-600">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button><button id="restore-btn" class="flex-1 btn-primary bg-green-600">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button><input type="file" id="restore-input" class="hidden" accept=".json"></div></div></div>`; renderPage('page-settings', content, () => { document.getElementById('store-settings-form').addEventListener('submit', (e) => { e.preventDefault(); db.settings.storeName = e.target.storeName.value; db.settings.whatsappNumber = e.target.whatsappNumber.value; db.settings.shippingFee = Number(e.target.shippingFee.value); db.settings.pointsPerKWD = Number(e.target.pointsPerKWD.value); saveDB(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.'); }); document.getElementById('backup-btn').addEventListener('click', () => { const dataStr = JSON.stringify(getDB()); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = 'baqaltak_backup.json'; link.click(); URL.revokeObjectURL(url); }); document.getElementById('restore-btn').addEventListener('click', () => document.getElementById('restore-input').click()); document.getElementById('restore-input').addEventListener('change', (e) => { const file = e.target.files[0]; if(!file || !confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) return; const reader = new FileReader(); reader.onload = (event) => { try { db = JSON.parse(event.target.result); saveDB(); showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!'); location.reload(); } catch(err) { showToast('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.', 'error'); }}; reader.readAsText(file); }); }); }
        
        function renderDrivers() {
            const drivers = db.drivers;
            const getStarRating = (rating) => {
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    stars += `<i class="fa-solid fa-star ${i <= rating ? 'text-yellow-400' : 'text-gray-300'}"></i>`;
                }
                return stars;
            };

            const content = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h2>
                    <button id="add-driver-btn" class="btn-primary">Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="drivers-list">
                    ${drivers.map(d => {
                        const driverOrders = db.orders.filter(o => o.driverId === d.id && o.status === 'delivered');
                        const completedOrdersCount = driverOrders.length;
                        const ratings = driverOrders.map(o => o.rating?.driver).filter(Boolean);
                        const averageRating = ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : 0;
                        
                        return `<div class="bg-white rounded-lg shadow p-5 flex flex-col">
                            <h3 class="text-xl font-bold">${d.name}</h3>
                            <p class="text-gray-500">${d.phone}</p>
                            <div class="my-4">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-semibold">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</span>
                                    <span class="flex items-center gap-1">${getStarRating(averageRating)} (${averageRating.toFixed(1)})</span>
                                </div>
                                <div class="flex justify-between items-center text-sm mt-2">
                                    <span class="font-semibold">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©:</span>
                                    <span class="font-bold">${completedOrdersCount}</span>
                                </div>
                            </div>
                            <button class="edit-driver-btn mt-auto w-full btn-primary btn-sm bg-gray-200 text-gray-800 hover:bg-gray-300" data-id="${d.id}">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>`;
                    }).join('')}
                </div>`;
            renderPage('page-drivers', content, () => {
                document.getElementById('add-driver-btn').addEventListener('click', () => handleAddEditDriver());
                document.querySelectorAll('.edit-driver-btn').forEach(b => b.addEventListener('click', e => handleAddEditDriver(Number(e.currentTarget.dataset.id))));
            });
        }
        
        function handleAddEditDriver(id = null) {
            const isEdit = id !== null;
            const d = isEdit ? db.drivers.find(dr => dr.id === id) : {};
            const form = `<form id="driver-form" class="space-y-4">
                <input name="name" value="${d.name||''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚" required class="p-2 border rounded w-full">
                <input name="phone" value="${d.phone||''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required type="tel" class="p-2 border rounded w-full">
                <input name="pin" value="${d.pin||''}" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)" required class="p-2 border rounded w-full">
                <button type="submit" class="btn-primary w-full">${isEdit ? 'Ø­ÙØ¸' : 'Ø¥Ø¶Ø§ÙØ©'}</button>
            </form>`;
            openModal(isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø³Ø§Ø¦Ù‚' : 'Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚', form);
            document.getElementById('driver-form').addEventListener('submit', e => {
                e.preventDefault();
                const data = new FormData(e.target);
                const driverData = { name: data.get('name'), phone: data.get('phone'), pin: data.get('pin'), location: d.location || db.settings.storeLocation };
                if (isEdit) {
                    Object.assign(db.drivers.find(dr => dr.id === id), driverData);
                } else {
                    db.counters.driver++;
                    db.drivers.push({ id: db.counters.driver, ...driverData });
                }
                saveDB();
                renderDrivers();
                closeModal();
                showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚.');
            });
        }

        function renderReturns() {
            const returns = db.returns;
            const content = `
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</h2>
                    ${returns.length > 0 ? returns.map(r => `<div class="p-2 border-b">Ø·Ù„Ø¨ #${r.orderId} - ${r.reason}</div>`).join('') : '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª.</p>'}
                </div>`;
            renderPage('page-returns', content);
        }

        // ----------------- INITIALIZATION -----------------
        function init() {
            loadDB();
            
            document.querySelectorAll('#logo-selection, #logo-sidebar').forEach(el => el.src = logoUrl);
            
            const selectionView = document.getElementById('selection-view');
            const customerView = document.getElementById('customer-view');
            const passwordOverlay = document.getElementById('password-overlay');

            const themeToggle = document.getElementById('theme-toggle-admin');
            const setTheme = (theme) => { 
                localStorage.setItem('theme', theme); 
                document.body.className = theme + '-mode'; 
                if(themeToggle) {
                    themeToggle.checked = theme === 'dark';
                    const dot = themeToggle.nextElementSibling.nextElementSibling;
                    if (dot) {
                        if (theme === 'dark') { dot.style.transform = 'translateX(100%)'; } else { dot.style.transform = 'translateX(0)'; }
                    }
                }
            };

            if(themeToggle) {
                themeToggle.addEventListener('change', () => setTheme(themeToggle.checked ? 'dark' : 'light'));
            }
            setTheme(localStorage.getItem('theme') || 'light');
            
            document.getElementById('customer-btn').addEventListener('click', () => { selectionView.style.display = 'none'; customerView.style.display = 'block'; renderPublicView(); });
            document.getElementById('admin-btn').addEventListener('click', () => { selectionView.style.display = 'none'; renderLoginOverlay('admin'); });
            document.getElementById('driver-btn').addEventListener('click', () => { selectionView.style.display = 'none'; renderLoginOverlay('driver'); });
            
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            const sidebar = document.getElementById('sidebar'); 
            const sidebarOverlay = document.getElementById('sidebar-overlay'); 
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const toggleSidebar = () => { sidebar.classList.toggle('translate-x-full'); sidebarOverlay.classList.toggle('hidden'); };
            if(hamburgerBtn) hamburgerBtn.addEventListener('click', toggleSidebar);
            if(sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);

            window.addEventListener('hashchange', handleHashChange);
            window.addEventListener('storage', globalStorageListener);
            
            const sessionUser = sessionStorage.getItem('currentUser');
            if (sessionUser) {
                try {
                    currentUser = JSON.parse(sessionUser);
                    handleHashChange();
                } catch(e) {
                    selectionView.style.display = 'flex';
                }
            } else {
                const initialHash = window.location.hash.substring(1);
                if (initialHash.startsWith('track=')) {
                    selectionView.style.display = 'none';
                    customerView.style.display = 'block';
                    renderOrderTrackingPage(initialHash.substring(6));
                } else {
                    selectionView.style.display = 'flex';
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
