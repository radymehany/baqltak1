<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بقالتك - النظام المتكامل والجاهز للعمل</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- Google Maps API Script - REPLACE 'YOUR_GOOGLE_MAPS_API_KEY' -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places,geometry"></script>


    <style>
        body { font-family: 'Cairo', sans-serif; }
        .view { display: none; }
        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        .customer-page { display: none; }
        .customer-page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-primary { font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: all 0.3s; cursor: pointer; }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }

        /* --- Light Mode --- */
        body.light-mode { background-color: #f1f5f9; color: #1e293b; }
        .light-mode .sidebar { background-color: #ffffff; }
        .light-mode .nav-link.active, .light-mode .bottom-nav-link.active { background-color: #3b82f6; color: white; }
        .light-mode .modal-content { background-color: #ffffff; }
        .light-mode .btn-primary { background-color: #3b82f6; color: white; }
        .light-mode .order-column, .light-mode .portal-bg { background-color: #f9fafb; }
        .light-mode .order-card { background-color: white; }
        .light-mode .customer-view-bg { background-color: #f7fafc; }
        .light-mode .customer-bottom-nav a { color: #6b7280; }
        .light-mode .customer-bottom-nav a.active { color: #ea580c; }


        /* --- Dark Mode --- */
        body.dark-mode { background-color: #0f172a; color: #e2e8f0; }
        body.dark-mode .sidebar { background-color: #1e293b; }
        body.dark-mode .nav-link.active, body.dark-mode .bottom-nav-link.active { background-color: #3b82f6; color: white; }
        body.dark-mode .modal-content { background-color: #1e293b; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background-color: #334155; border-color: #4b5563; }
        body.dark-mode .bg-white { background-color: #1e293b; }
        body.dark-mode .bg-gray-50, body.dark-mode .bg-gray-100, body.dark-mode .bg-gray-200 { background-color: #1f2937; }
        body.dark-mode .text-gray-500 { color: #9ca3af; }
        body.dark-mode .text-gray-600 { color: #d1d5db; }
        body.dark-mode .border, body.dark-mode .border-b, body.dark-mode .border-t { border-color: #374151; }
        body.dark-mode .order-column, body.dark-mode .portal-bg { background-color: #1f2937; }
        body.dark-mode .order-card { background-color: #374151; }
        body.dark-mode .customer-view-bg { background-color: #1a202c; }
        body.dark-mode .customer-bottom-nav { background-color: #1e293b; border-top-color: #374151; }
        body.dark-mode .customer-bottom-nav a { color: #9ca3af; }
        body.dark-mode .customer-bottom-nav a.active { color: #fb923c; }


        .category-filters-container::-webkit-scrollbar { display: none; }
        .category-filters-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- Tracking Steps CSS (FIX) --- */
        .step-item { display: flex; flex-direction: column; align-items: center; position: relative; color: #9ca3af; transition: all 0.5s ease; }
        .step-icon-wrapper { width: 60px; height: 60px; border-radius: 50%; background-color: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s ease; border: 4px solid #f1f5f9; }
        .step-label { font-weight: 600; margin-top: 0.5rem; font-size: 0.875rem; text-align: center; }
        .step-connector { border-style: dashed; transition: border-color 0.3s ease; border-color: #e5e7eb; }
        .step-item.completed .step-icon-wrapper { background-color: #22c55e !important; color: white !important; }
        .step-item.completed .step-label { color: #1e293b !important; }
        .step-item.active .step-icon-wrapper { background-color: #3b82f6 !important; color: white !important; transform: scale(1.1); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3); }
        .step-item.active .step-label { color: #3b82f6 !important; }
        .step-connector.completed { border-style: solid !important; border-color: #22c55e !important; }
        body.dark-mode .step-item.completed .step-label { color: #e2e8f0 !important; }
        body.dark-mode .step-icon-wrapper { border-color: #0f172a; }

        /* Rating Stars */
        .rating .fa-star { color: #e5e7eb; cursor: pointer; transition: color 0.2s; }
        .rating .fa-star.selected, .rating:hover .fa-star:hover, .rating .fa-star:hover ~ .fa-star { color: #f59e0b !important; }

        .invoice-box { max-width: 800px; margin: auto; padding: 30px; border: 1px solid #eee; box-shadow: 0 0 10px rgba(0, 0, 0, 0.15); font-size: 16px; line-height: 24px; color: #555; background: white; }
        .invoice-box table { width: 100%; line-height: inherit; text-align: right; }
        .invoice-box table td { padding: 5px; vertical-align: top; }
        .invoice-box table tr.heading td { background: #eee; border-bottom: 1px solid #ddd; font-weight: bold; }
        
        @keyframes bell-ring { 0% { transform: rotate(0); } 15% { transform: rotate(15deg); } 30% { transform: rotate(-15deg); } 45% { transform: rotate(10deg); } 60% { transform: rotate(-10deg); } 75% { transform: rotate(5deg); } 85% { transform: rotate(-5deg); } 100% { transform: rotate(0); } }
        .notification-bell.active { animation: bell-ring 0.8s ease-in-out; }

        .map-container { height: 250px; width: 100%; border-radius: 0.5rem; background-color: #e5e7eb; }
        .dashboard-map-container { height: 75vh; width: 100%; border-radius: 0.5rem; background-color: #e5e7eb; }


        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="light-mode">
    <div id="root-container">
        <!-- SELECTION VIEW -->
        <div id="selection-view" class="view flex flex-col items-center justify-center h-screen p-4">
            <div class="p-8 md:p-12 rounded-lg shadow-2xl text-center w-full max-w-md bg-white">
                <img id="logo-selection" src="" alt="Logo" class="max-w-[180px] h-auto mx-auto mb-6">
                <h1 class="text-3xl font-bold mb-6">أهلاً بك في بقالتك</h1>
                <div class="space-y-4">
                    <button id="customer-btn" class="w-full btn-primary bg-green-600 hover:bg-green-700 text-lg">تصفح المنتجات (عميل)</button>
                    <button id="admin-btn" class="w-full btn-primary text-lg">دخول لوحة التحكم (مدير)</button>
                    <button id="driver-btn" class="w-full btn-primary bg-orange-500 hover:bg-orange-600 text-lg">دخول بوابة السائق</button>
                </div>
            </div>
        </div>
        
        <!-- PASSWORD OVERLAY -->
        <div id="password-overlay" class="view fixed inset-0 bg-gray-900 bg-opacity-75 flex-col items-center justify-center z-50 p-4"></div>
        
        <!-- ADMIN APP CONTAINER -->
        <div id="app-container" class="view">
            <div class="relative min-h-screen md:flex">
                <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
                <aside id="sidebar" class="sidebar fixed top-0 right-0 h-full w-64 p-4 shadow-2xl flex flex-col z-30 transform translate-x-full transition-transform duration-300 md:relative md:translate-x-0">
                     <div class="text-center mb-4"><img id="logo-sidebar" src="" alt="Logo" class="max-w-[180px] h-auto mx-auto"></div>
                    <div class="mb-4 text-center">
                         <label for="theme-toggle-admin" class="flex items-center justify-center cursor-pointer">
                            <i class="fa-solid fa-moon text-yellow-400"></i>
                            <div class="relative mx-2"><input type="checkbox" id="theme-toggle-admin" class="sr-only"><div class="block bg-gray-600 w-10 h-6 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div></div>
                            <i class="fa-solid fa-sun text-yellow-400"></i>
                        </label>
                    </div>
                    <nav class="flex-grow">
                        <a href="#dashboard" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-tachometer-alt w-8 text-center"></i>لوحة التحكم</a>
                        <a href="#analytics" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-chart-pie w-8 text-center"></i>التحليلات</a>
                        <a href="#finance" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-file-invoice-dollar w-8 text-center"></i>الإدارة المالية</a>
                        <a href="#orders" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-receipt w-8 text-center"></i>إدارة الطلبات</a>
                        <a href="#inventory" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-boxes-stacked w-8 text-center"></i>إدارة المخزون</a>
                        <a href="#promotions" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-tags w-8 text-center"></i>إدارة العروض</a>
                        <a href="#returns" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-undo w-8 text-center"></i>إدارة المرتجعات</a>
                        <a href="#customers" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-users w-8 text-center"></i>إدارة العملاء</a>
                        <a href="#drivers" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-motorcycle w-8 text-center"></i>إدارة السائقين</a>
                        <a href="#settings" class="nav-link flex items-center p-3 my-2 rounded-lg font-bold transition-all"><i class="fa-solid fa-cog w-8 text-center"></i>الإعدادات</a>
                    </nav>
                    <div class="mt-auto"><button id="logout-btn" class="w-full bg-red-500 bg-opacity-20 hover:bg-red-500 hover:text-white font-bold py-2 px-4 rounded-lg"><i class="fa-solid fa-right-from-bracket mr-2"></i>تسجيل الخروج</button></div>
                </aside>
                <main id="admin-main" class="flex-1 p-4 md:p-10 overflow-y-auto pb-20 md:pb-10">
                    <header class="p-4 mb-6 flex justify-between items-center md:hidden no-print bg-white rounded-lg shadow-lg">
                        <h2 id="page-title-mobile" class="text-xl font-bold"></h2>
                        <button id="hamburger-btn" class="text-2xl"><i class="fa-solid fa-bars"></i></button>
                    </header>
                    <header class="hidden md:flex shadow-lg rounded-lg p-4 mb-6 justify-between items-center no-print bg-white">
                        <h2 id="page-title" class="text-2xl md:text-3xl font-bold"></h2>
                        <p>مرحباً, <strong id="current-user-name" class="text-blue-500"></strong></p>
                    </header>
                    <div id="page-dashboard" class="page"></div><div id="page-analytics" class="page"></div><div id="page-finance" class="page"></div><div id="page-orders" class="page"></div><div id="page-inventory" class="page"></div><div id="page-promotions" class="page"></div><div id="page-returns" class="page"></div><div id="page-customers" class="page"></div><div id="page-drivers" class="page"></div><div id="page-settings" class="page"></div>
                </main>
                <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-t-lg flex justify-around p-2 border-t z-10">
                    <a href="#dashboard" class="bottom-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center"><i class="fa-solid fa-tachometer-alt text-xl"></i><span class="text-xs mt-1">الرئيسية</span></a>
                    <a href="#orders" class="bottom-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center"><i class="fa-solid fa-receipt text-xl"></i><span class="text-xs mt-1">الطلبات</span></a>
                    <a href="#inventory" class="bottom-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center"><i class="fa-solid fa-boxes-stacked text-xl"></i><span class="text-xs mt-1">المخزون</span></a>
                    <a href="#drivers" class="bottom-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center"><i class="fa-solid fa-motorcycle text-xl"></i><span class="text-xs mt-1">السائقين</span></a>
                </nav>
            </div>
        </div>
        
        <!-- CUSTOMER VIEW -->
        <div id="customer-view" class="view customer-view-bg min-h-screen pb-24"></div>

        <!-- DRIVER PORTAL VIEW -->
        <div id="driver-portal-view" class="view portal-bg min-h-screen"></div>

    </div>
    
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-[101] space-y-2"></div>

    <script type="module">
        const DB_NAME = 'Baqaltak_v53_DATA';
        const STATUS_EVENT_KEY = 'BAQALTAK_STATUS_EVENT';
        const CHAT_EVENT_KEY = 'BAQALTAK_CHAT_EVENT';
        let db = {};
        const logoUrl = "https://d.top4top.io/p_3489e11m01.png";
        let currentUser = null; // Can be 'admin' or 'driver'
        let cart = {};
        let driverIntervals = {}; // To store simulation intervals for maps
        let mapInstances = {}; // To store initialized map objects

        // ----------------- GEMINI API FUNCTION -----------------
        async function callGemini(prompt, buttonElement) {
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> جاري التفكير...`;
            }
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected response structure:", result);
                    return "لم أتمكن من إنشاء رد. الرجاء المحاولة مرة أخرى.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "حدث خطأ أثناء الاتصال بالذكاء الاصطناعي.";
            } finally {
                if (buttonElement) { buttonElement.disabled = false; }
            }
        }

        // ----------------- DATABASE FUNCTIONS -----------------
        function loadDB() {
            const data = localStorage.getItem(DB_NAME);
            const cartData = localStorage.getItem(DB_NAME + '_Cart');
            const defaultDB = {
                products: [
                    // فواكه
                    { id: 1, name: 'تفاح أحمر (كيلو)', description: 'تفاح أحمر طازج ومقرمش.', sku: 'FR001', category: 'فواكه', price: 0.750, stock: 50, lowStockThreshold: 10, isFeatured: true, iconClass: 'fa-solid fa-apple-whole' },
                    { id: 2, name: 'موز (كيلو)', description: 'موز طازج غني بالبوتاسيوم.', sku: 'FR002', category: 'فواكه', price: 0.600, stock: 80, lowStockThreshold: 15, isFeatured: true, iconClass: 'fa-solid fa-bacon' }, // Note: No perfect banana icon
                    { id: 3, name: 'برتقال (كيلو)', description: 'برتقال عصيري غني بفيتامين سي.', sku: 'FR003', category: 'فواكه', price: 0.500, stock: 60, lowStockThreshold: 10, isFeatured: false, iconClass: 'fa-solid fa-lemon' },
                    // خضروات
                    { id: 4, name: 'طماطم (كيلو)', description: 'طماطم حمراء طازجة للسلطات والطبخ.', sku: 'VE001', category: 'خضروات', price: 0.400, stock: 100, lowStockThreshold: 20, isFeatured: true, iconClass: 'fa-solid fa-carrot' },
                    { id: 5, name: 'خيار (كيلو)', description: 'خيار طازج ومقرمش.', sku: 'VE002', category: 'خضروات', price: 0.350, stock: 120, lowStockThreshold: 25, isFeatured: false, iconClass: 'fa-solid fa-seedling' },
                    { id: 6, name: 'بطاطس (كيس)', description: 'كيس بطاطس للقلي أو الطبخ.', sku: 'VE003', category: 'خضروات', price: 0.800, stock: 70, lowStockThreshold: 15, isFeatured: false, iconClass: 'fa-solid fa-pepper-hot' },
                    // مخبوزات
                    { id: 7, name: 'خبز لبناني (كيس)', description: 'كيس خبز لبناني طازج.', sku: 'BK001', category: 'مخبوزات', price: 0.100, stock: 150, lowStockThreshold: 30, isFeatured: true, iconClass: 'fa-solid fa-bread-slice' },
                    { id: 8, name: 'صمون (كيس 6 حبات)', description: 'صمون طري للساندويتشات.', sku: 'BK002', category: 'مخبوزات', price: 0.200, stock: 100, lowStockThreshold: 20, isFeatured: false, iconClass: 'fa-solid fa-hotdog' },
                    // ألبان وبيض
                    { id: 9, name: 'حليب المراعي كامل الدسم (1 لتر)', description: 'حليب طازج كامل الدسم.', sku: 'DA001', category: 'ألبان وبيض', price: 0.450, stock: 90, lowStockThreshold: 15, isFeatured: true, iconClass: 'fa-solid fa-cow' },
                    { id: 10, name: 'بيض (طبق 30 حبة)', description: 'طبق بيض طازج.', sku: 'DA002', category: 'ألبان وبيض', price: 1.250, stock: 50, lowStockThreshold: 10, isFeatured: false, iconClass: 'fa-solid fa-egg' },
                    { id: 11, name: 'زبادي (روب) المراعي', description: 'زبادي طازج.', sku: 'DA003', category: 'ألبان وبيض', price: 0.100, stock: 200, lowStockThreshold: 40, isFeatured: false, iconClass: 'fa-solid fa-ice-cream' },
                    // لحوم ودواجن
                    { id: 12, name: 'دجاج ساديا مجمد (1000 جم)', description: 'دجاجة كاملة مجمدة.', sku: 'ME001', category: 'لحوم ودواجن', price: 1.100, stock: 40, lowStockThreshold: 10, isFeatured: false, iconClass: 'fa-solid fa-drumstick-bite' },
                    // مشروبات
                    { id: 13, name: 'مياه معدنية (كرتون 12 حبة)', description: 'كرتون مياه معدنية.', sku: 'BE001', category: 'مشروبات', price: 0.750, stock: 100, lowStockThreshold: 20, isFeatured: false, iconClass: 'fa-solid fa-bottle-water' },
                    { id: 14, name: 'بيبسي (علبة)', description: 'مشروب غازي.', sku: 'BE002', category: 'مشروبات', price: 0.100, stock: 300, lowStockThreshold: 50, isFeatured: false, iconClass: 'fa-solid fa-martini-glass-citrus' },
                    { id: 15, name: 'عصير برتقال كي دي دي (180 مل)', description: 'عصير برتقال طبيعي.', sku: 'BE003', category: 'مشروبات', price: 0.125, stock: 150, lowStockThreshold: 30, isFeatured: false, iconClass: 'fa-solid fa-glass-water' },
                    // معلبات
                    { id: 16, name: 'تونة (علبة)', description: 'تونة معلبة بالزيت.', sku: 'CA001', category: 'معلبات', price: 0.350, stock: 80, lowStockThreshold: 15, isFeatured: false, iconClass: 'fa-solid fa-jar' },
                    { id: 17, name: 'فول مدمس (علبة)', description: 'فول مدمس جاهز للأكل.', sku: 'CA002', category: 'معلبات', price: 0.200, stock: 100, lowStockThreshold: 20, isFeatured: false, iconClass: 'fa-solid fa-box-archive' },
                    // حبوب ومعكرونة
                    { id: 18, name: 'أرز بسمتي (5 كيلو)', description: 'كيس أرز بسمتي حبة طويلة.', sku: 'GR001', category: 'حبوب ومعكرونة', price: 3.500, stock: 30, lowStockThreshold: 5, isFeatured: false, iconClass: 'fa-solid fa-bowl-rice' },
                    { id: 19, name: 'معكرونة (500 جم)', description: 'معكرونة إيطالية.', sku: 'GR002', category: 'حبوب ومعكرونة', price: 0.400, stock: 70, lowStockThreshold: 15, isFeatured: false, iconClass: 'fa-solid fa-plate-wheat' },
                    // وجبات خفيفة
                    { id: 20, name: 'بطاطس ليز بالملح', description: 'كيس بطاطس شيبس.', sku: 'SN001', category: 'وجبات خفيفة', price: 0.150, stock: 200, lowStockThreshold: 40, isFeatured: true, iconClass: 'fa-solid fa-cookie' },
                    // حلويات
                    { id: 21, name: 'شوكولاتة كادبوري', description: 'لوح شوكولاتة بالحليب.', sku: 'SW001', category: 'حلويات', price: 0.250, stock: 150, lowStockThreshold: 30, isFeatured: false, iconClass: 'fa-solid fa-candy-cane' },
                    // مجمدات
                    { id: 22, name: 'برجر دجاج (كرتون)', description: 'كرتون برجر دجاج مجمد.', sku: 'FRZ01', category: 'مجمدات', price: 2.500, stock: 40, lowStockThreshold: 10, isFeatured: false, iconClass: 'fa-solid fa-ice-cream' },
                    // بهارات وتوابل
                    { id: 23, name: 'ملح (علبة)', description: 'ملح طعام ناعم.', sku: 'SP001', category: 'بهارات وتوابل', price: 0.150, stock: 100, lowStockThreshold: 20, isFeatured: false, iconClass: 'fa-solid fa-mortar-pestle' },
                    // زيوت وصلصات
                    { id: 24, name: 'زيت دوار الشمس (1.5 لتر)', description: 'زيت طبخ نباتي.', sku: 'OI001', category: 'زيوت وصلصات', price: 1.200, stock: 50, lowStockThreshold: 10, isFeatured: false, iconClass: 'fa-solid fa-bottle-droplet' },
                    { id: 25, name: 'كاتشب هاينز', description: 'صلصة طماطم كاتشب.', sku: 'OI002', category: 'زيوت وصلصات', price: 0.650, stock: 80, lowStockThreshold: 15, isFeatured: false, iconClass: 'fa-solid fa-flask' },
                    // منظفات
                    { id: 26, name: 'صابون سائل لليدين', description: 'صابون سائل معقم لليدين.', sku: 'CL001', category: 'منظفات', price: 0.750, stock: 60, lowStockThreshold: 10, isFeatured: false, iconClass: 'fa-solid fa-soap' },
                    { id: 27, name: 'كلوركس مبيض', description: 'سائل مبيض للملابس والأسطح.', sku: 'CL002', category: 'منظفات', price: 0.500, stock: 70, lowStockThreshold: 15, isFeatured: false, iconClass: 'fa-solid fa-jug-detergent' },
                    // عناية شخصية
                    { id: 28, name: 'معجون أسنان سيجنال', description: 'معجون أسنان للحماية من التسوس.', sku: 'PC001', category: 'عناية شخصية', price: 0.400, stock: 90, lowStockThreshold: 20, isFeatured: false, iconClass: 'fa-solid fa-tooth' },
                    { id: 29, name: 'شامبو هيد آند شولدرز', description: 'شامبو ضد القشرة.', sku: 'PC002', category: 'عناية شخصية', price: 1.500, stock: 50, lowStockThreshold: 10, isFeatured: false, iconClass: 'fa-solid fa-pump-soap' },
                    // مستلزمات أطفال
                    { id: 30, name: 'حفاضات بامبرز (مقاس 4)', description: 'عبوة حفاضات للأطفال.', sku: 'BA001', category: 'مستلزمات أطفال', price: 4.500, stock: 20, lowStockThreshold: 5, isFeatured: false, iconClass: 'fa-solid fa-baby' },
                    // أدوات منزلية
                    { id: 31, name: 'أكياس قمامة (رول)', description: 'رول أكياس قمامة حجم وسط.', sku: 'HH001', category: 'أدوات منزلية', price: 0.300, stock: 100, lowStockThreshold: 20, isFeatured: false, iconClass: 'fa-solid fa-trash' },
                    { id: 32, name: 'مناديل ورقية (علبة)', description: 'علبة مناديل ورقية ناعمة.', sku: 'HH002', category: 'أدوات منزلية', price: 0.150, stock: 200, lowStockThreshold: 40, isFeatured: false, iconClass: 'fa-solid fa-box' },
                ],
                customers: [{id: 1, name: 'خالد المطيري', phone: '96567734409', address: 'المنطقة العاشرة، قطعة 1، شارع 2', points: 150, notes: 'يفضل الدفع كاش', location: { lat: 29.378586, lng: 47.990341 } }], 
                orders: [
                    {id: 1, trackingToken: 'ORDER_1_abcdef', customerId: 1, customerName: "خالد المطيري", customerAddress: "المنطقة العاشرة", customerPhone: "96567734409", timestamp: new Date(Date.now() - 2 * 86400000).toISOString(), status: 'delivered', items: [{productId: 1, name: 'تفاح أحمر (كيلو)', quantity: 2, price: 0.750}], total: 2.000, driverId: 1, rating: { driver: 5, comment: 'توصيل سريع' }, paymentMethod: 'cash', location: { lat: 29.378586, lng: 47.990341 } },
                    {id: 2, trackingToken: 'ORDER_2_ghijk', customerId: 1, customerName: "خالد المطيري", customerAddress: "المنطقة العاشرة", customerPhone: "96567734409", timestamp: new Date().toISOString(), status: 'out_for_delivery', items: [{productId: 2, name: 'خبز لبناني (كيس)', quantity: 4, price: 0.100}], total: 0.900, driverId: 1, paymentMethod: 'online', location: { lat: 29.378586, lng: 47.990341 } },
                ],
                promotions: [{id: 1, name: 'عرض اليوم الوطني', productIds: [1], discount: 0.1}],
                expenses: [{id: 1, date: new Date().toISOString().slice(0,10), description: 'إيجار المحل', amount: 250.000, category: 'مصاريف ثابتة'}],
                users: [{ id: 1, username: 'admin', password: '123', name: 'المدير العام' }],
                drivers: [{ id: 1, name: 'محمد علي', phone: '96511112222', pin: '1234', location: { lat: 29.3758, lng: 47.9832 } }],
                returns: [],
                chats: {},
                settings: { storeName: 'بقالتك', whatsappNumber: '96567734409', pointsPerKWD: 100, shippingFee: 0.500, storeLocation: { lat: 29.3696, lng: 47.9783 } },
                counters: { product: 32, customer: 1, order: 2, user: 1, promotion: 1, expense: 1, driver: 1, return: 0 }
            };
            if (data) { try { db = JSON.parse(data); } catch (e) { db = defaultDB; } } else { db = defaultDB; }
            if (!db.drivers) db.drivers = [];
            if (!db.returns) db.returns = [];
            if (!db.chats) db.chats = {};
            if (!db.counters.driver) db.counters.driver = (db.drivers.length > 0) ? Math.max(...db.drivers.map(d => d.id)) : 0;
            if (!db.counters.return) db.counters.return = 0;
            if (cartData) { try { cart = JSON.parse(cartData); } catch (e) { cart = {}; } } else { cart = {}; }
        }
        function saveDB() { localStorage.setItem(DB_NAME, JSON.stringify(db)); }
        function saveCart() { localStorage.setItem(DB_NAME + '_Cart', JSON.stringify(cart)); }
        function getDB() { return db; }
        
        // ----------------- UTILITY & AUTH FUNCTIONS -----------------
        function login(username, password) { const user = getDB().users.find(u => u.username === username && u.password === password); if (user) { currentUser = { ...user, type: 'admin' }; sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); return true; } return false; }
        function driverLogin(phone, pin) { const driver = getDB().drivers.find(d => d.phone === phone && d.pin === pin); if (driver) { currentUser = { ...driver, type: 'driver' }; sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); return true; } return false; }
        function logout() { Object.values(driverIntervals).forEach(clearInterval); driverIntervals = {}; currentUser = null; sessionStorage.removeItem('currentUser'); window.location.hash = ''; window.location.reload(); }
        function showToast(message, type = 'success') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `p-4 rounded-lg shadow-lg text-white font-bold ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`; t.textContent = message; c.prepend(t); setTimeout(() => t.remove(), 4000); }
        function openModal(title, content, modalClasses = 'max-w-2xl') { const mC = document.getElementById('modal-container'); mC.innerHTML = `<div class="modal fixed inset-0 bg-black bg-opacity-50" style="display:flex; align-items:center; justify-content:center; z-index: 100;"><div class="modal-content ${modalClasses} w-full m-4 p-6 rounded-lg shadow-xl max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-4 border-b pb-2 no-print"><h2 class="text-2xl font-bold">${title}</h2><button class="close-modal-btn text-3xl">×</button></div><div>${content}</div></div></div>`; mC.querySelector('.close-modal-btn').addEventListener('click', () => mC.innerHTML = ''); }
        function closeModal() { document.getElementById('modal-container').innerHTML = ''; }
        function renderPage(pageId, htmlContent, listeners) { const page = document.getElementById(pageId); if (page) { page.innerHTML = htmlContent; if(listeners) listeners(); } }
        function timeAgo(date) { const seconds = Math.floor((new Date() - new Date(date)) / 1000); let interval = seconds / 31536000; if (interval > 1) return `منذ ${Math.floor(interval)} سنة`; interval = seconds / 2592000; if (interval > 1) return `منذ ${Math.floor(interval)} شهر`; interval = seconds / 86400; if (interval > 1) return `منذ ${Math.floor(interval)} يوم`; interval = seconds / 3600; if (interval > 1) return `منذ ${Math.floor(interval)} ساعة`; interval = seconds / 60; if (interval > 1) return `منذ ${Math.floor(interval)} دقيقة`; return `منذ ${Math.floor(seconds)} ثانية`; }
        
        // ----------------- LOGIN / SELECTION VIEWS -----------------
        function renderLoginOverlay(type) {
            const overlay = document.getElementById('password-overlay');
            const title = type === 'admin' ? 'دخول المدير' : 'دخول السائق';
            const formId = type === 'admin' ? 'login-form' : 'driver-login-form';
            const userLabel = type === 'admin' ? 'اسم المستخدم' : 'رقم الهاتف';
            const passLabel = type === 'admin' ? 'كلمة المرور' : 'الرمز السري (PIN)';
            const userInputType = type === 'admin' ? 'text' : 'tel';
            const passInputType = 'password';

            overlay.innerHTML = `
                <div class="bg-slate-800 p-8 rounded-lg shadow-2xl text-center w-full max-w-sm">
                    <img src="${logoUrl}" alt="Logo" class="max-w-[180px] h-auto mx-auto mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-white">${title}</h2>
                    <form id="${formId}" class="space-y-4">
                        <input type="${userInputType}" name="username" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg text-center text-white" placeholder="${userLabel}" required>
                        <input type="${passInputType}" name="password" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg text-center text-white" placeholder="${passLabel}" required>
                        <p class="password-error text-red-400 text-sm pt-1 hidden">بيانات الدخول غير صحيحة.</p>
                        <button type="submit" class="w-full btn-primary py-3 mt-4">دخول</button>
                        <button type="button" class="back-to-selection-btn w-full mt-2 text-gray-400 hover:text-white">العودة</button>
                    </form>
                </div>`;
            
            overlay.querySelector('.back-to-selection-btn').addEventListener('click', () => {
                overlay.style.display = 'none';
                document.getElementById('selection-view').style.display = 'flex';
            });

            overlay.querySelector(`#${formId}`).addEventListener('submit', (e) => {
                e.preventDefault();
                const user = e.target.username.value;
                const pass = e.target.password.value;
                let success = false;

                if (type === 'admin') {
                    if (login(user, pass)) {
                        success = true;
                        window.location.hash = '#dashboard';
                    }
                } else if (type === 'driver') {
                    if (driverLogin(user, pass)) {
                        success = true;
                        window.location.hash = `#driver_portal`;
                    }
                }
                
                if (success) {
                    overlay.style.display = 'none';
                    handleHashChange();
                } else {
                    overlay.querySelector('.password-error').classList.remove('hidden');
                }
            });
            overlay.style.display = 'flex';
        }

        // ----------------- CUSTOMER VIEW FUNCTIONS (NEW MOBILE UI) -----------------
        function renderPublicView() {
            window.removeEventListener('storage', handleStorageEvent);
            const hash = window.location.hash.substring(1);
            if (hash.startsWith('track=')) {
                renderOrderTrackingPage(hash.substring(6));
            } else {
                renderStoreAppShell();
                handleCustomerNav('home'); 
            }
        }
        
        function handleStorageEvent(event) {
            if (event.key === STATUS_EVENT_KEY) {
                const currentToken = window.location.hash.substring(1).substring(6);
                const updateInfo = JSON.parse(event.newValue);
                if (currentToken === updateInfo.token) {
                    showToast('يتم تحديث حالة طلبك...', 'success');
                    renderOrderTrackingPage(updateInfo.token);
                }
            } else if (event.key === CHAT_EVENT_KEY) {
                const chatModal = document.getElementById('chat-modal-content');
                if (chatModal) {
                    const { orderId } = JSON.parse(event.newValue);
                    if (chatModal.dataset.orderId == orderId) {
                        renderChatMessages(orderId, 'customer');
                    }
                }
            }
        }

        function renderStoreAppShell() {
            const customerView = document.getElementById('customer-view');
            customerView.innerHTML = `
                <div id="customer-main-content">
                    <!-- Pages will be injected here -->
                    <div id="customer-page-home" class="customer-page"></div>
                    <div id="customer-page-categories" class="customer-page"></div>
                    <div id="customer-page-track" class="customer-page"></div>
                </div>

                <!-- Floating Cart Button -->
                <button id="cart-fab" class="fixed bottom-20 right-4 bg-orange-500 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-2xl z-40 transition-transform hover:scale-110">
                    <i class="fa-solid fa-shopping-cart"></i>
                    <span id="cart-fab-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white">0</span>
                </button>

                <!-- Bottom Navigation Bar -->
                <nav class="customer-bottom-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg flex justify-around p-2 border-t z-50">
                    <a href="#home" class="customer-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center transition-colors">
                        <i class="fa-solid fa-store text-xl"></i><span class="text-xs mt-1">المتجر</span>
                    </a>
                    <a href="#categories" class="customer-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center transition-colors">
                        <i class="fa-solid fa-grip text-xl"></i><span class="text-xs mt-1">الأقسام</span>
                    </a>
                    <a href="#track" class="customer-nav-link flex flex-col items-center p-2 rounded-lg w-full text-center transition-colors">
                        <i class="fa-solid fa-truck-fast text-xl"></i><span class="text-xs mt-1">تتبع طلبك</span>
                    </a>
                </nav>
            `;

            document.querySelectorAll('.customer-nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const targetPage = e.currentTarget.hash.substring(1);
                    handleCustomerNav(targetPage);
                });
            });

            document.getElementById('cart-fab').addEventListener('click', renderCheckoutModal);
            updateCartButton();
        }

        function handleCustomerNav(pageName) {
            document.querySelectorAll('.customer-page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.customer-nav-link').forEach(l => l.classList.remove('active'));
            
            const activePage = document.getElementById(`customer-page-${pageName}`);
            const activeLink = document.querySelector(`.customer-nav-link[href="#${pageName}"]`);

            if (activePage) activePage.classList.add('active');
            if (activeLink) activeLink.classList.add('active');

            switch(pageName) {
                case 'home':
                    renderStoreHomePage();
                    break;
                case 'categories':
                    renderCategoriesPage();
                    break;
                case 'track':
                    renderTrackOrderInputPage();
                    break;
            }
        }
        
        function renderStoreHomePage() {
            const container = document.getElementById('customer-page-home');
            const featuredProducts = db.products.filter(p => p.isFeatured && p.stock > 0);
            container.innerHTML = `
                 <header class="bg-white sticky top-0 z-30 p-4">
                    <div class="flex items-center justify-between">
                        <img id="logo-public" src="${logoUrl}" alt="Logo" class="h-10">
                        <div class="relative flex-grow mx-4">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3"><i class="fa-solid fa-search text-gray-400"></i></span>
                            <input id="public-product-search" class="w-full p-2 pr-10 border rounded-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="ابحث عن منتج...">
                        </div>
                    </div>
                </header>
                <main class="p-4">
                    ${featuredProducts.length > 0 ? `<div class="mb-8"><h2 class="text-2xl font-bold mb-4">منتجات مميزة</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 featured-products-grid">${featuredProducts.map(p => createProductCard(p)).join('')}</div></div><hr class="my-6 border-gray-300">` : ''}
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">كل المنتجات</h2><select id="public-product-sort" class="p-2 border rounded-lg bg-white"><option value="default">فرز حسب</option><option value="price-asc">السعر: من الأقل للأعلى</option><option value="price-desc">السعر: من الأعلى للأقل</option><option value="name-asc">الاسم: أ - ي</option></select></div>
                    <div id="public-products-list" class="flex flex-col gap-4"></div>
                </main>
            `;
            document.getElementById('public-product-search').addEventListener('input', displayPublicProducts);
            document.getElementById('public-product-sort').addEventListener('change', displayPublicProducts);
            container.addEventListener('click', (event) => {
                const button = event.target.closest('.update-cart-btn');
                if (button) {
                    updateCart(Number(button.dataset.id), Number(button.dataset.change));
                }
            });
            displayPublicProducts();
        }

        function renderCategoriesPage() {
            const container = document.getElementById('customer-page-categories');
            const categories = [...new Set(db.products.map(p => p.category))];
            const categoryIcons = {
                'فواكه': 'fa-apple-whole', 'خضروات': 'fa-carrot', 'مخبوزات': 'fa-bread-slice', 'ألبان وبيض': 'fa-egg', 'لحوم ودواجن': 'fa-drumstick-bite',
                'مشروبات': 'fa-bottle-water', 'معلبات': 'fa-jar', 'حبوب ومعكرونة': 'fa-bowl-rice', 'وجبات خفيفة': 'fa-cookie', 'حلويات': 'fa-candy-cane',
                'مجمدات': 'fa-ice-cream', 'بهارات وتوابل': 'fa-mortar-pestle', 'زيوت وصلصات': 'fa-bottle-droplet', 'منظفات': 'fa-soap', 'عناية شخصية': 'fa-tooth',
                'مستلزمات أطفال': 'fa-baby', 'أدوات منزلية': 'fa-box'
            };
            container.innerHTML = `
                 <header class="bg-white sticky top-0 z-30 p-4 shadow-sm">
                     <h1 class="text-2xl font-bold text-center">الأقسام</h1>
                </header>
                <main class="p-4">
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                        ${categories.map(c => `
                            <a href="#" class="category-grid-item flex flex-col items-center p-4 bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow" data-category="${c}">
                                <i class="fa-solid ${categoryIcons[c] || 'fa-tag'} text-4xl text-orange-500 mb-3"></i>
                                <span class="font-semibold text-center text-sm">${c}</span>
                            </a>
                        `).join('')}
                    </div>
                </main>
            `;

            document.querySelectorAll('.category-grid-item').forEach(item => {
                item.addEventListener('click', e => {
                    e.preventDefault();
                    const category = e.currentTarget.dataset.category;
                    handleCustomerNav('home');
                    // We need a slight delay to ensure the home page is rendered before we filter
                    setTimeout(() => {
                        const searchInput = document.getElementById('public-product-search');
                        if(searchInput) searchInput.value = ''; // Clear previous search
                        displayPublicProducts(category);
                    }, 50);
                });
            });
        }
        
        function renderTrackOrderInputPage() {
            const container = document.getElementById('customer-page-track');
            container.innerHTML = `
                 <header class="bg-white sticky top-0 z-30 p-4 shadow-sm">
                     <h1 class="text-2xl font-bold text-center">تتبع طلبك</h1>
                </header>
                <main class="p-4 pt-10">
                    <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg text-center">
                        <i class="fa-solid fa-magnifying-glass-location text-5xl text-orange-500 mb-4"></i>
                        <h2 class="text-xl font-semibold mb-4">أدخل رابط التتبع الخاص بطلبك</h2>
                        <form id="track-order-form">
                             <input type="text" id="tracking-url-input" class="w-full p-3 border rounded-lg mb-4 text-center" placeholder="https://...#track=ORDER_...">
                             <button type="submit" class="w-full btn-primary bg-orange-500 hover:bg-orange-600">تتبع</button>
                        </form>
                        <p class="text-xs text-gray-400 mt-4">يمكنك إيجاد رابط التتبع في رسالة الواتساب التي وصلتك بعد إتمام الطلب.</p>
                    </div>
                </main>
            `;
            document.getElementById('track-order-form').addEventListener('submit', e => {
                e.preventDefault();
                const url = document.getElementById('tracking-url-input').value;
                try {
                    const token = new URL(url).hash.substring(1).split('=')[1];
                    if (token) {
                        window.location.hash = `track=${token}`;
                    } else {
                         showToast('رابط غير صالح', 'error');
                    }
                } catch(err) {
                     showToast('الرجاء إدخال رابط صالح', 'error');
                }
            });
        }
        
        function renderCheckoutModal() {
            let subtotal = 0;
            const cartItems = Object.entries(cart).map(([id, qty]) => {
                const p = db.products.find(prod => prod.id == id);
                if (!p) return null;
                const finalPrice = getProductPrice(p);
                subtotal += finalPrice * qty;
                return { product: p, quantity: qty, finalPrice: finalPrice };
            }).filter(Boolean);

            const shippingFee = db.settings.shippingFee || 0;
            const total = subtotal + shippingFee;

            const cartItemsHtml = cartItems.length > 0
                ? cartItems.map(item => `<div class="flex items-center gap-4 py-3"><div class="flex-shrink-0 w-16 h-16 bg-gray-100 rounded-md flex items-center justify-center"><i class="${item.product.iconClass || 'fa-solid fa-box'} text-3xl text-gray-400"></i></div><div class="flex-grow"><p class="text-sm font-semibold">${item.product.name}</p><p class="text-xs text-gray-500">${item.quantity} x ${item.finalPrice.toFixed(3)}</p></div><div class="font-bold text-sm">${(item.finalPrice * item.quantity).toFixed(3)}</div></div>`).join('')
                : `<div class="text-center py-10"><i class="fa-solid fa-cart-arrow-down text-4xl text-gray-300"></i><p class="mt-4 text-gray-500">سلتك فارغة!</p></div>`;
            
            const geminiButtonHtml = cartItems.length > 0 ? `<button type="button" id="gemini-recipe-btn" class="w-full btn-primary bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 py-2 mt-4 text-md">✨ اقترح وصفة بالمنتجات!</button>` : '';
            
            const content = `
                <form id="customer-order-form">
                    <div id="cart-items-container-sidebar" class="max-h-60 overflow-y-auto divide-y">${cartItemsHtml}</div>
                    ${geminiButtonHtml}
                    <div class="border-t pt-4 mt-4 space-y-2">
                            <div class="flex justify-between text-gray-600"><span>المجموع الفرعي</span><span>${subtotal.toFixed(3)} د.ك</span></div>
                            <div class="flex justify-between text-gray-600"><span>كلفة التوصيل</span><span>${shippingFee.toFixed(3)} د.ك</span></div>
                            <div class="flex justify-between font-bold text-lg mt-2 border-t pt-2"><span>المجموع</span><span>${total.toFixed(3)} د.ك</span></div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-4 border-b pb-3">تفاصيل التوصيل</h3>
                            <input type="text" name="customerName" class="w-full p-3 border rounded-lg mb-3" placeholder="الاسم الكامل" required>
                            <input type="tel" name="customerPhone" class="w-full p-3 border rounded-lg mb-3" placeholder="رقم الهاتف (لاكتساب النقاط)" required>
                            <input type="text" name="customerAddress" class="w-full p-3 border rounded-lg mb-3" placeholder="العنوان بالتفصيل" required>
                            <button type="button" id="get-location-btn" class="w-full text-center btn-primary bg-gray-600 hover:bg-gray-700 btn-sm mb-2"><i class="fa-solid fa-location-crosshairs mr-2"></i>تحديد الموقع الحالي</button>
                            <p id="location-status" class="text-xs text-center text-gray-500 mb-3">الرجاء تحديد موقعك لتسهيل عملية التوصيل.</p>
                            <input type="hidden" name="customerLat">
                            <input type="hidden" name="customerLng">
                    </div>
                    <div class="mt-6">
                        <h3 class="text-lg font-bold mb-2">طرق الدفع المتاحة</h3>
                        <div class="p-4 border rounded-lg flex justify-between items-center bg-gray-50">
                            <span class="font-semibold">الدفع عند الاستلام أو كي نت</span>
                            <img src="https://www.knet.com.kw/images/knet_logo.png" alt="KNET" class="h-6">
                        </div>
                    </div>
                    <button type="submit" class="w-full btn-primary bg-orange-500 hover:bg-orange-600 py-3 mt-6 text-lg">إتمام الشراء عبر واتساب</button>
                </form>`;

            openModal('سلة المشتريات', content, 'max-w-lg');
            document.getElementById('customer-order-form').addEventListener('submit', handlePublicOrderSubmit);
            document.querySelector('input[name="customerPhone"]').addEventListener('blur', autoFillCustomerData);
            document.getElementById('get-location-btn').addEventListener('click', handleGetLocation);
            const recipeBtn = document.getElementById('gemini-recipe-btn');
            if (recipeBtn) {
                recipeBtn.addEventListener('click', handleRecipeSuggestion);
            }
        }

        function handleGetLocation(e) {
            const button = e.target.closest('button');
            const statusEl = document.getElementById('location-status');
            const latInput = document.querySelector('input[name="customerLat"]');
            const lngInput = document.querySelector('input[name="customerLng"]');

            if (!navigator.geolocation) {
                statusEl.textContent = 'المتصفح لا يدعم تحديد الموقع.';
                statusEl.classList.add('text-red-500');
                return;
            }

            button.disabled = true;
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> جاري التحديد...';
            statusEl.textContent = 'الرجاء السماح بالوصول إلى موقعك.';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    latInput.value = latitude;
                    lngInput.value = longitude;
                    statusEl.textContent = 'تم تحديد الموقع بنجاح!';
                    statusEl.classList.remove('text-red-500');
                    statusEl.classList.add('text-green-600');
                    button.innerHTML = '<i class="fa-solid fa-check mr-2"></i> تم التحديد';
                },
                (error) => {
                    statusEl.textContent = 'فشل تحديد الموقع. الرجاء المحاولة مرة أخرى.';
                    statusEl.classList.add('text-red-500');
                    button.disabled = false;
                    button.innerHTML = '<i class="fa-solid fa-location-crosshairs mr-2"></i>تحديد الموقع الحالي';
                    console.error("Geolocation error:", error);
                }
            );
        }

        async function handleRecipeSuggestion(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            const productNames = Object.keys(cart).map(id => db.products.find(p => p.id == id)?.name).filter(Boolean).join(', ');
            
            if (!productNames) {
                showToast("سلتك فارغة!", 'error');
                return;
            }

            const prompt = `أنا أتسوق من بقالة وهذه المنتجات في سلتي: ${productNames}. اقترح عليّ وصفة طعام بسيطة وسريعة يمكنني تحضيرها باستخدام بعض أو كل هذه المكونات. قدم الوصفة مع قائمة المكونات المطلوبة وطريقة التحضير بتنسيق Markdown.`;
            
            const response = await callGemini(prompt, button);
            const formattedHtml = marked.parse(response);

            openModal("✨ اقتراح وصفة لك", `<div class="prose max-w-none">${formattedHtml}</div>`);
            button.innerHTML = originalText;
        }

        function autoFillCustomerData(e) {
            const phone = e.target.value;
            const customer = db.customers.find(c => c.phone === phone);
            if(customer && customer.address) {
                const form = e.target.form;
                form.customerName.value = customer.name;
                form.customerAddress.value = customer.address;
                showToast(`أهلاً بعودتك ${customer.name}!`, 'success');
            }
        }

        function renderOrderTrackingPage(token) {
            window.addEventListener('storage', handleStorageEvent);
            // Switch to the main customer view container to show the tracking page
            document.getElementById('selection-view').style.display = 'none';
            document.getElementById('driver-portal-view').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
            const customerView = document.getElementById('customer-view');
            customerView.style.display = 'block';

            loadDB();
            const order = db.orders.find(o => o.trackingToken === token);
            
            if (!order) { 
                customerView.innerHTML = `<main class="text-center p-10"><h1 class="text-2xl font-bold">رابط تتبع غير صالح أو منتهي.</h1><a href="#" id="back-to-store" class="text-blue-500 hover:underline mt-4 block">العودة للمتجر</a></main>`; 
                document.getElementById('back-to-store').addEventListener('click', (e) => { e.preventDefault(); window.location.hash = ''; renderPublicView(); }); 
                return; 
            }
            
            const driver = order.driverId ? db.drivers.find(d => d.id === order.driverId) : null;
            const ratingUI = order.status === 'delivered' && !order.rating ? `
                <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">كيف كانت تجربتك؟</h3>
                    <div class="mb-2">
                        <label class="block text-sm font-medium mb-1">تقييم السائق:</label>
                        <div class="rating driver-rating flex flex-row-reverse justify-center text-3xl">
                            ${[5,4,3,2,1].map(s => `<i class="far fa-star" data-value="${s}"></i>`).join('')}
                        </div>
                    </div>
                    <textarea id="rating-comment" class="w-full p-2 border rounded" placeholder="اترك تعليقاً (اختياري)"></textarea>
                    <button id="submit-rating-btn" class="btn-primary w-full mt-2">إرسال التقييم</button>
                </div>` : (order.rating ? `<div class="mt-4 text-center text-gray-500">شكراً لتقييمك!</div>` : '');

            const statuses = ['pending', 'in_progress', 'out_for_delivery', 'delivered'];
            const statusTexts = { pending: 'تم الاستلام', in_progress: 'قيد التجهيز', out_for_delivery: 'في الطريق إليك', delivered: 'تم التوصيل', cancelled: 'ملغي' };
            const statusIcons = { pending: 'fa-receipt', in_progress: 'fa-box-open', out_for_delivery: 'fa-truck-fast', delivered: 'fa-house-circle-check', cancelled: 'fa-ban' };
            const currentStatusIndex = statuses.indexOf(order.status);
            
            let stepsHtml = '';
            statuses.forEach((status, i) => {
                const isCompleted = i < currentStatusIndex;
                const isActive = i === currentStatusIndex;
                stepsHtml += `<div class="step-item flex-1 ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}"><div class="step-icon-wrapper"><i class="fa-solid ${statusIcons[status]}"></i></div><p class="step-label">${statusTexts[status]}</p></div>`;
                if (i < statuses.length - 1) { stepsHtml += `<div class="flex-auto border-t-2 step-connector ${isCompleted ? 'completed' : ''}"></div>`; }
            });

            let deliveryInfoHtml = '';
            if (order.status === 'out_for_delivery' && driver) {
                deliveryInfoHtml = `
                <div class="mt-4 flex items-center justify-center gap-4 bg-green-50 p-3 rounded-lg">
                    <p class="text-gray-600">السائق: <strong class="text-green-800">${driver.name}</strong></p>
                    <button id="open-chat-btn" data-order-id="${order.id}" class="flex items-center gap-2 bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-all"> <i class="fa-solid fa-comments"></i> <span>محادثة مباشرة</span> </button>
                </div>`;
            }

            const orderItemsHtml = order.items.map(item => `<div class="flex justify-between items-center py-2 border-b"><span>${item.name} (x${item.quantity})</span><span class="font-semibold">${(item.price * item.quantity).toFixed(3)} د.ك</span></div>`).join('');
            
            const mapHtml = (order.status === 'out_for_delivery' && driver && order.location) 
                ? `<div class="mt-8"><h3 class="font-bold text-lg mb-4 text-center">تتبع السائق المباشر</h3><div id="customer-tracking-map" class="map-container"></div></div>` 
                : '';

            customerView.innerHTML = `
                <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                        <div class="text-center mb-8"><img src="${logoUrl}" class="h-16 mx-auto mb-4" alt="Logo"><h1 class="text-3xl font-bold">حالة طلبك</h1><p class="text-gray-500 mt-2">رقم الطلب: <span class="font-mono">#${order.id}</span></p></div>
                        <div class="border rounded-lg p-4 mb-8"><h3 class="font-bold text-lg mb-2">ملخص الطلب</h3>${orderItemsHtml}<div class="flex justify-between items-center pt-2 font-bold text-xl"><span>الإجمالي</span><span>${order.total.toFixed(3)} د.ك</span></div></div>
                        <div class="w-full mb-8"><div class="flex items-center">${stepsHtml}</div></div>
                        ${mapHtml}
                        <div class="text-center mt-8 bg-gray-50 p-6 rounded-lg">
                            <div class="text-7xl text-blue-500" id="status-icon"><i class="fa-solid ${statusIcons[order.status]}"></i></div>
                            <p class="font-bold text-xl mt-4" id="status-text">${statusTexts[order.status]}</p>
                            ${deliveryInfoHtml}
                        </div>
                        ${ratingUI}
                    </div>
                </main>`;
            
            if (order.status === 'out_for_delivery' && driver && order.location) {
                setTimeout(() => initCustomerTrackingMap(order), 100);
            }

            const chatBtn = document.getElementById('open-chat-btn');
            if (chatBtn) {
                chatBtn.addEventListener('click', e => openChatModal(Number(e.currentTarget.dataset.orderId), 'customer'));
            }

            if (order.status === 'delivered' && !order.rating) {
                document.querySelectorAll('.rating .fa-star').forEach(star => {
                    star.addEventListener('mouseover', e => {
                        e.currentTarget.classList.add('selected');
                        let previous = e.currentTarget.previousElementSibling;
                        while(previous) { previous.classList.add('selected'); previous = previous.previousElementSibling; }
                    });
                     star.addEventListener('mouseout', e => { if(!e.currentTarget.parentElement.dataset.rating) document.querySelectorAll('.rating .fa-star').forEach(s => s.classList.remove('selected')); });
                    star.addEventListener('click', e => {
                        const value = e.currentTarget.dataset.value;
                        const ratingContainer = e.currentTarget.parentElement;
                        ratingContainer.dataset.rating = value;
                        document.querySelectorAll('.rating .fa-star').forEach(s => s.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        let previous = e.currentTarget.previousElementSibling;
                        while(previous) { previous.classList.add('selected'); previous = previous.previousElementSibling; }
                    });
                });
                
                document.getElementById('submit-rating-btn').addEventListener('click', () => {
                    const driverRating = Number(document.querySelector('.driver-rating').dataset.rating);
                    if (!driverRating) { showToast('الرجاء تقييم السائق', 'error'); return; }
                    
                    order.rating = { driver: driverRating, comment: document.getElementById('rating-comment').value };
                    saveDB();
                    showToast('شكراً لتقييمك!');
                    renderOrderTrackingPage(token);
                });
            }
        }
        
        function displayPublicProducts(categoryFilter = null) {
            const productList = document.getElementById('public-products-list'); if(!productList) return;
            const searchTerm = document.getElementById('public-product-search')?.value.toLowerCase() || '';
            const sortOrder = document.getElementById('public-product-sort')?.value || 'default';
            const activeCategory = categoryFilter || 'all';

            let products = getDB().products.filter(p => p.name.toLowerCase().includes(searchTerm) && (activeCategory === 'all' || p.category === activeCategory) && !p.isFeatured);
            if (sortOrder === 'price-asc') products.sort((a, b) => getProductPrice(a) - getProductPrice(b));
            if (sortOrder === 'price-desc') products.sort((a, b) => getProductPrice(b) - getProductPrice(a));
            if (sortOrder === 'name-asc') products.sort((a, b) => a.name.localeCompare(b.name));
            productList.innerHTML = products.length > 0 ? products.map(p => createProductCard(p)).join('') : `<p class="col-span-full text-center p-8 text-gray-500">لا توجد منتجات تطابق بحثك.</p>`;
        }
        
        function getProductPrice(product) { const promo = (db.promotions || []).find(p => (p.productIds || []).includes(product.id)); return promo ? product.price * (1 - promo.discount) : product.price; }

        function createProductCard(product) {
            const finalPrice = getProductPrice(product); const hasPromo = finalPrice < product.price; const quantityInCart = cart[product.id] || 0; const isOutOfStock = product.stock <= 0;
            let actionButtonHtml = isOutOfStock 
                ? `<div class="text-center text-red-500 font-bold p-2 w-32">نفدت الكمية</div>` 
                : quantityInCart > 0 
                    ? `<div class="flex items-center justify-center gap-2 bg-gray-200 rounded-full p-1"><button class="update-cart-btn bg-white rounded-full h-8 w-8 font-bold text-lg" data-id="${product.id}" data-change="-1">-</button><span class="font-bold text-lg w-8 text-center">${quantityInCart}</span><button class="update-cart-btn bg-white rounded-full h-8 w-8 font-bold text-lg" data-id="${product.id}" data-change="1">+</button></div>` 
                    : `<button class="update-cart-btn btn-primary btn-sm w-32 bg-orange-500 hover:bg-orange-600" data-id="${product.id}" data-change="1">أضف للسلة</button>`;

            return `
                <div class="bg-white rounded-lg shadow p-4 flex items-start gap-4 js-product-card" data-product-id="${product.id}">
                    <div class="flex-shrink-0 w-24 h-24 bg-gray-100 rounded-md flex items-center justify-center relative">
                        <i class="${product.iconClass || 'fa-solid fa-box'} text-4xl text-gray-400"></i>
                         ${hasPromo ? `<div class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-bl-lg rounded-tr-md">خصم</div>` : ''}
                    </div>
                    <div class="flex-grow">
                        <h3 class="font-bold text-md leading-tight">${product.name}</h3>
                        <p class="text-sm text-gray-500 mt-1">${product.description || ''}</p>
                        <p class="font-semibold mt-2">${hasPromo ? `<del class="text-red-400 text-xs">${product.price.toFixed(3)}</del> ` : ''}${finalPrice.toFixed(3)} د.ك</p>
                    </div>
                    <div class="flex-shrink-0 flex flex-col items-center justify-center h-full pt-8">
                        ${actionButtonHtml}
                    </div>
                </div>`;
        }
        
        function updateCartButton() {
            const fabCount = document.getElementById('cart-fab-count');
            if (fabCount) {
                const totalItems = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
                fabCount.textContent = totalItems;
                fabCount.style.display = totalItems > 0 ? 'flex' : 'none';
            }
        }

        function updateCart(productId, change) {
            const product = getDB().products.find(p => p.id == productId); if(!product) return;
            let currentQty = cart[productId] || 0; currentQty += change;
            if (currentQty < 0) currentQty = 0;
            if (currentQty > product.stock) { currentQty = product.stock; showToast(`الكمية المتاحة هي ${product.stock} فقط.`, 'error'); }
            if (currentQty > 0) cart[productId] = currentQty; else delete cart[productId];
            saveCart(); 
            
            updateCartButton();
            
            const card = document.querySelector(`.js-product-card[data-product-id="${productId}"]`); if (!card) return;
            const quantityInCart = cart[productId] || 0;
            const actionArea = card.querySelector('.flex-shrink-0:last-child');
            if (actionArea) {
                const isOutOfStock = product.stock <= 0;
                let newActionHtml = '';
                if (isOutOfStock) { newActionHtml = `<div class="text-center text-red-500 font-bold p-2 w-32">نفدت الكمية</div>`; } 
                else if (quantityInCart > 0) { newActionHtml = `<div class="flex items-center justify-center gap-2 bg-gray-200 rounded-full p-1"><button class="update-cart-btn bg-white rounded-full h-8 w-8 font-bold text-lg" data-id="${product.id}" data-change="-1">-</button><span class="font-bold text-lg w-8 text-center">${quantityInCart}</span><button class="update-cart-btn bg-white rounded-full h-8 w-8 font-bold text-lg" data-id="${product.id}" data-change="1">+</button></div>`; } 
                else { newActionHtml = `<button class="update-cart-btn btn-primary btn-sm w-32 bg-orange-500 hover:bg-orange-600" data-id="${product.id}" data-change="1">أضف للسلة</button>`; }
                actionArea.innerHTML = newActionHtml;
            }
        }
        
        function handlePublicOrderSubmit(e) {
            e.preventDefault();
            if (Object.keys(cart).length === 0) { showToast('سلة المشتريات فارغة!', 'error'); return; }
            const form = e.target;
            const customerName = form.customerName.value, address = form.customerAddress.value, phone = form.customerPhone.value;
            const lat = form.customerLat.value;
            const lng = form.customerLng.value;

            if (!lat || !lng) {
                showToast('الرجاء تحديد موقعك على الخريطة أولاً.', 'error');
                const statusEl = document.getElementById('location-status');
                if (statusEl) {
                    statusEl.classList.add('text-red-500', 'font-bold');
                    statusEl.textContent = 'تحديد الموقع مطلوب لإتمام الطلب!';
                }
                return;
            }

            db.counters.order++; const orderId = db.counters.order;
            let subtotal = 0;
            const orderItems = Object.entries(cart).map(([productId, quantity]) => { const product = db.products.find(p => p.id == productId); product.stock -= quantity; const finalPrice = getProductPrice(product); subtotal += finalPrice * quantity; return { productId: Number(productId), name: product.name, quantity, price: finalPrice }; });
            const total = subtotal + (db.settings.shippingFee || 0);
            let customer = db.customers.find(c => c.phone === phone); if (!customer) { db.counters.customer++; customer = { id: db.counters.customer, name: customerName, phone, address, points: 0, tags: ['New'] }; db.customers.push(customer); } else { customer.address = address; }
            customer.points = (customer.points || 0) + Math.floor(total * (db.settings.pointsPerKWD || 100));
            const trackingToken = `ORDER_${orderId}_${Math.random().toString(36).substr(2, 6)}`;
            
            const location = { lat: parseFloat(lat), lng: parseFloat(lng) };
            const order = { id: orderId, trackingToken, customerId: customer.id, customerName, customerAddress: address, customerPhone: phone, timestamp: new Date().toISOString(), status: 'pending', items: orderItems, total, driverId: null, rating: null, paymentMethod: 'cash', location: location };
            db.orders.push(order); saveDB();
            let message = `*طلب جديد من ${db.settings.storeName}* 🛍️\n\n*رقم الطلب:* ${orderId}\n*العميل:* ${customerName}\n*العنوان:* ${address}\n*الهاتف:* ${phone}\n\n*لمتابعة طلبك:* ${window.location.origin}${window.location.pathname}#track=${trackingToken}\n\n*--- الطلبات ---*\n${orderItems.map(i => `- ${i.name} (x${i.quantity})`).join('\n')}\n\n*المجموع:* ${total.toFixed(3)} د.ك`;
            window.open(`https://api.whatsapp.com/send?phone=${db.settings.whatsappNumber}&text=${encodeURIComponent(message)}`, '_blank');
            cart = {}; saveCart(); closeModal();
            window.location.hash = `track=${trackingToken}`;
        }
        
        // ----------------- DRIVER PORTAL FUNCTIONS -----------------
        function renderDriverPortal(driverId) {
            window.addEventListener('storage', handleDriverStorageEvent);
            const portalView = document.getElementById('driver-portal-view');
            const driver = db.drivers.find(d => d.id === driverId);
            if (!driver) {
                portalView.innerHTML = `<h1>Driver not found</h1>`;
                return;
            }

            const assignedOrders = db.orders.filter(o => o.driverId === driverId && o.status === 'out_for_delivery');
            const today = new Date().toDateString();
            const completedToday = db.orders.filter(o => o.driverId === driverId && o.status === 'delivered' && new Date(o.timestamp).toDateString() === today);
            const cashToCollect = assignedOrders.filter(o => o.paymentMethod === 'cash').reduce((sum, o) => sum + o.total, 0);

            const paymentTag = (method) => {
                if (method === 'online') {
                    return `<span class="text-xs font-bold bg-green-100 text-green-800 px-2 py-1 rounded-full"><i class="fa-solid fa-credit-card mr-1"></i>مدفوع</span>`;
                }
                return `<span class="text-xs font-bold bg-orange-100 text-orange-800 px-2 py-1 rounded-full"><i class="fa-solid fa-money-bill mr-1"></i>نقدي</span>`;
            };

            const ordersHtml = assignedOrders.length > 0 ? assignedOrders.map(o => `
                <div class="bg-white rounded-xl shadow-md overflow-hidden mb-4">
                     <div id="driver-map-${o.id}" class="map-container"></div>
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500">طلب #${o.id}</p>
                                <p class="font-bold text-lg">${o.customerName}</p>
                                <p class="text-sm text-gray-600 flex items-center gap-2 mt-1"><i class="fa-solid fa-location-dot text-gray-400"></i> ${o.customerAddress}</p>
                            </div>
                            <div class="text-left">
                                <p class="font-bold text-xl text-green-600">${o.total.toFixed(3)}</p>
                                ${paymentTag(o.paymentMethod)}
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t flex gap-2">
                             <a href="https://www.google.com/maps/dir/?api=1&destination=${o.location.lat},${o.location.lng}" target="_blank" class="flex-1 text-center btn-primary bg-blue-500 hover:bg-blue-600 btn-sm"><i class="fa-solid fa-map-location-dot mr-2"></i>ابدأ الملاحة</a>
                            <button class="open-chat-btn flex-1 text-center btn-primary bg-sky-500 hover:bg-sky-600 btn-sm" data-order-id="${o.id}"><i class="fa-solid fa-comments mr-2"></i>محادثة</button>
                        </div>
                        <div class="mt-2">
                            <button class="w-full btn-primary bg-green-600 hover:bg-green-700 btn-sm mark-delivered-btn" data-order-id="${o.id}"><i class="fa-solid fa-check-double mr-2"></i>تأكيد التوصيل</button>
                        </div>
                    </div>
                </div>`).join('') : `<div class="text-center text-gray-500 p-8 bg-white rounded-lg shadow"><i class="fa-solid fa-box-open text-4xl text-gray-300"></i><p class="mt-4">لا توجد طلبات معينة لك حالياً.</p></div>`;
            
            portalView.innerHTML = `
                <header class="bg-white shadow-md sticky top-0 z-10">
                    <div class="p-4 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <img src="${logoUrl}" alt="Logo" class="h-10">
                            <div>
                                <p class="text-sm text-gray-500">مرحباً بك</p>
                                <h1 class="font-bold text-2xl">${driver.name}</h1>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <i class="fa-solid fa-bell text-2xl text-gray-500 notification-bell"></i>
                                <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden"></span>
                            </div>
                            <button id="driver-logout-btn" class="text-red-500 text-xl"><i class="fa-solid fa-right-from-bracket"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-px bg-gray-200">
                        <div class="bg-white p-3 text-center">
                            <p class="font-bold text-2xl text-green-600">${completedToday.length}</p>
                            <p class="text-sm text-gray-500">طلبات منجزة اليوم</p>
                        </div>
                        <div class="bg-white p-3 text-center">
                            <p class="font-bold text-2xl text-orange-600">${cashToCollect.toFixed(3)}</p>
                            <p class="text-sm text-gray-500">مبالغ للتحصيل</p>
                        </div>
                    </div>
                </header>
                <main class="p-4">
                    <h2 class="text-xl font-bold mb-4">الطلبات الحالية (${assignedOrders.length})</h2>
                    <div id="driver-orders-list">${ordersHtml}</div>
                </main>`;
            
            // Initialize maps for each order card
            setTimeout(() => {
                assignedOrders.forEach(o => initDriverOrderMap(o));
            }, 100);

            document.getElementById('driver-logout-btn').addEventListener('click', logout);
            
            document.querySelectorAll('.mark-delivered-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderId = Number(e.currentTarget.dataset.orderId);
                    const order = db.orders.find(o => o.id === orderId);
                    if (order) {
                        if(driverIntervals[orderId]) clearInterval(driverIntervals[orderId]);
                        delete driverIntervals[orderId];
                        order.status = 'delivered';
                        saveDB();
                        localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: order.status, timestamp: Date.now() }));
                        showToast(`تم تحديث حالة الطلب #${orderId}`);
                        renderDriverPortal(driverId);
                    }
                });
            });
            document.querySelectorAll('.open-chat-btn').forEach(btn => {
                btn.addEventListener('click', e => openChatModal(Number(e.currentTarget.dataset.orderId), 'driver'));
            });
        }

        function handleDriverStorageEvent(event) {
            if (event.key === DB_NAME) {
                const oldDbData = JSON.stringify(db);
                loadDB();
                const newDbData = JSON.stringify(db);

                if (oldDbData !== newDbData && currentUser && currentUser.type === 'driver') {
                    const oldOrders = JSON.parse(oldDbData).orders.filter(o => o.driverId === currentUser.id && o.status === 'out_for_delivery').length;
                    const newOrders = db.orders.filter(o => o.driverId === currentUser.id && o.status === 'out_for_delivery').length;
                    
                    if (newOrders > oldOrders) {
                        playNotificationSound();
                        const bell = document.querySelector('.notification-bell');
                        const badge = document.getElementById('notification-badge');
                        if(bell) bell.classList.add('active');
                        if(badge) {
                            badge.textContent = newOrders;
                            badge.classList.remove('hidden');
                        }
                        setTimeout(() => bell?.classList.remove('active'), 800);
                    }
                    renderDriverPortal(currentUser.id);
                }
            } else if (event.key === CHAT_EVENT_KEY) {
                const chatModal = document.getElementById('chat-modal-content');
                if (chatModal) {
                    const { orderId } = JSON.parse(event.newValue);
                    if (chatModal.dataset.orderId == orderId) {
                        renderChatMessages(orderId, 'driver');
                    }
                }
            }
        }
        
        function playNotificationSound() {
            try {
                const synth = new Tone.Synth().toDestination();
                Tone.start();
                synth.triggerAttackRelease("C5", "8n");
            } catch (e) {
                console.error("Could not play sound:", e);
            }
        }

        // ----------------- CHAT FUNCTIONS -----------------
        function openChatModal(orderId, userType) {
            const order = db.orders.find(o => o.id === orderId);
            const otherPartyName = userType === 'customer' ? (db.drivers.find(d => d.id === order.driverId)?.name || 'السائق') : order.customerName;
            const content = `
                <div id="chat-modal-content" data-order-id="${orderId}" class="flex flex-col h-[70vh]">
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-4 bg-gray-100 rounded-t-lg space-y-4">
                        <!-- Messages will be rendered here -->
                    </div>
                    <form id="chat-form" class="p-4 border-t flex gap-2">
                        <input id="chat-input" class="flex-grow p-2 border rounded-full" placeholder="اكتب رسالتك..." autocomplete="off">
                        <button type="submit" class="btn-primary rounded-full !p-3 h-12 w-12 flex items-center justify-center"><i class="fa-solid fa-paper-plane"></i></button>
                    </form>
                </div>`;
            openModal(`محادثة بخصوص طلب #${orderId}`, content, 'max-w-lg');
            renderChatMessages(orderId, userType);

            document.getElementById('chat-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (text) {
                    handleSendMessage(orderId, userType, text);
                    input.value = '';
                }
            });
        }
        
        function renderChatMessages(orderId, userType) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            loadDB(); // Ensure we have the latest messages
            const messages = db.chats[orderId] || [];
            messagesContainer.innerHTML = messages.map(msg => {
                const isMine = msg.sender === userType;
                return `
                    <div class="flex ${isMine ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${isMine ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}">
                            <p>${msg.text}</p>
                            <p class="text-xs opacity-75 mt-1 text-right">${new Date(msg.timestamp).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}</p>
                        </div>
                    </div>`;
            }).join('');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function handleSendMessage(orderId, sender, text) {
            if (!db.chats[orderId]) {
                db.chats[orderId] = [];
            }
            db.chats[orderId].push({ sender, text, timestamp: new Date().toISOString() });
            saveDB();
            localStorage.setItem(CHAT_EVENT_KEY, JSON.stringify({ orderId, sender, timestamp: Date.now() }));
            renderChatMessages(orderId, sender);
        }

        // ----------------- MAP FUNCTIONS (NEW) -----------------
        function initAdminMap() {
            const mapContainer = document.getElementById('dashboard-map');
            if (!mapContainer || typeof google === 'undefined') return;

            const map = new google.maps.Map(mapContainer, {
                zoom: 10,
                center: db.settings.storeLocation || { lat: 29.3759, lng: 47.9774 }, // Kuwait center
                mapId: 'BAQALTAK_ADMIN_MAP'
            });

            // Add store location marker
            new google.maps.Marker({
                position: db.settings.storeLocation,
                map,
                title: db.settings.storeName,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: "#3b82f6",
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: "white",
                },
            });

            const activeOrders = db.orders.filter(o => o.status === 'out_for_delivery');
            activeOrders.forEach(order => {
                if (order.location) {
                     new google.maps.Marker({
                        position: order.location,
                        map,
                        title: `طلب #${order.id} - ${order.customerName}`,
                        icon: {
                            url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
                        }
                    });
                }
            });

            const drivers = db.drivers;
            drivers.forEach(driver => {
                if (driver.location) {
                    new google.maps.Marker({
                        position: driver.location,
                        map,
                        title: `السائق: ${driver.name}`,
                         icon: {
                            url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                        }
                    });
                }
            });
        }

        function initDriverOrderMap(order) {
            const mapContainer = document.getElementById(`driver-map-${order.id}`);
            const driver = db.drivers.find(d => d.id === order.driverId);
            if (!mapContainer || typeof google === 'undefined' || !driver || !driver.location || !order.location) return;

            const map = new google.maps.Map(mapContainer, {
                zoom: 12,
                center: driver.location,
                mapId: `DRIVER_MAP_${order.id}`
            });

            const driverMarker = new google.maps.Marker({ position: driver.location, map, title: "موقعك الحالي" });
            const customerMarker = new google.maps.Marker({ position: order.location, map, title: `موقع العميل: ${order.customerName}` });

            const bounds = new google.maps.LatLngBounds();
            bounds.extend(driverMarker.getPosition());
            bounds.extend(customerMarker.getPosition());
            map.fitBounds(bounds);

            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, preserveViewport: true });
            directionsRenderer.setMap(map);

            directionsService.route({
                origin: driver.location,
                destination: order.location,
                travelMode: 'DRIVING'
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                } else {
                    console.warn('Directions request failed due to ' + status);
                }
            });
        }
        
        function initCustomerTrackingMap(order) {
            const mapContainer = document.getElementById('customer-tracking-map');
            const driver = db.drivers.find(d => d.id === order.driverId);
            if (!mapContainer || typeof google === 'undefined' || !driver || !driver.location || !order.location) return;

            // Clear any existing simulation interval for this order
            if (driverIntervals[order.id]) clearInterval(driverIntervals[order.id]);

            const map = new google.maps.Map(mapContainer, {
                zoom: 12,
                center: order.location,
                mapId: `CUSTOMER_TRACKING_MAP_${order.id}`
            });

            const customerMarker = new google.maps.Marker({
                position: order.location,
                map,
                title: "موقعك",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: "#ea580c",
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: "white",
                },
            });

            const driverMarker = new google.maps.Marker({
                position: driver.location,
                map,
                title: `السائق: ${driver.name}`,
                icon: {
                    url: "https://maps.google.com/mapfiles/kml/shapes/motorcycling.png",
                    scaledSize: new google.maps.Size(40, 40),
                }
            });
            
            // Simulation logic
            const startPoint = new google.maps.LatLng(driver.location.lat, driver.location.lng);
            const endPoint = new google.maps.LatLng(order.location.lat, order.location.lng);
            let step = 0;
            const numSteps = 200; // More steps for smoother animation
            const timePerStep = 1000; // 1 second per step

            driverIntervals[order.id] = setInterval(() => {
                step++;
                if (step > numSteps) {
                    clearInterval(driverIntervals[order.id]);
                    delete driverIntervals[order.id];
                    return;
                }
                const newPos = google.maps.geometry.spherical.interpolate(startPoint, endPoint, step / numSteps);
                driverMarker.setPosition(newPos);
                 // Update driver's location in DB for persistence (optional)
                driver.location = { lat: newPos.lat(), lng: newPos.lng() };
                // Don't saveDB here to avoid performance issues, maybe save less frequently
            }, timePerStep);
        }

        // ----------------- ADMIN FUNCTIONS -----------------
        function handleHashChange() {
            // Clear all map intervals and instances when view changes
            Object.values(driverIntervals).forEach(clearInterval);
            driverIntervals = {};
            mapInstances = {};

            if (!currentUser) { renderPublicView(); return; }
            
            const hash = window.location.hash.substring(1) || (currentUser.type === 'admin' ? 'dashboard' : 'driver_portal');
            
            if (currentUser.type === 'admin') {
                document.getElementById('selection-view').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('driver-portal-view').style.display = 'none';
                document.getElementById('current-user-name').textContent = currentUser.name;

                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-link, .bottom-nav-link').forEach(l => l.classList.remove('active'));
                
                const pageEl = document.getElementById(`page-${hash}`);
                const linkEl = document.querySelector(`.sidebar a[href="#${hash}"]`);
                if (pageEl) pageEl.classList.add('active');
                if (linkEl) { 
                    const title = linkEl.textContent.trim();
                    document.getElementById('page-title').textContent = title;
                    document.getElementById('page-title-mobile').textContent = title;
                    document.querySelectorAll(`a[href="#${hash}"]`).forEach(l => l.classList.add('active'));
                }
                const renderMap = { dashboard: renderDashboard, inventory: renderInventory, promotions: renderPromotions, orders: renderOrders, customers: renderCustomers, finance: renderFinance, analytics: renderAnalytics, settings: renderSettings, drivers: renderDrivers, returns: renderReturns };
                if (renderMap[hash]) renderMap[hash]();

            } else if (currentUser.type === 'driver') {
                document.getElementById('selection-view').style.display = 'none';
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('driver-portal-view').style.display = 'block';
                renderDriverPortal(currentUser.id);
            }
        }
        
        function renderDashboard() {
            const pendingOrders = db.orders.filter(o => o.status === 'pending').sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const inProgressOrders = db.orders.filter(o => o.status === 'in_progress').sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const lowStockProducts = db.products.filter(p => p.stock > 0 && p.stock <= (p.lowStockThreshold || 5));

            const createOrderCard = (order) => `<div class="order-card border rounded-lg p-4 shadow-sm mb-4"><div class="flex justify-between items-start mb-2"><div><p class="font-bold text-lg">طلب #${order.id}</p><p class="text-sm text-gray-500">${order.customerName}</p></div><p class="text-xs text-gray-400">${timeAgo(order.timestamp)}</p></div><p class="text-sm my-2">المنتجات: ${order.items.length} أصناف</p><p class="font-bold text-lg text-green-600 mb-4">${order.total.toFixed(3)} د.ك</p><div class="flex gap-2"><button class="view-order-btn text-sm bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg flex-1" data-id="${order.id}">عرض التفاصيل</button>${order.status === 'pending' ? `<button class="start-processing-btn text-sm bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex-1" data-id="${order.id}">بدء التجهيز</button>` : ''}${order.status === 'in_progress' ? `<button class="assign-driver-btn text-sm bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg flex-1" data-id="${order.id}">تعيين سائق</button>` : ''}</div></div>`;
            const lowStockHtml = lowStockProducts.length > 0 ? lowStockProducts.map(p => `<div class="flex justify-between items-center p-2 border-b"><span class="font-semibold">${p.name}</span><span class="font-bold text-red-500">${p.stock}</span></div>`).join('') : '<p class="text-center text-gray-400 p-4">المخزون بحالة جيدة.</p>';
                
            const content = `
                <div class="mb-4 border-b">
                    <nav class="flex -mb-px" id="dashboard-tabs">
                        <a href="#orders-view" class="tab-link active-tab whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg">لوحة الطلبات</a>
                        <a href="#map-view" class="tab-link whitespace-nowrap py-4 px-6 border-b-2 font-medium text-lg">الخريطة الحية</a>
                    </nav>
                </div>
                <div id="dashboard-content">
                    <div id="orders-view" class="tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="order-column border rounded-lg p-4"><h3 class="font-bold text-xl mb-4 flex items-center justify-between">طلبات جديدة <span class="bg-yellow-200 text-yellow-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded-full">${pendingOrders.length}</span></h3><div class="space-y-3 max-h-[60vh] overflow-y-auto">${pendingOrders.map(createOrderCard).join('') || '<p class="text-center text-gray-400 p-4">لا توجد طلبات جديدة</p>'}</div></div>
                                <div class="order-column border rounded-lg p-4"><h3 class="font-bold text-xl mb-4 flex items-center justify-between">قيد التجهيز <span class="bg-blue-200 text-blue-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded-full">${inProgressOrders.length}</span></h3><div class="space-y-3 max-h-[60vh] overflow-y-auto">${inProgressOrders.map(createOrderCard).join('') || '<p class="text-center text-gray-400 p-4">لا توجد طلبات قيد التجهيز</p>'}</div></div>
                            </div>
                            <div class="lg:col-span-1 order-column border rounded-lg p-4"><h3 class="font-bold text-xl mb-4 flex items-center justify-between"><i class="fa-solid fa-triangle-exclamation text-yellow-500 mr-2"></i>تنبيهات المخزون</h3><div class="space-y-2 max-h-[60vh] overflow-y-auto">${lowStockHtml}</div></div>
                        </div>
                    </div>
                    <div id="map-view" class="tab-content hidden">
                        <div id="dashboard-map" class="dashboard-map-container rounded-lg shadow-md"></div>
                    </div>
                </div>
                <style>
                    .tab-link { color: #6b7280; border-color: transparent; }
                    .tab-link.active-tab { color: #3b82f6; border-color: #3b82f6; }
                    body.dark-mode .tab-link { color: #9ca3af; }
                    body.dark-mode .tab-link.active-tab { color: #60a5fa; border-color: #60a5fa; }
                </style>
            `;
            renderPage('page-dashboard', content, () => {
                document.querySelectorAll('.view-order-btn').forEach(btn => btn.addEventListener('click', e => handleViewOrder(Number(btn.dataset.id))));
                document.querySelectorAll('.start-processing-btn').forEach(btn => btn.addEventListener('click', e => { const order = db.orders.find(o => o.id === Number(btn.dataset.id)); if(order) { order.status = 'in_progress'; saveDB(); localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: order.status, timestamp: Date.now() })); renderDashboard(); } }));
                document.querySelectorAll('.assign-driver-btn').forEach(btn => btn.addEventListener('click', e => openDeliveryModal(Number(btn.dataset.id))));
                
                // Tab logic
                document.querySelectorAll('#dashboard-tabs .tab-link').forEach(tab => {
                    tab.addEventListener('click', e => {
                        e.preventDefault();
                        document.querySelectorAll('#dashboard-tabs .tab-link').forEach(t => t.classList.remove('active-tab'));
                        e.target.classList.add('active-tab');

                        document.querySelectorAll('#dashboard-content .tab-content').forEach(c => c.classList.add('hidden'));
                        const targetViewId = e.target.getAttribute('href').substring(1);
                        document.getElementById(targetViewId).classList.remove('hidden');

                        if (targetViewId === 'map-view') {
                            setTimeout(initAdminMap, 50); // Delay to ensure container is visible
                        }
                    });
                });
            });
        }

        function openDeliveryModal(orderId) {
            const order = db.orders.find(o => o.id === orderId);
            const driverOptions = db.drivers.map(d => `<option value="${d.id}" ${order.driverId === d.id ? 'selected' : ''}>${d.name}</option>`).join('');
            const content = `<form id="delivery-form" class="space-y-4"><p>سيتم تحديث حالة الطلب إلى "جاري التوصيل".</p><label>اختر السائق:</label><select name="driverId" class="p-2 border rounded w-full">${driverOptions}</select><button type="submit" class="btn-primary w-full bg-purple-500">تأكيد وتعيين</button></form>`;
            openModal('تعيين سائق للتوصيل', content);
            document.getElementById('delivery-form').addEventListener('submit', e => {
                e.preventDefault();
                const driverId = Number(e.target.driverId.value);
                const driver = db.drivers.find(d => d.id === driverId);
                if (!driver) { showToast('الرجاء اختيار سائق', 'error'); return; }
                order.status = 'out_for_delivery';
                order.driverId = driverId;
                // Simulate driver starting from store location if not already set
                if (!driver.location) driver.location = db.settings.storeLocation;
                saveDB();
                localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: order.status, timestamp: Date.now() }));
                renderDashboard();
                closeModal();
                showToast('تم تعيين السائق وتحديث حالة الطلب.');
            });
        }

        function renderInventory() { const content = `<div class="flex flex-col md:flex-row justify-between items-center mb-6"><h2 class="text-2xl font-bold">المخزون</h2><button id="add-product-btn" class="btn-primary mt-4 md:mt-0">إضافة منتج جديد</button></div><div id="inventory-list" class="bg-white rounded-lg shadow overflow-hidden"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-right">المنتج</th><th class="p-3 text-center">السعر</th><th class="p-3 text-center">الكمية</th><th class="p-3"></th></tr></thead><tbody class="divide-y"></tbody></table></div>`; renderPage('page-inventory', content, () => { document.getElementById('add-product-btn').addEventListener('click', () => handleAddEditProduct()); displayInventory(); }); }
        function displayInventory() { const list = document.querySelector('#inventory-list tbody'); if(!list) return; list.innerHTML = db.products.map(p => `<tr class="hover:bg-gray-50"> <td class="p-3 font-semibold">${p.name}</td> <td class="p-3 text-center">${p.price.toFixed(3)}</td> <td class="p-3 text-center">${p.stock}</td> <td class="p-3 text-left whitespace-nowrap"><button class="edit-product-btn text-blue-500 hover:text-blue-700" data-id="${p.id}"><i class="fa-solid fa-pen-to-square"></i></button><button class="delete-product-btn text-red-500 hover:text-red-700 mr-3" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button></td> </tr>`).join('') || '<tr><td colspan="4" class="text-center p-4">لا توجد منتجات.</td></tr>'; document.querySelectorAll('.edit-product-btn').forEach(b => b.addEventListener('click', e => handleAddEditProduct(Number(e.currentTarget.closest('td').querySelector('.edit-product-btn').dataset.id)))); document.querySelectorAll('.delete-product-btn').forEach(b => b.addEventListener('click', e => { if(confirm('هل أنت متأكد من الحذف؟')) { db.products = db.products.filter(p => p.id !== Number(e.currentTarget.closest('td').querySelector('.delete-product-btn').dataset.id)); saveDB(); displayInventory(); showToast('تم حذف المنتج.'); }})); }
        function handleAddEditProduct(id = null) { 
            const isEdit = id !== null; 
            const p = isEdit ? db.products.find(prod => prod.id === id) : {}; 
            const form = `<form id="product-form" class="space-y-4"><div class="relative"><input name="name" value="${p.name||''}" placeholder="اسم المنتج" required class="p-2 border rounded w-full"><button type="button" id="gemini-desc-btn" class="absolute top-1/2 left-2 -translate-y-1/2 btn-primary btn-sm bg-gradient-to-r from-purple-500 to-pink-500 text-xs">✨ اقتراح وصف</button></div><textarea name="description" placeholder="وصف المنتج..." class="p-2 border rounded w-full h-24">${p.description||''}</textarea><input name="category" value="${p.category||''}" placeholder="القسم" required class="p-2 border rounded w-full"><div class="grid md:grid-cols-2 gap-4"><input name="price" value="${p.price||''}" placeholder="السعر" type="number" step="0.001" required class="p-2 border rounded w-full"><input name="stock" value="${p.stock||''}" placeholder="الكمية" type="number" required class="p-2 border rounded w-full"></div><div class="grid md:grid-cols-2 gap-4"><input name="lowStockThreshold" value="${p.lowStockThreshold||'5'}" placeholder="حد التنبيه للمخزون" type="number" required class="p-2 border rounded w-full"><input name="iconClass" value="${p.iconClass||'fa-solid fa-box'}" placeholder="أيقونة المنتج (مثال: fa-solid fa-box)" class="p-2 border rounded w-full"></div><label class="flex items-center gap-2"><input type="checkbox" name="isFeatured" ${p.isFeatured ? 'checked' : ''}><span>عرض كمنتج مميز؟</span></label><button type="submit" class="btn-primary w-full">${isEdit ? 'حفظ التعديلات' : 'إضافة المنتج'}</button></form>`; 
            openModal(isEdit ? 'تعديل منتج' : 'إضافة منتج جديد', form); 
            document.getElementById('gemini-desc-btn').addEventListener('click', async (e) => {
                const button = e.target; const originalText = button.innerHTML; const nameInput = document.querySelector('input[name="name"]'); const descTextarea = document.querySelector('textarea[name="description"]'); const productName = nameInput.value;
                if (!productName) { showToast("الرجاء إدخال اسم المنتج أولاً.", "error"); return; }
                const prompt = `اكتب وصفاً تسويقياً قصيراً وجذاباً (جملتين كحد أقصى) لمنتج بقالة اسمه '${productName}'. اجعل الوصف مناسباً للعرض في متجر إلكتروني.`;
                const response = await callGemini(prompt, button); descTextarea.value = response; button.innerHTML = originalText;
            });
            document.getElementById('product-form').addEventListener('submit', e => { e.preventDefault(); const data = new FormData(e.target); const productData = { name: data.get('name'), description: data.get('description'), category: data.get('category'), iconClass: data.get('iconClass'), price: Number(data.get('price')), stock: Number(data.get('stock')), lowStockThreshold: Number(data.get('lowStockThreshold')), isFeatured: data.get('isFeatured') === 'on' }; if (isEdit) { Object.assign(db.products.find(prod => prod.id === id), productData); } else { db.counters.product++; db.products.push({id: db.counters.product, ...productData}); } saveDB(); displayInventory(); closeModal(); showToast('تم حفظ المنتج بنجاح.'); }); 
        }

        function renderPromotions() { const content = `<div class="flex flex-col md:flex-row justify-between items-center mb-6"><h2 class="text-2xl font-bold">إدارة العروض</h2><button id="add-promo-btn" class="btn-primary mt-4 md:mt-0">إضافة عرض جديد</button></div><div id="promotions-list" class="space-y-4"></div>`; renderPage('page-promotions', content, () => { document.getElementById('add-promo-btn').addEventListener('click', () => handleAddEditPromotion()); displayPromotions(); }); }
        function displayPromotions() { const list = document.getElementById('promotions-list'); list.innerHTML = (db.promotions||[]).map(p => `<div class="bg-white p-4 rounded-lg shadow flex items-center justify-between"><div><h3 class="font-bold">${p.name}</h3><p class="text-sm text-gray-500">خصم: ${p.discount*100}% على ${p.productIds ? p.productIds.length : 'كل'} منتج(ات)</p></div><div><button class="edit-promo-btn text-blue-500" data-id="${p.id}"><i class="fa-solid fa-pen-to-square"></i></button><button class="delete-promo-btn text-red-500 mr-2" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button></div></div>`).join('') || '<p>لا توجد عروض حالياً.</p>'; document.querySelectorAll('.edit-promo-btn').forEach(b => b.addEventListener('click', e => handleAddEditPromotion(Number(e.currentTarget.dataset.id)))); document.querySelectorAll('.delete-promo-btn').forEach(b => b.addEventListener('click', e => { if(confirm('هل أنت متأكد من الحذف؟')) { db.promotions = db.promotions.filter(p => p.id !== Number(e.currentTarget.dataset.id)); saveDB(); displayPromotions(); showToast('تم حذف العرض.'); }})); }
        function handleAddEditPromotion(id = null) { const isEdit = id !== null; const p = isEdit ? db.promotions.find(promo => promo.id === id) : {productIds: []}; const productOptions = db.products.map(prod => `<option value="${prod.id}" ${p.productIds.includes(prod.id) ? 'selected' : ''}>${prod.name}</option>`).join(''); const form = `<form id="promo-form" class="space-y-4"><input name="name" value="${p.name||''}" placeholder="اسم العرض" required class="p-2 border rounded w-full"><input name="discount" value="${p.discount||''}" placeholder="نسبة الخصم (مثال: 0.1 لخصم 10%)" type="number" step="0.01" required class="p-2 border rounded w-full"><label class="block">المنتجات المشمولة بالعرض (اتركه فارغاً لكل المنتجات)</label><select name="productIds" multiple class="w-full p-2 border rounded h-40">${productOptions}</select><button type="submit" class="btn-primary w-full">${isEdit ? 'حفظ التعديلات' : 'إضافة العرض'}</button></form>`; openModal(isEdit ? 'تعديل عرض' : 'إضافة عرض جديد', form); document.getElementById('promo-form').addEventListener('submit', e => { e.preventDefault(); const data = new FormData(e.target); const selectedProductIds = Array.from(e.target.productIds.selectedOptions).map(opt => Number(opt.value)); const promoData = { name: data.get('name'), discount: Number(data.get('discount')), productIds: selectedProductIds }; if (isEdit) { Object.assign(db.promotions.find(promo => promo.id === id), promoData); } else { db.counters.promotion++; if(!db.promotions) db.promotions = []; db.promotions.push({id: db.counters.promotion, ...promoData}); } saveDB(); displayPromotions(); closeModal(); showToast('تم حفظ العرض بنجاح.'); }); }
        function renderOrders() { const content = `<div class="bg-white p-4 rounded-lg shadow-lg mb-6"><input id="orders-search" type="text" class="p-2 border rounded-lg w-full" placeholder="ابحث بالاسم أو رقم الطلب..."></div><div class="bg-white rounded-xl shadow-lg overflow-x-auto"><table class="min-w-full text-right"><thead class="bg-gray-50"><tr><th class="p-3">#</th><th>العميل</th><th>الإجمالي</th><th>الحالة</th><th>التاريخ</th><th class="text-left">الإجراءات</th></tr></thead><tbody id="orders-table-body"></tbody></table></div>`; renderPage('page-orders', content, () => { document.getElementById('orders-search').addEventListener('input', displayOrders); displayOrders(); }); }
        function displayOrders() { const body = document.getElementById('orders-table-body'); if (!body) return; const searchTerm = document.getElementById('orders-search').value.toLowerCase(); const orders = getDB().orders.slice().reverse().filter(o => o.customerName.toLowerCase().includes(searchTerm) || o.id.toString().includes(searchTerm)); const statusColors = { pending: 'bg-yellow-100 text-yellow-800', in_progress: 'bg-blue-100 text-blue-800', out_for_delivery: 'bg-purple-100 text-purple-800', delivered: 'bg-green-100 text-green-800', cancelled: 'bg-red-100 text-red-800' }; const statusTexts = { pending: 'جديد', in_progress: 'قيد التجهيز', out_for_delivery: 'جاري التوصيل', delivered: 'تم التسليم', cancelled: 'ملغي' }; body.innerHTML = orders.map(order => `<tr class="border-b"> <td class="p-3">${order.id}</td> <td class="p-3">${order.customerName}</td> <td class="p-3 font-mono">${order.total.toFixed(3)}</td> <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColors[order.status] || ''}">${statusTexts[order.status] || order.status}</span></td> <td class="p-3">${new Date(order.timestamp).toLocaleDateString()}</td> <td class="p-3 text-left"><button class="view-order-btn text-blue-500 font-semibold" data-id="${order.id}">عرض</button></td> </tr>`).join(''); document.querySelectorAll('.view-order-btn').forEach(btn => btn.addEventListener('click', e => handleViewOrder(Number(e.target.dataset.id)))); }
        function handleViewOrder(orderId) { const order = db.orders.find(o => o.id === orderId); const trackingLink = `${window.location.origin}${window.location.pathname}#track=${order.trackingToken}`; const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0); const shipping = order.total - subtotal; const driverOptions = db.drivers.map(d => `<option value="${d.id}" ${order.driverId === d.id ? 'selected' : ''}>${d.name}</option>`).join(''); const chatHistory = (db.chats[orderId] || []).map(msg => `<div class="p-2 rounded-lg ${msg.sender === 'driver' ? 'bg-sky-100' : 'bg-gray-100'} mb-2"><p class="font-bold text-sm">${msg.sender === 'driver' ? 'السائق' : 'العميل'}</p><p>${msg.text}</p><p class="text-xs text-gray-400 text-left">${timeAgo(msg.timestamp)}</p></div>`).join(''); const content = `<div class="print-area"><div class="invoice-box"><table cellpadding="0" cellspacing="0"><tr class="top"><td colspan="3"><table><tr><td><img src="${logoUrl}" style="width:100%; max-width:150px;"></td><td style="text-align:left;"><b>فاتورة #${order.id}</b><br><div id="qr-code-container" class="mt-2"></div></td></tr></table></td></tr><tr class="information"><td colspan="3"><table><tr><td><b>${db.settings.storeName}</b></td><td style="text-align:left;"><b>${order.customerName}</b><br>${order.customerPhone}<br>${order.customerAddress}</td></tr></table></td></tr><tr class="heading"><td>المنتج</td><td style="text-align:center;">الكمية</td><td style="text-align:left;">السعر</td></tr>${order.items.map(item => `<tr class="item"><td>${item.name}</td><td style="text-align:center;">${item.quantity}</td><td style="text-align:left;">${(item.price * item.quantity).toFixed(3)}</td></tr>`).join('')}<tr class="heading"><td colspan="2">الملخص</td><td></td></tr><tr><td colspan="2">المجموع الفرعي</td><td style="text-align:left;">${subtotal.toFixed(3)} د.ك</td></tr><tr><td colspan="2">كلفة التوصيل</td><td style="text-align:left;">${shipping.toFixed(3)} د.ك</td></tr><tr class="total"><td></td><td colspan="2" style="text-align:left; font-weight: bold;">الإجمالي: ${order.total.toFixed(3)} د.ك</td></tr></table></div></div><div class="mt-4 no-print flex justify-between items-center bg-gray-100 p-3 rounded-lg"><p class="text-sm">رابط التتبع: <a href="${trackingLink}" target="_blank" class="text-blue-500 underline">عرض</a></p><button id="copy-tracking-link" class="btn-primary btn-sm">نسخ</button></div><div class="mt-4 no-print"><h4 class="font-bold mb-2">تغيير حالة الطلب</h4><select id="update-status-select" class="p-2 border rounded">${Object.entries({ pending: 'جديد', in_progress: 'قيد التجهيز', out_for_delivery: 'جاري التوصيل', delivered: 'تم التسليم', cancelled: 'ملغي' }).map(([k,v]) => `<option value="${k}" ${order.status === k ? 'selected' : ''}>${v}</option>`).join('')}</select><button id="save-status-btn" class="btn-primary mr-2 btn-sm">حفظ</button></div><div class="mt-4 no-print"><label class="font-bold">تعيين سائق:</label><div class="flex gap-2 mt-2"><select id="assign-driver-select" class="p-2 border rounded flex-1"><option value="">اختر سائق...</option>${driverOptions}</select><button id="assign-driver-btn" class="btn-primary btn-sm">تعيين</button></div></div><div class="mt-4 no-print"><h4 class="font-bold mb-2">سجل المحادثة</h4><div class="border rounded-lg p-2 h-40 overflow-y-auto bg-gray-50">${chatHistory || '<p class="text-gray-400 text-center p-4">لا توجد رسائل.</p>'}</div></div><div class="mt-6 flex items-center gap-4 no-print"><button id="print-receipt-btn" class="btn-primary">طباعة</button></div>`; openModal(`تفاصيل طلب #${order.id}`, content, 'max-w-4xl'); new QRCode(document.getElementById("qr-code-container"), { text: trackingLink, width: 80, height: 80 }); document.getElementById('copy-tracking-link').addEventListener('click', () => { navigator.clipboard.writeText(trackingLink); showToast('تم نسخ الرابط!'); }); document.getElementById('print-receipt-btn').addEventListener('click', () => window.print()); document.getElementById('save-status-btn').addEventListener('click', () => { const newStatus = document.getElementById('update-status-select').value; order.status = newStatus; saveDB(); localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: newStatus, timestamp: Date.now() })); displayOrders(); handleViewOrder(orderId); showToast('تم تحديث الحالة'); }); const assignBtn = document.getElementById('assign-driver-btn'); if(assignBtn) assignBtn.addEventListener('click', () => { const driverId = Number(document.getElementById('assign-driver-select').value); if(driverId) { order.driverId = driverId; if(order.status === 'in_progress' || order.status === 'pending') order.status = 'out_for_delivery'; saveDB(); localStorage.setItem(STATUS_EVENT_KEY, JSON.stringify({ token: order.trackingToken, status: order.status, timestamp: Date.now() })); displayOrders(); handleViewOrder(orderId); showToast('تم تعيين السائق'); } else { showToast('الرجاء اختيار سائق', 'error'); } }); }
        function renderCustomers() { const content = `<div class="flex flex-col md:flex-row justify-between items-center mb-6"><h2 class="text-2xl font-bold">العملاء</h2><div class="mt-4 md:mt-0"><button id="send-bulk-msg-btn" class="btn-primary bg-sky-500 hover:bg-sky-600 mr-2">رسالة جماعية</button><button id="export-customers-btn" class="btn-primary bg-green-600 hover:bg-green-700">تصدير Excel</button></div></div><div class="mb-4"><input id="customers-search" type="text" class="w-full p-3 border rounded-lg" placeholder="ابحث باسم العميل أو رقمه..."></div><div class="bg-white rounded-xl shadow-lg overflow-x-auto"><table class="min-w-full text-right"><thead class="bg-gray-50"><tr><th class="p-3">العميل</th><th>الهاتف</th><th>النقاط</th><th>الإجراءات</th></tr></thead><tbody id="customers-table-body"></tbody></table></div>`; renderPage('page-customers', content, () => { document.getElementById('customers-search').addEventListener('input', displayCustomers); document.getElementById('send-bulk-msg-btn').addEventListener('click', handleBulkMessage); document.getElementById('export-customers-btn').addEventListener('click', exportCustomersToExcel); displayCustomers(); }); }
        function displayCustomers() { const body = document.getElementById('customers-table-body'); if (!body) return; const searchTerm = document.getElementById('customers-search').value.toLowerCase(); const customers = getDB().customers.filter(c => c.name.toLowerCase().includes(searchTerm) || c.phone.includes(searchTerm)); body.innerHTML = customers.map(c => `<tr class="border-b"><td class="p-3">${c.name}</td><td>${c.phone}</td><td>${c.points || 0}</td><td><button class="view-customer-btn text-blue-500" data-id="${c.id}">عرض</button></td></tr>`).join(''); document.querySelectorAll('.view-customer-btn').forEach(btn => btn.addEventListener('click', e => handleViewCustomer(Number(e.target.dataset.id)))); }
        function handleViewCustomer(customerId) { const customer = db.customers.find(c => c.id === customerId); const customerOrders = db.orders.filter(o => o.customerId === customerId).slice().reverse(); const content = `<div class="space-y-4"><p><strong>الاسم:</strong> ${customer.name}</p><p><strong>الهاتف:</strong> ${customer.phone}</p><p><strong>العنوان:</strong> ${customer.address}</p><p><strong>النقاط:</strong> ${customer.points || 0}</p><h4 class="font-bold mt-4 border-t pt-2">سجل الطلبات</h4><div class="max-h-60 overflow-y-auto">${customerOrders.map(o => `<div class="p-2 border-b">#${o.id} - ${o.total.toFixed(3)} د.ك - ${new Date(o.timestamp).toLocaleDateString()}</div>`).join('') || '<p>لا توجد طلبات.</p>'}</div></div>`; openModal(`تفاصيل العميل: ${customer.name}`, content); }
        function exportCustomersToExcel() { const ws = XLSX.utils.json_to_sheet(db.customers); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Customers"); XLSX.writeFile(wb, "customers_export.xlsx"); }
        function handleBulkMessage() { const customerOptions = db.customers.filter(c => c.phone).map(c => `<option value="${c.id}">${c.name} (${c.phone})</option>`).join(''); const formContent = `<form id="bulk-msg-form" class="space-y-4"><div><label class="block mb-2">العملاء (اتركه فارغاً للكل)</label><select name="customerIds" class="w-full p-2 border rounded" multiple>${customerOptions}</select></div><div><label class="block mb-2">نص الرسالة (استخدم {name} لاسم العميل)</label><textarea name="message" class="w-full p-2 border rounded" rows="5" required>مرحباً {name}، ...</textarea></div><button type="submit" class="w-full btn-primary">تجهيز الروابط</button></form><div id="whatsapp-links-container" class="mt-4 hidden"></div>`; openModal('إرسال رسالة واتساب جماعية', formContent); document.getElementById('bulk-msg-form').addEventListener('submit', e => { e.preventDefault(); const form = e.target; const messageTemplate = form.message.value; const selectedIds = Array.from(form.customerIds.selectedOptions).map(opt => Number(opt.value)); const targetCustomers = selectedIds.length > 0 ? db.customers.filter(c => selectedIds.includes(c.id)) : db.customers.filter(c => c.phone); const linksHtml = targetCustomers.map(c => { const personalizedMsg = encodeURIComponent(messageTemplate.replace(/{name}/g, c.name)); const url = `https://api.whatsapp.com/send?phone=${c.phone}&text=${personalizedMsg}`; return `<a href="${url}" target="_blank" class="block bg-gray-100 p-2 rounded hover:bg-blue-100">${c.name}</a>`; }).join(''); const container = document.getElementById('whatsapp-links-container'); container.innerHTML = `<h4 class="font-bold mb-2">روابط جاهزة (${targetCustomers.length})</h4><div class="space-y-2 max-h-60 overflow-y-auto">${linksHtml}</div>`; container.classList.remove('hidden'); }); }
        function renderFinance() { const deliveredOrders = db.orders.filter(o => o.status === 'delivered'); const totalRevenue = deliveredOrders.reduce((sum, o) => sum + o.total, 0); const totalExpenses = (db.expenses || []).reduce((sum, e) => sum + e.amount, 0); const netProfit = totalRevenue - totalExpenses; const content = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="p-5 rounded-lg shadow-lg text-center bg-white"><p class="text-3xl font-bold text-green-500">${totalRevenue.toFixed(3)}</p><p class="mt-2 text-gray-600">إجمالي الإيرادات</p></div><div class="p-5 rounded-lg shadow-lg text-center bg-white"><p class="text-3xl font-bold text-red-500">${totalExpenses.toFixed(3)}</p><p class="mt-2 text-gray-600">إجمالي المصروفات</p></div><div class="p-5 rounded-lg shadow-lg text-center bg-white"><p class="text-3xl font-bold ${netProfit >= 0 ? 'text-blue-500' : 'text-orange-500'}">${netProfit.toFixed(3)}</p><p class="mt-2 text-gray-600">صافي الربح</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-5 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl">المصروفات</h3><button id="add-expense-btn" class="btn-primary btn-sm">إضافة مصروف</button></div><div class="overflow-x-auto max-h-96"><table class="w-full text-right"><tbody>${(db.expenses || []).length > 0 ? db.expenses.slice().reverse().map(e => `<tr class="border-b"><td class="p-2">${e.date}</td><td class="p-2">${e.description}</td><td class="p-2 font-mono">${e.amount.toFixed(3)}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center p-4">لا توجد مصروفات.</td></tr>`}</tbody></table></div></div><div class="bg-white p-5 rounded-lg shadow-lg"><h3 class="font-bold text-xl mb-4">الإيرادات</h3><div class="overflow-x-auto max-h-96"><table class="w-full text-right"><tbody>${deliveredOrders.length > 0 ? deliveredOrders.slice().reverse().map(o => `<tr class="border-b"><td class="p-2">#${o.id}</td><td class="p-2">${new Date(o.timestamp).toLocaleDateString()}</td><td class="p-2 font-mono">${o.total.toFixed(3)}</td></tr>`).join('') : `<tr><td colspan="3" class="text-center p-4">لا توجد إيرادات.</td></tr>`}</tbody></table></div></div></div>`; renderPage('page-finance', content, () => { document.getElementById('add-expense-btn').addEventListener('click', handleAddExpense); }); }
        function handleAddExpense() { const today = new Date().toISOString().slice(0, 10); const formContent = `<form id="expense-form" class="space-y-4"><input name="description" class="p-2 border rounded w-full" placeholder="بيان المصروف" required><div class="grid md:grid-cols-2 gap-4"><input name="amount" type="number" step="0.001" class="p-2 border rounded w-full" placeholder="المبلغ" required><input name="date" type="date" class="p-2 border rounded w-full" value="${today}" required></div><button type="submit" class="w-full btn-primary py-2 mt-2">إضافة</button></form>`; openModal('إضافة مصروف جديد', formContent); document.getElementById('expense-form').addEventListener('submit', (e) => { e.preventDefault(); const form = e.target; db.counters.expense++; const newExpense = { id: db.counters.expense, description: form.description.value, amount: Number(form.amount.value), date: form.date.value }; if(!db.expenses) db.expenses = []; db.expenses.push(newExpense); saveDB(); renderFinance(); closeModal(); showToast('تم إضافة المصروف'); }); }
        function renderAnalytics() { const content = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-4 rounded-lg shadow-lg"><h3 class="font-bold text-lg mb-4">مبيعات آخر 7 أيام</h3><canvas id="salesChart"></canvas></div><div class="bg-white p-4 rounded-lg shadow-lg"><h3 class="font-bold text-lg mb-4">المنتجات الأكثر مبيعًا</h3><div id="topProductsList"></div></div></div>`; renderPage('page-analytics', content, () => { const salesCtx = document.getElementById('salesChart')?.getContext('2d'); if(salesCtx) { const salesData = { labels: [], datasets: [{ label: 'المبيعات (د.ك)', data: [], backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: '#3b82f6', borderWidth: 1 }] }; for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); salesData.labels.push(d.toLocaleDateString('ar-EG', { weekday: 'short' })); const dailySales = db.orders.filter(o => new Date(o.timestamp).toDateString() === d.toDateString() && o.status === 'delivered').reduce((sum, o) => sum + o.total, 0); salesData.datasets[0].data.push(dailySales); } new Chart(salesCtx, { type: 'bar', data: salesData, options: { scales: { y: { beginAtZero: true } } } }); } const productSales = {}; db.orders.forEach(o => o.items.forEach(i => productSales[i.name] = (productSales[i.name] || 0) + i.quantity)); const topProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]).slice(0,5); document.getElementById('topProductsList').innerHTML = topProducts.map(([name, qty]) => `<div class="flex justify-between items-center p-2 border-b"><span class="font-semibold">${name}</span><span class="font-bold">${qty}</span></div>`).join(''); }); }
        function renderSettings() { const settings = getDB().settings; const content = `<div class="space-y-8 max-w-3xl mx-auto"><div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-bold mb-4 border-b pb-2">إعدادات المتجر</h3><form id="store-settings-form" class="space-y-4"><label class="block">اسم المتجر</label> <input name="storeName" type="text" value="${settings.storeName}" class="w-full p-3 border rounded-lg"><label class="block">رقم الواتساب</label> <input name="whatsappNumber" type="text" value="${settings.whatsappNumber}" class="w-full p-3 border rounded-lg"><label class="block">رسوم التوصيل (د.ك)</label> <input name="shippingFee" type="number" step="0.001" value="${settings.shippingFee}" class="w-full p-3 border rounded-lg"><label class="block">النقاط لكل دينار</label> <input name="pointsPerKWD" type="number" value="${settings.pointsPerKWD}" class="w-full p-3 border rounded-lg"><button type="submit" class="btn-primary">حفظ الإعدادات</button></form></div><div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-bold mb-4 border-b pb-2">البيانات</h3><div class="flex gap-4"><button id="backup-btn" class="flex-1 btn-primary bg-blue-600">نسخ احتياطي</button><button id="restore-btn" class="flex-1 btn-primary bg-green-600">استعادة نسخة</button><input type="file" id="restore-input" class="hidden" accept=".json"></div></div></div>`; renderPage('page-settings', content, () => { document.getElementById('store-settings-form').addEventListener('submit', (e) => { e.preventDefault(); db.settings.storeName = e.target.storeName.value; db.settings.whatsappNumber = e.target.whatsappNumber.value; db.settings.shippingFee = Number(e.target.shippingFee.value); db.settings.pointsPerKWD = Number(e.target.pointsPerKWD.value); saveDB(); showToast('تم حفظ الإعدادات بنجاح.'); }); document.getElementById('backup-btn').addEventListener('click', () => { const dataStr = JSON.stringify(getDB()); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = 'baqaltak_backup.json'; link.click(); URL.revokeObjectURL(url); }); document.getElementById('restore-btn').addEventListener('click', () => document.getElementById('restore-input').click()); document.getElementById('restore-input').addEventListener('change', (e) => { const file = e.target.files[0]; if(!file || !confirm('سيتم استبدال كل البيانات الحالية.')) return; const reader = new FileReader(); reader.onload = (event) => { try { db = JSON.parse(event.target.result); saveDB(); showToast('تم الاستعادة بنجاح!'); location.reload(); } catch(err) { showToast('ملف غير صالح.', 'error'); }}; reader.readAsText(file); }); }); }
        
        function renderDrivers() {
            const drivers = db.drivers;
            const content = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">إدارة السائقين</h2>
                    <button id="add-driver-btn" class="btn-primary">إضافة سائق</button>
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50"><tr><th class="p-3 text-right">الاسم</th><th class="p-3 text-center">الهاتف</th><th></th></tr></thead>
                        <tbody>${drivers.map(d => `<tr><td class="p-3">${d.name}</td><td class="p-3 text-center">${d.phone}</td><td class="p-3 text-left"><button class="edit-driver-btn text-blue-500" data-id="${d.id}"><i class="fa fa-edit"></i></button></td></tr>`).join('')}</tbody>
                    </table>
                </div>`;
            renderPage('page-drivers', content, () => {
                document.getElementById('add-driver-btn').addEventListener('click', () => handleAddEditDriver());
                document.querySelectorAll('.edit-driver-btn').forEach(b => b.addEventListener('click', e => handleAddEditDriver(Number(e.currentTarget.dataset.id))));
            });
        }
        
        function handleAddEditDriver(id = null) {
            const isEdit = id !== null;
            const d = isEdit ? db.drivers.find(dr => dr.id === id) : {};
            const form = `<form id="driver-form" class="space-y-4">
                <input name="name" value="${d.name||''}" placeholder="اسم السائق" required class="p-2 border rounded w-full">
                <input name="phone" value="${d.phone||''}" placeholder="رقم الهاتف" required type="tel" class="p-2 border rounded w-full">
                <input name="pin" value="${d.pin||''}" placeholder="الرمز السري (PIN)" required class="p-2 border rounded w-full">
                <button type="submit" class="btn-primary w-full">${isEdit ? 'حفظ' : 'إضافة'}</button>
            </form>`;
            openModal(isEdit ? 'تعديل سائق' : 'إضافة سائق', form);
            document.getElementById('driver-form').addEventListener('submit', e => {
                e.preventDefault();
                const data = new FormData(e.target);
                const driverData = { name: data.get('name'), phone: data.get('phone'), pin: data.get('pin'), location: d.location || db.settings.storeLocation }; // Assign store location on creation
                if (isEdit) {
                    Object.assign(db.drivers.find(dr => dr.id === id), driverData);
                } else {
                    db.counters.driver++;
                    db.drivers.push({ id: db.counters.driver, ...driverData });
                }
                saveDB();
                renderDrivers();
                closeModal();
                showToast('تم حفظ بيانات السائق.');
            });
        }

        function renderReturns() {
            const returns = db.returns;
            const content = `
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">المرتجعات</h2>
                    ${returns.length > 0 ? returns.map(r => `<div class="p-2 border-b">طلب #${r.orderId} - ${r.reason}</div>`).join('') : '<p>لا توجد مرتجعات.</p>'}
                </div>`;
            renderPage('page-returns', content);
        }

        // ----------------- INITIALIZATION -----------------
        function init() {
            loadDB();
            
            document.querySelectorAll('#logo-selection, #logo-sidebar').forEach(el => el.src = logoUrl);
            
            const selectionView = document.getElementById('selection-view');
            const customerView = document.getElementById('customer-view');
            const passwordOverlay = document.getElementById('password-overlay');

            const themeToggle = document.getElementById('theme-toggle-admin');
            const setTheme = (theme) => { 
                localStorage.setItem('theme', theme); 
                document.body.className = theme + '-mode'; 
                if(themeToggle) {
                    themeToggle.checked = theme === 'dark';
                    const dot = themeToggle.nextElementSibling.nextElementSibling;
                    if (dot) {
                        if (theme === 'dark') { dot.style.transform = 'translateX(100%)'; } else { dot.style.transform = 'translateX(0)'; }
                    }
                }
            };

            if(themeToggle) {
                themeToggle.addEventListener('change', () => setTheme(themeToggle.checked ? 'dark' : 'light'));
            }
            setTheme(localStorage.getItem('theme') || 'light');
            
            document.getElementById('customer-btn').addEventListener('click', () => { selectionView.style.display = 'none'; customerView.style.display = 'block'; renderPublicView(); });
            document.getElementById('admin-btn').addEventListener('click', () => { selectionView.style.display = 'none'; renderLoginOverlay('admin'); });
            document.getElementById('driver-btn').addEventListener('click', () => { selectionView.style.display = 'none'; renderLoginOverlay('driver'); });
            
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            const sidebar = document.getElementById('sidebar'); 
            const sidebarOverlay = document.getElementById('sidebar-overlay'); 
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const toggleSidebar = () => { sidebar.classList.toggle('translate-x-full'); sidebarOverlay.classList.toggle('hidden'); };
            if(hamburgerBtn) hamburgerBtn.addEventListener('click', toggleSidebar);
            if(sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);

            window.addEventListener('hashchange', handleHashChange);
            
            const sessionUser = sessionStorage.getItem('currentUser');
            if (sessionUser) {
                try {
                    currentUser = JSON.parse(sessionUser);
                    handleHashChange();
                } catch(e) {
                    selectionView.style.display = 'flex';
                }
            } else {
                const initialHash = window.location.hash.substring(1);
                if (initialHash.startsWith('track=')) {
                    selectionView.style.display = 'none';
                    customerView.style.display = 'block';
                    renderOrderTrackingPage(initialHash.substring(6));
                } else {
                    selectionView.style.display = 'flex';
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
